<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Drive - Play & Earn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            overflow: hidden;
            background-color: #0f172a;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        .hidden { display: none !important; }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .neon-text { text-shadow: 0 0 10px rgba(56, 189, 248, 0.8); }
        .neon-border { box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); border: 1px solid #38bdf8; }
        
        /* Floating animations for popups */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }
        .float-anim { animation: floatUp 1s ease-out forwards; }

        /* Screen Shake */
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            20% { transform: translate(-5px, 3px); }
            40% { transform: translate(5px, -3px); }
            60% { transform: translate(-5px, -3px); }
            80% { transform: translate(5px, 3px); }
        }
        .shake-effect { animation: shake 0.3s; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative">

    <div id="toastContainer" class="absolute top-4 left-0 right-0 flex flex-col items-center z-[100] gap-2 pointer-events-none"></div>

    <div id="registrationScreen" class="absolute inset-0 flex items-center justify-center bg-[#020617] z-50 p-4">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-md text-center">
            <h1 class="text-3xl font-black mb-2 text-cyan-400 neon-text">PREMIUM DRIVE</h1>
            <p class="text-slate-300 text-sm mb-6">Register now to get your <b class="text-green-400">0.50 AZN</b> starting bonus!</p>
            
            <form id="regForm" class="flex flex-col gap-4 text-left">
                <div>
                    <label class="text-xs text-slate-400 ml-1">Full Name</label>
                    <input type="text" id="regName" required class="w-full p-3 rounded-xl bg-slate-800 border border-slate-600 outline-none focus:border-cyan-400 text-white">
                </div>
                <div>
                    <label class="text-xs text-slate-400 ml-1">Username</label>
                    <input type="text" id="regUsername" required class="w-full p-3 rounded-xl bg-slate-800 border border-slate-600 outline-none focus:border-cyan-400 text-white">
                </div>
                <div class="flex gap-4">
                    <div class="w-1/2">
                        <label class="text-xs text-slate-400 ml-1">Age</label>
                        <input type="number" min="10" max="99" required class="w-full p-3 rounded-xl bg-slate-800 border border-slate-600 outline-none focus:border-cyan-400 text-white">
                    </div>
                    <div class="w-1/2">
                        <label class="text-xs text-slate-400 ml-1">Password</label>
                        <input type="password" minlength="6" required class="w-full p-3 rounded-xl bg-slate-800 border border-slate-600 outline-none focus:border-cyan-400 text-white">
                    </div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700 text-xs text-slate-300 mt-2">
                    <ul class="list-disc pl-4 space-y-1">
                        <li>Each user can register only <b>once</b>.</li>
                        <li>Multiple accounts from the same device will be banned.</li>
                        <li>Follow traffic rules to earn AZN!</li>
                    </ul>
                </div>
                <button type="submit" class="w-full py-4 mt-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-bold uppercase tracking-wider transition-colors neon-border">
                    Claim Bonus & Play
                </button>
            </form>
        </div>
    </div>

    <div id="mainMenu" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-[#020617] z-40 p-4">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-sm text-center">
            <h1 class="text-4xl font-black mb-6 text-cyan-400 neon-text italic">PREMIUM DRIVE</h1>
            
            <div class="bg-slate-800/80 p-4 rounded-2xl mb-6 flex justify-between items-center border border-slate-600">
                <div class="text-left">
                    <p class="text-xs text-slate-400 uppercase tracking-widest">Balance</p>
                    <p class="text-2xl font-bold text-green-400" id="menuBalance">0.00 AZN</p>
                </div>
                <div class="text-right">
                    <p class="text-xs text-slate-400 uppercase tracking-widest">High Score</p>
                    <p class="text-lg font-bold text-cyan-400" id="menuScore">0 M</p>
                </div>
            </div>

            <button id="btnPlay" class="w-full py-4 mb-4 bg-cyan-600 hover:bg-cyan-500 rounded-2xl font-bold text-xl uppercase tracking-wider transition-all neon-border active:scale-95">
                START DRIVE
            </button>
            
            <div class="grid grid-cols-2 gap-4">
                <button id="btnDaily" class="py-3 bg-indigo-600/50 hover:bg-indigo-500/50 border border-indigo-500 rounded-xl font-bold text-sm transition-all active:scale-95">
                    üéÅ Daily Bonus
                </button>
                <button id="btnAch" class="py-3 bg-amber-600/50 hover:bg-amber-500/50 border border-amber-500 rounded-xl font-bold text-sm transition-all active:scale-95">
                    üèÜ Achievements
                </button>
            </div>
        </div>
    </div>

    <div id="achModal" class="hidden absolute inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="glass-panel p-6 rounded-3xl w-full max-w-sm flex flex-col max-h-[80vh]">
            <h2 class="text-2xl font-bold text-amber-400 mb-4 text-center">Achievements</h2>
            <div id="achList" class="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar"></div>
            <button id="closeAch" class="mt-4 py-3 bg-slate-700 rounded-xl font-bold w-full">Close</button>
        </div>
    </div>

    <div id="gameScreen" class="hidden absolute inset-0 flex flex-col bg-[#020617]">
        <div class="p-4 flex justify-between items-start z-30 shrink-0 pointer-events-none">
            <div class="flex gap-2">
                <div class="glass-panel px-4 py-2 rounded-xl">
                    <p class="text-[10px] text-cyan-400 uppercase font-bold tracking-wider">Balance</p>
                    <p id="hudBalance" class="text-lg font-black text-white">0.00 AZN</p>
                </div>
                <div class="glass-panel px-4 py-2 rounded-xl">
                    <p class="text-[10px] text-amber-400 uppercase font-bold tracking-wider">Score / Combo</p>
                    <p class="text-lg font-black text-white"><span id="hudScore">0</span> <span id="hudCombo" class="text-amber-400 text-sm ml-1">x1</span></p>
                </div>
            </div>
        </div>

        <div id="motivationalZone" class="absolute top-24 w-full text-center z-30 pointer-events-none transition-opacity duration-300 opacity-0">
            <h2 id="motivationalText" class="text-2xl font-black text-white italic drop-shadow-[0_5px_5px_rgba(0,0,0,0.8)] scale-150 transition-transform">GREAT DRIVING!</h2>
        </div>

        <div class="flex-1 w-full max-w-[450px] mx-auto relative overflow-hidden z-10 flex shrink" id="canvasContainer">
            <canvas id="gameCanvas" width="450" height="700" class="w-full h-full object-cover bg-[#0f172a] shadow-2xl shadow-cyan-900/20"></canvas>
            
            <div class="absolute inset-0 flex z-20">
                <div id="ctrlLeft" class="flex-1"></div>
                <div id="ctrlRight" class="flex-1"></div>
            </div>
            
            <div id="gameOverScreen" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-md flex flex-col items-center justify-center p-6 text-center z-40">
                <div class="w-16 h-16 rounded-full bg-rose-500/20 flex items-center justify-center mb-4"><span class="text-3xl">üí•</span></div>
                <h2 class="text-3xl font-black text-rose-500 mb-2 tracking-widest">CRASHED!</h2>
                <p id="goMotivational" class="text-cyan-300 italic mb-6">Don't give up, try again!</p>
                
                <div class="bg-slate-800 p-4 rounded-2xl w-full mb-6 flex justify-between">
                    <div class="text-left">
                        <p class="text-xs text-slate-400">Score</p>
                        <p id="goScore" class="font-bold text-xl text-white">0</p>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-slate-400">Balance</p>
                        <p id="goBalance" class="font-bold text-xl text-green-400">0.00 AZN</p>
                    </div>
                </div>

                <div id="goWarning" class="hidden mb-6 bg-rose-500/20 p-3 rounded-xl border border-rose-500/50 w-full">
                    <p class="text-rose-400 text-sm font-bold">Balance is 0.00 AZN!</p>
                    <p class="text-slate-300 text-xs mt-1">You must top up to continue playing.</p>
                </div>

                <button id="btnRestart" class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 text-white rounded-2xl font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(34,211,238,0.3)] active:scale-95 transition-all">TRY AGAIN</button>
                <button id="btnGoMenu" class="w-full py-3 mt-3 bg-transparent border border-slate-600 text-slate-300 rounded-2xl font-bold uppercase active:scale-95 transition-all">MAIN MENU</button>
            </div>
        </div>

        <div class="w-full max-w-[450px] mx-auto p-4 pb-8 shrink-0 z-20">
            <button id="btnBrake" class="w-full py-6 rounded-3xl text-3xl font-black tracking-widest transition-all bg-rose-600 border-b-8 border-rose-800 text-white shadow-[0_0_30px_rgba(225,29,72,0.4)] active:border-b-0 active:translate-y-2 select-none touch-manipulation">
                BRAKE
            </button>
        </div>
    </div>

    <script>
        // --- Polyfill for roundRect ---
        if (!CanvasRenderingContext2D.prototype.roundRect) {
            CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
                if (w < 2 * r) r = w / 2; if (h < 2 * r) r = h / 2;
                this.beginPath(); this.moveTo(x + r, y);
                this.arcTo(x + w, y, x + w, y + h, r); this.arcTo(x + w, y + h, x, y + h, r);
                this.arcTo(x, y + h, x, y, r); this.arcTo(x, y, x + r, y, r);
                this.closePath(); return this;
            }
        }

        // --- Core Variables & State ---
        let userRegistered = localStorage.getItem('pd_registered') === 'true';
        let balance = parseFloat(localStorage.getItem('pd_balance')) || 0.00;
        let highScore = parseInt(localStorage.getItem('pd_highscore')) || 0;
        let achievements = JSON.parse(localStorage.getItem('pd_achievements')) || [];
        let lastDaily = localStorage.getItem('pd_daily') || "";

        const ACH_DATA = [
            { id: 'first_drive', title: 'First Drive', desc: 'Play your first game.', reward: 0.10 },
            { id: 'score_1000', title: 'Pro Driver', desc: 'Reach 1000 score.', reward: 0.20 },
            { id: 'combo_10', title: 'Combo Master', desc: 'Reach a 10x Combo.', reward: 0.30 },
            { id: 'police_good', title: 'Law Abiding', desc: 'Obey the police command.', reward: 0.15 }
        ];

        // --- DOM Elements ---
        const ui = {
            regScreen: document.getElementById('registrationScreen'),
            mainMenu: document.getElementById('mainMenu'),
            gameScreen: document.getElementById('gameScreen'),
            gameOverScreen: document.getElementById('gameOverScreen'),
            achModal: document.getElementById('achModal'),
            
            menuBalance: document.getElementById('menuBalance'),
            menuScore: document.getElementById('menuScore'),
            hudBalance: document.getElementById('hudBalance'),
            hudScore: document.getElementById('hudScore'),
            hudCombo: document.getElementById('hudCombo'),
            goScore: document.getElementById('goScore'),
            goBalance: document.getElementById('goBalance'),
            
            motivationalZone: document.getElementById('motivationalZone'),
            motivationalText: document.getElementById('motivationalText'),
            goMotivational: document.getElementById('goMotivational'),
            toastContainer: document.getElementById('toastContainer')
        };

        // --- UI Updates ---
        function updateUI() {
            localStorage.setItem('pd_balance', balance.toFixed(2));
            localStorage.setItem('pd_highscore', highScore.toString());
            localStorage.setItem('pd_achievements', JSON.stringify(achievements));
            
            const balTxt = balance.toFixed(2) + ' AZN';
            ui.menuBalance.innerText = balTxt;
            ui.hudBalance.innerText = balTxt;
            ui.goBalance.innerText = balTxt;
            ui.menuScore.innerText = highScore + ' M';
            
            // Check bankruptcy
            if (balance <= 0 && isGameOver) {
                document.getElementById('goWarning').classList.remove('hidden');
                document.getElementById('btnRestart').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                document.getElementById('goWarning').classList.add('hidden');
                document.getElementById('btnRestart').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function showToast(title, amountStr, isPositive = true) {
            const toast = document.createElement('div');
            const color = isPositive ? 'bg-emerald-500/20 border-emerald-500 text-emerald-400' : 'bg-rose-500/20 border-rose-500 text-rose-400';
            toast.className = `px-4 py-2 rounded-xl border backdrop-blur-md font-bold text-sm shadow-lg transform transition-all duration-300 translate-y-[-20px] opacity-0 ${color}`;
            toast.innerHTML = `${title} <span class="text-white ml-2">${amountStr}</span>`;
            
            ui.toastContainer.appendChild(toast);
            
            // Animate in
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-[-20px]', 'opacity-0');
            });
            
            // Remove after 2s
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-4');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        function showMotivation(text) {
            ui.motivationalText.innerText = text;
            ui.motivationalZone.classList.remove('opacity-0');
            ui.motivationalText.classList.remove('scale-150');
            ui.motivationalText.classList.add('scale-100');
            
            setTimeout(() => {
                ui.motivationalZone.classList.add('opacity-0');
                ui.motivationalText.classList.add('scale-150');
                ui.motivationalText.classList.remove('scale-100');
            }, 1500);
        }

        function checkAchievement(id) {
            if (!achievements.includes(id)) {
                achievements.push(id);
                const ach = ACH_DATA.find(a => a.id === id);
                balance += ach.reward;
                showToast(`üèÜ Achieved: ${ach.title}`, `+${ach.reward.toFixed(2)} AZN`, true);
                updateUI();
            }
        }

        // --- Screen Management ---
        function switchScreen(screen) {
            [ui.regScreen, ui.mainMenu, ui.gameScreen].forEach(s => s.classList.add('hidden'));
            screen.classList.remove('hidden');
            updateUI();
        }

        // Initial Route
        if (userRegistered) {
            switchScreen(ui.mainMenu);
        } else {
            switchScreen(ui.regScreen);
        }

        // --- Event Listeners: Menus ---
        document.getElementById('regForm').addEventListener('submit', (e) => {
            e.preventDefault();
            localStorage.setItem('pd_registered', 'true');
            balance = 0.50; // Registration Bonus
            userRegistered = true;
            checkAchievement('first_drive');
            showToast("Welcome Bonus!", "+0.50 AZN", true);
            switchScreen(ui.mainMenu);
        });

        document.getElementById('btnPlay').addEventListener('click', startGame);
        document.getElementById('btnRestart').addEventListener('click', () => {
            if (balance > 0) startGame();
        });
        document.getElementById('btnGoMenu').addEventListener('click', () => {
            ui.gameOverScreen.classList.add('hidden');
            switchScreen(ui.mainMenu);
        });

        document.getElementById('btnDaily').addEventListener('click', () => {
            const today = new Date().toDateString();
            if (lastDaily !== today) {
                lastDaily = today;
                localStorage.setItem('pd_daily', today);
                balance += 0.20;
                showToast("Daily Bonus Collected!", "+0.20 AZN", true);
                updateUI();
            } else {
                showToast("Already collected today!", "", false);
            }
        });

        // Achievements Modal
        document.getElementById('btnAch').addEventListener('click', () => {
            const list = document.getElementById('achList');
            list.innerHTML = '';
            ACH_DATA.forEach(a => {
                const isUnlocked = achievements.includes(a.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl border ${isUnlocked ? 'bg-amber-500/20 border-amber-500/50' : 'bg-slate-800 border-slate-700 opacity-50'}`;
                div.innerHTML = `<p class="font-bold text-amber-400">${a.title} ${isUnlocked ? '‚úÖ' : 'üîí'}</p>
                                 <p class="text-xs text-slate-300">${a.desc} <span class="font-bold text-white ml-2">+${a.reward.toFixed(2)} AZN</span></p>`;
                list.appendChild(div);
            });
            ui.achModal.classList.remove('hidden');
        });
        document.getElementById('closeAch').addEventListener('click', () => ui.achModal.classList.add('hidden'));

        // ==========================================
        // üéÆ GAME ENGINE
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const WIDTH = 450;
        const HEIGHT = 700;
        const LANES = [112.5, 225, 337.5]; // 3 lanes center X
        const CAR_W = 50;
        const CAR_H = 90;
        const PLAYER_Y = HEIGHT - 150;

        // Game State
        let isGameRunning = false;
        let isGameOver = false;
        let isBraking = false;
        let scoreVal = 0;
        let combo = 1;
        let carsPassed = 0;
        let speedMult = 1;
        let linesOffset = 0;
        
        let player = { x: LANES[1], targetX: LANES[1] };
        let traffics = [];
        
        // Mechanics State
        let trafficLight = { active: false, y: -200, state: 'GREEN', timer: 0, passed: false };
        // Police State: NONE, APPROACHING, WAITING, GO
        let police = { active: false, y: -200, state: 'NONE', waitTimer: 0 };

        const colors = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#a855f7', '#ffffff'];
        const motivations = ["PERFECT!", "KEEP GOING!", "SMOOTH!", "NICE MOVES!", "AMAZING!"];
        const failMotivations = ["Don't give up!", "You can do better!", "Try again!", "Dust yourself off!"];

        // Input
        const setLane = (idx) => { if(!isGameOver && !isBraking) player.targetX = LANES[idx]; };
        document.getElementById('ctrlLeft').addEventListener('mousedown', () => setLane(Math.max(0, LANES.indexOf(player.targetX) - 1)));
        document.getElementById('ctrlLeft').addEventListener('touchstart', (e) => { e.preventDefault(); setLane(Math.max(0, LANES.indexOf(player.targetX) - 1)); });
        
        document.getElementById('ctrlRight').addEventListener('mousedown', () => setLane(Math.min(2, LANES.indexOf(player.targetX) + 1)));
        document.getElementById('ctrlRight').addEventListener('touchstart', (e) => { e.preventDefault(); setLane(Math.min(2, LANES.indexOf(player.targetX) + 1)); });

        const btnBrake = document.getElementById('btnBrake');
        const startBrake = (e) => { e.preventDefault(); isBraking = true; };
        const stopBrake = (e) => { e.preventDefault(); isBraking = false; combo = 1; updateHUD(); };
        btnBrake.addEventListener('mousedown', startBrake); btnBrake.addEventListener('mouseup', stopBrake);
        btnBrake.addEventListener('touchstart', startBrake); btnBrake.addEventListener('touchend', stopBrake);

        function startGame() {
            switchScreen(ui.gameScreen);
            ui.gameOverScreen.classList.add('hidden');
            
            isGameRunning = true;
            isGameOver = false;
            isBraking = false;
            scoreVal = 0;
            combo = 1;
            carsPassed = 0;
            speedMult = 1;
            
            player.x = LANES[1];
            player.targetX = LANES[1];
            traffics = [];
            trafficLight.active = false;
            police.active = false;
            
            updateUI();
            updateHUD();
            showMotivation("GO!");
            requestAnimationFrame(gameLoop);
        }

        function triggerShake() {
            const container = document.getElementById('canvasContainer');
            container.classList.remove('shake-effect');
            void container.offsetWidth; // reflow
            container.classList.add('shake-effect');
        }

        function endGame() {
            isGameOver = true;
            isGameRunning = false;
            triggerShake();
            
            if (scoreVal > highScore) {
                highScore = Math.floor(scoreVal);
                showToast("New High Score!", "", true);
            }
            if (scoreVal >= 1000) checkAchievement('score_1000');
            
            ui.goScore.innerText = Math.floor(scoreVal);
            ui.goMotivational.innerText = failMotivations[Math.floor(Math.random() * failMotivations.length)];
            
            setTimeout(() => {
                ui.gameOverScreen.classList.remove('hidden');
                updateUI();
            }, 800);
        }

        function applyPenalty(amount, reason) {
            balance -= amount;
            triggerShake();
            showToast(`‚ùå ${reason}`, `-${amount.toFixed(2)} AZN`, false);
            combo = 1;
            if (balance <= 0) { balance = 0; endGame(); }
            updateUI();
        }

        function applyReward(amount, reason) {
            balance += amount;
            showToast(`‚úÖ ${reason}`, `+${amount.toFixed(2)} AZN`, true);
            updateUI();
        }

        function updateHUD() {
            ui.hudScore.innerText = Math.floor(scoreVal);
            ui.hudCombo.innerText = `x${combo}`;
            if (combo >= 10) checkAchievement('combo_10');
        }

        function update() {
            if (!isGameRunning || isGameOver) return;

            // Base speed calculation
            let baseSpeed = isBraking ? 0 : 6 * speedMult;
            
            if (!isBraking) {
                scoreVal += (0.1 * combo * speedMult);
                speedMult = Math.min(2.5, 1 + (scoreVal / 2000)); // Cap speed multiplier
                updateHUD();
            }

            // Smooth lane switching
            player.x += (player.targetX - player.x) * 0.15;
            linesOffset = (linesOffset + baseSpeed) % 80;

            // ==================
            // TRAFFIC LIGHT LOGIC
            // ==================
            if (!trafficLight.active && !police.active && scoreVal > 50 && Math.random() < 0.003) {
                trafficLight.active = true;
                trafficLight.y = -100;
                trafficLight.passed = false;
                trafficLight.timer = 250; // frames
                trafficLight.state = 'GREEN';
            }

            if (trafficLight.active) {
                trafficLight.y += baseSpeed;
                trafficLight.timer--;
                
                if (trafficLight.timer === 180) trafficLight.state = 'YELLOW';
                if (trafficLight.timer === 100) trafficLight.state = 'RED';
                if (trafficLight.timer === 0) trafficLight.state = 'GREEN';

                if (trafficLight.y > PLAYER_Y + CAR_H && !trafficLight.passed) {
                    trafficLight.passed = true;
                    if (trafficLight.state === 'RED') {
                        if (!isBraking) {
                            applyPenalty(0.20, "Ran Red Light!");
                        } else {
                            applyReward(0.10, "Good Stop!");
                        }
                    } else if (trafficLight.state === 'GREEN' && !isBraking) {
                        applyReward(0.05, "Green Light Bonus!");
                    }
                }
                
                if (trafficLight.y > HEIGHT) trafficLight.active = false;
            }

            // ==================
            // POLICE LOGIC
            // ==================
            if (!police.active && !trafficLight.active && scoreVal > 200 && Math.random() < 0.002) {
                police.active = true;
                police.state = 'APPROACHING';
                police.y = -200;
                showToast("üöì POLICE!", "PREPARE TO STOP", false);
            }

            if (police.active) {
                if (police.state === 'APPROACHING') {
                    police.y += baseSpeed + 2; // Police drives faster to catch up
                    if (police.y > PLAYER_Y - 30) {
                        if (!isBraking) {
                            // Player didn't brake, ran away
                            applyPenalty(0.60, "Fled from Police!");
                            police.state = 'PASSED';
                        } else {
                            // Player stopped!
                            police.state = 'WAITING';
                            police.y = PLAYER_Y - 30; // Lock position
                            police.waitTimer = 180; // 3 seconds at 60fps
                        }
                    }
                } else if (police.state === 'WAITING') {
                    police.y = PLAYER_Y - 30; // stay next to player
                    
                    if (!isBraking) {
                        // Let go of brake too early!
                        applyPenalty(0.60, "Moved before allowed!");
                        police.state = 'PASSED';
                    } else {
                        // Still waiting patiently
                        police.waitTimer--;
                        if (police.waitTimer <= 0) {
                            // 3 seconds passed!
                            police.state = 'GO';
                            applyReward(0.30, "Police Check Passed!");
                            checkAchievement('police_good');
                            showMotivation("GO GO GO!");
                        }
                    }
                } else if (police.state === 'GO' || police.state === 'PASSED') {
                    police.y += baseSpeed;
                    if (police.y > HEIGHT) police.active = false;
                }
            }

            // ==================
            // TRAFFIC CARS LOGIC
            // ==================
            // Do not spawn traffic if waiting for police or at red light to avoid unfair crashes
            const safeToSpawn = !(police.active && police.state === 'WAITING') && !(trafficLight.active && trafficLight.state === 'RED');

            if (safeToSpawn && Math.random() < 0.015 * speedMult && !isBraking) {
                const lane = LANES[Math.floor(Math.random() * LANES.length)];
                // Ensure no overlap when spawning
                if (traffics.every(c => Math.abs(c.x - lane) > 10 || c.y > 150)) {
                    traffics.push({
                        x: lane,
                        y: -150,
                        speed: Math.random() * 2 + 1,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        passed: false
                    });
                }
            }

            for (let i = traffics.length - 1; i >= 0; i--) {
                let car = traffics[i];
                // Traffic moves relative to base speed and their own speed
                car.y += baseSpeed + (isBraking ? car.speed * 2 : car.speed - 3);

                // Collision Detection (Hitbox slightly smaller than visual for fairness)
                const hitX = Math.abs(player.x - car.x) < CAR_W - 10;
                const hitY = player.y < car.y + CAR_H - 10 && player.y + CAR_H - 10 > car.y;
                
                if (hitX && hitY) {
                    applyPenalty(0.10, "Crashed!");
                    endGame();
                    return;
                }

                // Pass detection for Combos
                if (!car.passed && car.y > PLAYER_Y + CAR_H) {
                    car.passed = true;
                    carsPassed++;
                    if (carsPassed % 5 === 0) {
                        combo++;
                        if (combo % 5 === 0) showMotivation(motivations[Math.floor(Math.random() * motivations.length)]);
                        updateHUD();
                    }
                }

                if (car.y > HEIGHT) {
                    traffics.splice(i, 1);
                }
            }
        }

        // --- Drawing ---
        function drawCar(x, y, color, isPlayer) {
            ctx.save();
            ctx.fillStyle = color;
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.roundRect(x - CAR_W/2, y, CAR_W, CAR_H, 8);
            ctx.fill();
            ctx.shadowColor = 'transparent';

            // Windows
            ctx.fillStyle = '#020617';
            ctx.beginPath(); ctx.roundRect(x - CAR_W/2 + 5, y + 15, CAR_W - 10, 20, 3); ctx.fill(); // windshield
            ctx.beginPath(); ctx.roundRect(x - CAR_W/2 + 5, y + CAR_H - 25, CAR_W - 10, 15, 3); ctx.fill(); // rear window

            if (isPlayer && isBraking) {
                ctx.fillStyle = '#f43f5e'; // Brake lights
                ctx.shadowColor = '#f43f5e'; ctx.shadowBlur = 15;
                ctx.fillRect(x - CAR_W/2 + 5, y + CAR_H - 5, 12, 5);
                ctx.fillRect(x + CAR_W/2 - 17, y + CAR_H - 5, 12, 5);
            } else if (!isPlayer) {
                ctx.fillStyle = '#fef08a'; // Headlights
                ctx.shadowColor = '#fef08a'; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.arc(x - CAR_W/2 + 10, y + 5, 4, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(x + CAR_W/2 - 10, y + 5, 4, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }

        function draw() {
            // Background / Grass
            ctx.fillStyle = '#020617';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);

            // Road borders
            ctx.fillStyle = '#1e293b';
            ctx.fillRect(40, 0, 15, HEIGHT);
            ctx.fillRect(WIDTH - 55, 0, 15, HEIGHT);

            // Road surface
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(55, 0, WIDTH - 110, HEIGHT);

            // Lane markers
            ctx.setLineDash([40, 40]);
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 4;
            ctx.lineDashOffset = -linesOffset;
            ctx.beginPath();
            ctx.moveTo(168.75, 0); ctx.lineTo(168.75, HEIGHT);
            ctx.moveTo(281.25, 0); ctx.lineTo(281.25, HEIGHT);
            ctx.stroke();

            // Traffic Light
            if (trafficLight.active) {
                ctx.fillStyle = 'rgba(255,255,255,0.8)';
                ctx.fillRect(55, trafficLight.y, WIDTH - 110, 10); // bridge
                
                ctx.fillStyle = '#1e293b';
                ctx.beginPath(); ctx.roundRect(WIDTH - 50, trafficLight.y - 80, 30, 90, 8); ctx.fill();
                
                const drawBulb = (yOff, color, active) => {
                    ctx.save();
                    ctx.fillStyle = active ? color : '#020617';
                    if(active) { ctx.shadowColor = color; ctx.shadowBlur = 15; }
                    ctx.beginPath(); ctx.arc(WIDTH - 35, trafficLight.y - 80 + yOff, 10, 0, Math.PI*2); ctx.fill();
                    ctx.restore();
                };
                drawBulb(20, '#f43f5e', trafficLight.state === 'RED');
                drawBulb(45, '#facc15', trafficLight.state === 'YELLOW');
                drawBulb(70, '#10b981', trafficLight.state === 'GREEN');
            }

            // Police Car
            if (police.active) {
                const px = WIDTH - 35; // Shoulder
                drawCar(px, police.y, '#ffffff', false); // White police car
                
                // Sirens
                ctx.save();
                const isRed = Date.now() % 300 < 150;
                ctx.fillStyle = isRed ? '#f43f5e' : '#3b82f6';
                ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 20;
                ctx.fillRect(px - CAR_W/2 + 10, police.y + 25, CAR_W - 20, 6);
                ctx.restore();

                // Instruction Text
                ctx.fillStyle = '#f43f5e';
                ctx.font = '900 24px sans-serif';
                ctx.textAlign = 'right';
                if (police.state === 'APPROACHING') {
                    ctx.fillText("üõë STOP!", px - 35, police.y + CAR_H / 2);
                } else if (police.state === 'WAITING') {
                    const sec = Math.ceil(police.waitTimer / 60);
                    ctx.fillText(`WAIT... ${sec}s`, px - 35, police.y + CAR_H / 2);
                } else if (police.state === 'GO') {
                    ctx.fillStyle = '#10b981';
                    ctx.fillText("‚úÖ CONTINUE!", px - 35, police.y + CAR_H / 2);
                }
            }

            // Traffic Cars
            traffics.forEach(car => drawCar(car.x, car.y, car.color, false));
            
            // Player Car
            player.y = PLAYER_Y;
            drawCar(player.x, player.y, '#0ea5e9', true, isBraking);
        }

        function gameLoop() {
            update();
            draw();
            if (isGameRunning) {
                requestAnimationFrame(gameLoop);
            }
        }
    </script>
</body>
</html>
