<!DOCTYPE html>
<html lang="az" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Drive - Master UI</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        body { user-select: none; -webkit-user-select: none; touch-action: none; overflow: hidden; background-color: #020617; } 
        .hidden { display: none !important; }
        .rtl { direction: rtl; font-family: 'Arial', sans-serif; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .neon-cyan { text-shadow: 0 0 10px rgba(34, 211, 238, 0.8); }
        .neon-emerald { text-shadow: 0 0 10px rgba(16, 185, 129, 0.8); }
        .neon-rose { text-shadow: 0 0 10px rgba(244, 63, 94, 0.8); }
        .neon-box-cyan { box-shadow: 0 0 20px rgba(34, 211, 238, 0.15); }
        
        /* Tormoz d√ºym…ôsi √º√ß√ºn x√ºsusi k√∂lg…ô */
        .brake-shadow { box-shadow: 0 0 30px rgba(225, 29, 72, 0.5); }
    </style>
</head>
<body class="text-white h-screen flex flex-col font-sans relative transition-all duration-300">

    <div id="loginScreen" class="h-screen flex items-center justify-center p-6 z-50 absolute inset-0 bg-[#020617]">
        <div class="glass-panel p-10 rounded-[32px] w-full max-w-sm text-center relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-32 h-32 bg-cyan-500/20 rounded-full blur-[40px]"></div>
            
            <h1 class="text-3xl font-black text-white italic mb-2 tracking-tighter neon-cyan relative z-10">PREMIUM DRIVE</h1>
            <p class="text-slate-400 text-sm mb-8 relative z-10"><span id="lbl_loginBalance">Balans:</span> <span id="loginBalanceText" class="font-bold text-cyan-400 neon-cyan">0.00 AZN</span></p>
            
            <button id="loginBtn" class="w-full py-4 bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 rounded-[24px] font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(34,211,238,0.2)] active:scale-95 transition-all relative z-10">
                Oyuna Ba≈üla
            </button>
            <button id="loginTopupBtn" class="w-full mt-4 py-4 glass-panel rounded-[24px] text-white font-bold uppercase tracking-widest active:scale-95 transition-all relative z-10">
                Balansƒ± Artƒ±r
            </button>
        </div>
    </div>

    <div id="gameScreen" class="hidden h-screen flex flex-col relative overflow-hidden bg-[#020617]">
        
        <div class="p-4 flex justify-between items-center z-30 shrink-0">
            <div class="flex gap-2">
                <div class="glass-panel p-2 px-4 rounded-[20px] transition-all" id="balanceBox">
                    <p id="lbl_hudBalance" class="text-[9px] font-black text-cyan-400 uppercase tracking-[2px] mb-0.5 opacity-80">Balans</p>
                    <p id="balanceText" class="text-base font-black neon-cyan">0.00 AZN</p>
                </div>
                <div class="glass-panel p-2 px-4 rounded-[20px]">
                    <p id="lbl_hudDistance" class="text-[9px] font-black text-emerald-400 uppercase tracking-[2px] mb-0.5 opacity-80">M…ôsaf…ô</p>
                    <p id="scoreText" class="text-base font-black neon-emerald">0 M</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="garageBtn" class="w-12 h-12 bg-indigo-500/20 border border-indigo-500/50 text-indigo-400 rounded-[20px] flex items-center justify-center text-xl shadow-[0_0_15px_rgba(99,102,241,0.2)] active:scale-95 transition-all">üõí</button>
                <button id="langBtn" class="w-12 h-12 glass-panel rounded-[20px] flex items-center justify-center text-lg active:scale-95 transition-all">üá¶üáø</button>
                <button id="topupBtn" class="w-12 h-12 bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 rounded-[20px] flex items-center justify-center text-xl shadow-[0_0_15px_rgba(16,185,129,0.2)] active:scale-95 transition-all">üí≥</button>
            </div>
        </div>

        <div class="px-4 z-30 mb-2 shrink-0">
            <div class="glass-panel border-blue-500/30 rounded-[20px] p-3 text-xs text-blue-100 flex items-center gap-3">
                <div class="w-7 h-7 rounded-full bg-blue-500/20 flex items-center justify-center border border-blue-500/40 shadow-[0_0_10px_rgba(59,130,246,0.5)] shrink-0">
                    <span id="aiIcon" class="text-[10px]">ü§ñ</span>
                </div>
                <span id="aiTipText" class="truncate w-full italic font-light">S√ºni intellekt m…ôsl…ôh…ôti y√ºkl…ônir...</span>
            </div>
        </div>

        <div class="flex-1 w-full max-w-[400px] mx-auto relative glass-panel neon-box-cyan rounded-[40px] overflow-hidden z-10 flex shrink">
            <canvas id="gameCanvas" width="400" height="600" class="w-full h-full object-contain bg-[#0f172a]"></canvas>
            
            <div class="absolute inset-0 flex">
                <div id="laneLeft" class="flex-1 active:bg-white/5 cursor-pointer"></div>
                <div id="laneRight" class="flex-1 active:bg-white/5 cursor-pointer"></div>
            </div>

            <div id="gameOverScreen" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-xl flex-col items-center justify-center p-8 text-center z-40">
                <div class="w-20 h-20 rounded-full bg-rose-500/20 flex items-center justify-center mb-4 blur-[2px] mx-auto">
                    <span class="text-4xl">‚ö†Ô∏è</span>
                </div>
                <h2 id="gameOverTitle" class="text-3xl font-black text-rose-500 mb-2 neon-rose tracking-wider">GAME OVER</h2>
                <p class="text-slate-400 text-sm mb-6"><span id="lbl_gameOverDistance">M…ôsaf…ô:</span> <span id="finalScore" class="font-bold text-white">0</span> M</p>
                <button id="restartBtn" class="w-full py-4 bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 rounded-[24px] font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(34,211,238,0.2)] mb-4 active:scale-95 transition-all">YENƒ∞D∆èN BA≈ûLA</button>
                <button id="gameOverTopupBtn" class="w-full py-4 glass-panel rounded-[24px] text-white font-bold uppercase tracking-widest active:scale-95 transition-all">BALANSI ARTIR</button>
            </div>
        </div>

        <div class="w-full max-w-[400px] mx-auto p-4 pb-6 shrink-0 z-20">
            <button id="brakeBtn" class="w-full py-6 rounded-[32px] text-3xl font-black tracking-widest transition-all bg-rose-600 border-4 border-rose-800 text-white brake-shadow active:bg-rose-500 active:scale-95 touch-manipulation">
                TORMOZ
            </button>
        </div>
    </div>

    <div id="garageModal" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-2xl flex flex-col items-center justify-center p-6 z-[100]">
        <div class="glass-panel p-6 rounded-[32px] w-full max-w-sm relative overflow-hidden flex flex-col max-h-[90%]">
            <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-[40px]"></div>
            <div class="flex justify-between items-center mb-6 relative z-10">
                <h2 id="lbl_garageTitle" class="text-2xl font-black neon-cyan italic">QARAJ</h2>
                <div class="text-right">
                    <p class="text-[10px] text-cyan-400 uppercase tracking-widest">Balans</p>
                    <p id="garageBalanceText" class="text-sm font-bold neon-cyan">0.00 AZN</p>
                </div>
            </div>
            <div id="garageList" class="flex-1 overflow-y-auto pr-2 space-y-4 relative z-10 custom-scrollbar"></div>
            <button id="closeGarageBtn" class="w-full mt-6 py-4 glass-panel rounded-[20px] text-slate-300 font-bold uppercase tracking-widest active:scale-95 transition-all relative z-10">Baƒüla</button>
        </div>
    </div>

    <div id="topUpModal" class="hidden absolute inset-0 bg-[#020617]/80 backdrop-blur-2xl flex items-center justify-center p-6 z-[100]">
        <div class="glass-panel p-8 rounded-[40px] text-center w-full max-w-sm relative overflow-hidden">
            <div class="absolute -top-20 -right-20 w-40 h-40 bg-emerald-500/20 rounded-full blur-[50px]"></div>
            <h2 id="lbl_topupModalTitle" class="text-2xl font-black mb-8 neon-emerald relative z-10">Balansƒ±n Artƒ±r</h2>
            <button id="demoTopUpBtn" class="w-full py-4 bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 rounded-[24px] font-bold shadow-[0_0_15px_rgba(16,185,129,0.2)] mb-6 active:scale-95 transition-all relative z-10">+10 AZN (Demo)</button>
            <button id="closeTopUpBtn" class="text-slate-400 text-[12px] font-bold uppercase tracking-widest active:text-white transition-all relative z-10">Baƒüla</button>
        </div>
    </div>
    
    <div id="langModal" class="hidden absolute inset-0 bg-[#020617]/80 backdrop-blur-2xl flex items-center justify-center p-6 z-[100]">
        <div class="glass-panel p-8 rounded-[40px] text-center w-full max-w-sm">
            <h2 class="text-xl font-black mb-8 neon-cyan">Dil / Language</h2>
            <div id="langList" class="grid grid-cols-2 gap-4 mb-8"></div>
            <button id="closeLangBtn" class="text-slate-400 text-[12px] font-bold uppercase tracking-widest active:text-white transition-all">Geri</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ==========================================
        // Dƒ∞LL∆èR V∆è QARAJ M∆èLUMATLARI
        // ==========================================
        const LANGUAGES = {
            az: { name: 'Az…ôrbaycan', flag: 'üá¶üáø', currency: 'AZN', rate: 1, dir: 'ltr', tts: 'tr-TR' },
            en: { name: 'English', flag: 'üá¨üáß', currency: 'USD', rate: 0.59, dir: 'ltr', tts: 'en-US' },
            ru: { name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫', currency: 'RUB', rate: 54.4, dir: 'ltr', tts: 'ru-RU' },
            tr: { name: 'T√ºrk√ße', flag: 'üáπüá∑', currency: 'TRY', rate: 20.3, dir: 'ltr', tts: 'tr-TR' }
        };

        const TRANSLATIONS = {
            az: { loginBtn: "Oyuna Ba≈üla", hudBal: "Balans", brake: "TORMOZ", braking: "DAYANIR...", fuel: "BENZƒ∞N Bƒ∞TDƒ∞", crash: "Q∆èZA", garage: "QARAJ", select: "Se√ß", selected: "Se√ßilib", buy: "Satƒ±n Al" },
            en: { loginBtn: "Start", hudBal: "Balance", brake: "BRAKE", braking: "BRAKING...", fuel: "OUT OF GAS", crash: "CRASH", garage: "GARAGE", select: "Select", selected: "Selected", buy: "Buy" },
            ru: { loginBtn: "–ù–∞—á–∞—Ç—å", hudBal: "–ë–∞–ª–∞–Ω—Å", brake: "–¢–û–†–ú–û–ó", braking: "–¢–û–†–ú–û–ó...", fuel: "–ù–ï–¢ –ë–ï–ù–ó–ò–ù–ê", crash: "–ê–í–ê–†–ò–Ø", garage: "–ì–ê–†–ê–ñ", select: "–í—ã–±—Ä–∞—Ç—å", selected: "–í—ã–±—Ä–∞–Ω–æ", buy: "–ö—É–ø–∏—Ç—å" },
            tr: { loginBtn: "Ba≈üla", hudBal: "Bakiye", brake: "FREN", braking: "DURUYOR...", fuel: "BENZƒ∞N Bƒ∞TTƒ∞", crash: "KAZA", garage: "GARAJ", select: "Se√ß", selected: "Se√ßildi", buy: "Satƒ±n Al" }
        };

        const CAR_SKINS = [
            { id: 'default', name: 'Neon Blue', color: '#0ea5e9', price: 0, owned: true },
            { id: 'sport', name: 'Sport Red', color: '#f43f5e', price: 15.00, owned: false },
            { id: 'taxi', name: 'City Taxi', color: '#facc15', price: 25.00, owned: false },
            { id: 'vip', name: 'VIP Stealth', color: '#0f172a', price: 50.00, owned: false }
        ];
        let activeSkinId = 'default';
        let currentLang = 'az';

        function applyLanguage(code) {
            currentLang = code;
            document.getElementById('langBtn').innerText = LANGUAGES[code].flag;
            document.getElementById('loginBtn').innerText = TRANSLATIONS[code].loginBtn;
            document.getElementById('lbl_hudBalance').innerText = TRANSLATIONS[code].hudBal;
            document.getElementById('brakeBtn').innerText = isBraking ? TRANSLATIONS[code].braking : TRANSLATIONS[code].brake;
            document.getElementById('lbl_garageTitle').innerText = TRANSLATIONS[code].garage;
            updateUI(); renderGarage(); document.getElementById('langModal').classList.add('hidden');
        }

        // ==========================================
        // AUDIO Sƒ∞STEMƒ∞ 
        // ==========================================
        let audioCtx = null; let engineOsc = null; let engineGain = null;
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            engineOsc = audioCtx.createOscillator(); engineGain = audioCtx.createGain();
            engineOsc.type = 'sawtooth'; engineOsc.frequency.setValueAtTime(40, audioCtx.currentTime);
            engineGain.gain.setValueAtTime(0.08, audioCtx.currentTime); 
            engineOsc.connect(engineGain); engineGain.connect(audioCtx.destination); engineOsc.start();
        }

        function playTone(freq, type, duration, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function playCrashSound() { playTone(150, 'sawtooth', 0.5, 0.4); setTimeout(() => playTone(50, 'square', 0.8, 0.4), 100); }
        function playSuccessSound() { playTone(660, 'sine', 0.1, 0.2); setTimeout(() => playTone(880, 'sine', 0.3, 0.2), 100); }
        function playFineSound() { playTone(200, 'square', 0.3, 0.3); setTimeout(() => playTone(150, 'square', 0.4, 0.3), 150); }
        function playBuySound() { playTone(523.25, 'sine', 0.1, 0.2); setTimeout(() => playTone(659.25, 'sine', 0.2, 0.2), 100); setTimeout(() => playTone(783.99, 'sine', 0.3, 0.2), 200); }

        function getSpeechData(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = LANGUAGES[currentLang].tts;
                utterance.rate = 1.1; 
                utterance.onstart = () => { document.getElementById("aiIcon").innerText = "üîä"; };
                utterance.onend = () => { document.getElementById("aiIcon").innerText = "ü§ñ"; };
                window.speechSynthesis.speak(utterance);
            }
        }

        // ==========================================
        // S√úNƒ∞ ƒ∞NTELLEKT (GEMƒ∞Nƒ∞)
        // ==========================================
        const API_KEY = "Sƒ∞Zƒ∞N_API_A√áARINIZI_BURAYA_YAPI≈ûDIRIN"; 
        const genAI = new GoogleGenerativeAI(API_KEY);

        async function getDrivingAdvice(scenario) {
            const aiTipEl = document.getElementById("aiTipText");
            try {
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const prompt = `S…ôn oyunda s…ôsli k√∂m…ôk√ßis…ôn. Ssenari: ${scenario}. ≈û…ôn v…ô maksimum 5 s√∂zl√ºk cavab ver. Dil: ${LANGUAGES[currentLang].name}.`;
                const result = await model.generateContent(prompt);
                const text = await result.response.text();
                aiTipEl.innerText = text;
                getSpeechData(text);
            } catch (error) { console.error(error); }
        }

        // ==========================================
        // OYUN D∆èYƒ∞≈û∆èNL∆èRƒ∞ 
        // ==========================================
        const LOGICAL_WIDTH = 400; const LOGICAL_HEIGHT = 600;
        const CAR_WIDTH = 48; const CAR_HEIGHT = 86; const PLAYER_Y = LOGICAL_HEIGHT - 130;
        const LANES = [100, 200, 300]; 

        const BIOMES = [
            { name: "City", ground: '#020617', road: '#0f172a', curb: '#1e293b' },
            { name: "Forest", ground: '#022c22', road: '#0f172a', curb: '#064e3b' },
            { name: "Canyon", ground: '#291002', road: '#1c1917', curb: '#451a03' }
        ];

        let isGameRunning = false; let isBraking = false; let isGameOver = false;
        let balance = 0.00; let score = 0; let trafficCars = []; let speedMultiplier = 1; 
        let currentBiome = 0; let animatedPopups = []; 
        let gameState = { carX: LANES[1] - CAR_WIDTH / 2, targetX: LANES[1] - CAR_WIDTH / 2, linesOffset: 0 };
        let trafficLight = { active: false, y: -200, state: 'GREEN', timer: 0, passed: false };

        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');

        function updateUI() {
            const info = LANGUAGES[currentLang];
            const formatted = `${(balance * info.rate).toFixed(2)} ${info.currency}`;
            document.getElementById('balanceText').innerText = formatted;
            document.getElementById('loginBalanceText').innerText = formatted;
            document.getElementById('garageBalanceText').innerText = formatted;
            document.getElementById('scoreText').innerText = `${Math.floor(score)} M`;
        }

        function spawnPopup(text, color, x, y) { animatedPopups.push({ text, color, x, y, alpha: 1, life: 60 }); }

        // ==========================================
        // QARAJ M∆èNTƒ∞Qƒ∞
        // ==========================================
        function renderGarage() {
            const list = document.getElementById('garageList');
            list.innerHTML = '';
            const t = TRANSLATIONS[currentLang];
            const info = LANGUAGES[currentLang];

            CAR_SKINS.forEach(car => {
                const item = document.createElement('div');
                item.className = "glass-panel p-4 rounded-[20px] flex items-center justify-between";
                
                const isSelected = activeSkinId === car.id;
                let btnHTML = '';
                
                if (car.owned) {
                    if (isSelected) {
                        btnHTML = `<button disabled class="py-2 px-4 rounded-xl text-xs font-bold bg-cyan-500/10 text-cyan-500 border border-cyan-500/30">${t.selected}</button>`;
                    } else {
                        btnHTML = `<button onclick="window.selectCar('${car.id}')" class="py-2 px-4 rounded-xl text-xs font-bold bg-cyan-500/20 text-cyan-300 border border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.2)] active:scale-95 transition-all">${t.select}</button>`;
                    }
                } else {
                    const priceFormatted = (car.price * info.rate).toFixed(2) + " " + info.currency;
                    const canAfford = balance >= car.price;
                    if (canAfford) {
                        btnHTML = `<button onclick="window.buyCar('${car.id}')" class="py-2 px-4 rounded-xl text-xs font-bold bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 shadow-[0_0_10px_rgba(16,185,129,0.2)] active:scale-95 transition-all">${t.buy} (${priceFormatted})</button>`;
                    } else {
                        btnHTML = `<button disabled class="py-2 px-4 rounded-xl text-xs font-bold bg-slate-800/50 text-slate-500 border border-slate-700">${t.buy} (${priceFormatted})</button>`;
                    }
                }

                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl border border-white/10 flex items-center justify-center shadow-inner" style="background-color: ${car.color}">
                            <div class="w-6 h-10 rounded-sm bg-black/20"></div>
                        </div>
                        <div>
                            <p class="font-bold text-sm text-white">${car.name}</p>
                            ${!car.owned ? `<p class="text-[10px] text-slate-400">${(car.price * info.rate).toFixed(2)} ${info.currency}</p>` : `<p class="text-[10px] text-emerald-400">Gained</p>`}
                        </div>
                    </div>
                    <div>${btnHTML}</div>
                `;
                list.appendChild(item);
            });
        }

        window.selectCar = (id) => { activeSkinId = id; playSuccessSound(); renderGarage(); };
        window.buyCar = (id) => {
            const car = CAR_SKINS.find(c => c.id === id);
            if (car && balance >= car.price) {
                balance -= car.price; car.owned = true; activeSkinId = id;
                playBuySound(); updateUI(); renderGarage(); getDrivingAdvice("Yeni ma≈üƒ±n xeyirli olsun!");
            }
        };

        // ==========================================
        // OYUN M∆èNTƒ∞Qƒ∞
        // ==========================================
        function startGame() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            
            initAudio(); isGameRunning = true; isGameOver = false;
            score = 0; speedMultiplier = 1; trafficCars = []; animatedPopups = []; currentBiome = 0;
            gameState.carX = LANES[1] - CAR_WIDTH / 2; gameState.targetX = LANES[1] - CAR_WIDTH / 2;
            trafficLight.active = false;
            
            updateUI(); getDrivingAdvice("Oyun√ßu yeni oyuna ba≈ülayƒ±r, 'Qaza bas!' de.");
            requestAnimationFrame(gameLoop);
        }

        function gameOver(reason) {
            isGameOver = true;
            document.getElementById('gameOverScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = Math.floor(score);
            document.getElementById('gameOverTitle').innerText = reason === 'crash' ? TRANSLATIONS[currentLang].crash : TRANSLATIONS[currentLang].fuel;
            getDrivingAdvice("Oyun√ßu uduzdu.");
            if (engineGain) engineGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        }

        function spawnTrafficCar() {
            const lane = LANES[Math.floor(Math.random() * LANES.length)];
            const isSafe = trafficCars.every(c => Math.abs(c.x - (lane - CAR_WIDTH/2)) > 10 || c.y > 150);
            if (isSafe && !trafficLight.active) { 
                trafficCars.push({ x: lane - CAR_WIDTH / 2, y: -100, speed: Math.random() * 2 + 2, color: '#f43f5e' });
            }
        }

        function update() {
            if (!isGameRunning || isGameOver) return;
            const baseSpeed = isBraking ? 0 : 5 * speedMultiplier; 
            
            if (score > 800) currentBiome = 2; else if (score > 300) currentBiome = 1; else currentBiome = 0;

            if (!isBraking) {
                score += 0.1 * speedMultiplier; 
                if(speedMultiplier < 1.5) speedMultiplier += 0.0001;
                balance -= 0.002; 
                updateUI(); if (balance <= 0) { balance = 0; gameOver('balance'); return; }
            }

            gameState.linesOffset = (gameState.linesOffset + baseSpeed) % 80;
            gameState.carX += (gameState.targetX - gameState.carX) * 0.15;

            // Svetofor Sistemi
            if (!trafficLight.active && Math.random() < 0.003 && score > 50) {
                trafficLight.active = true; trafficLight.y = -100; trafficLight.passed = false;
                trafficLight.timer = 300; trafficLight.state = 'GREEN';
            }

            if (trafficLight.active) {
                trafficLight.y += baseSpeed;
                trafficLight.timer--;

                if (trafficLight.timer === 200) trafficLight.state = 'YELLOW';
                if (trafficLight.timer === 140) trafficLight.state = 'RED';
                if (trafficLight.timer === 0) trafficLight.state = 'GREEN';

                if (trafficLight.y > PLAYER_Y + CAR_HEIGHT && !trafficLight.passed) {
                    trafficLight.passed = true;
                    if (trafficLight.state === 'RED' && !isBraking) {
                        balance -= 0.20; playFineSound();
                        spawnPopup("-0.20", "#f43f5e", gameState.carX + CAR_WIDTH/2, PLAYER_Y - 20); 
                        getDrivingAdvice("Qƒ±rmƒ±zƒ± i≈üƒ±q! C…ôrim…ô.");
                    } else if (trafficLight.state === 'GREEN') {
                        balance += 0.50; playSuccessSound();
                        spawnPopup("+0.50", "#10b981", gameState.carX + CAR_WIDTH/2, PLAYER_Y - 20); 
                        getDrivingAdvice("Ya≈üƒ±l i≈üƒ±q bonusu!");
                    }
                    if (balance <= 0) { balance = 0; gameOver('balance'); }
                }
                if (trafficLight.y > LOGICAL_HEIGHT) trafficLight.active = false;
            }

            if (Math.random() < 0.02 * speedMultiplier && !isBraking && !trafficLight.active) spawnTrafficCar();

            for (let i = trafficCars.length - 1; i >= 0; i--) {
                let car = trafficCars[i];
                car.y += baseSpeed + (isBraking ? car.speed * 2 : car.speed - 2); 
                
                if (gameState.carX < car.x + CAR_WIDTH - 5 && gameState.carX + CAR_WIDTH - 5 > car.x && PLAYER_Y < car.y + CAR_HEIGHT - 5 && PLAYER_Y + CAR_HEIGHT - 5 > car.y) {
                    balance -= 1.00; playCrashSound();
                    spawnPopup("-1.00", "#f43f5e", gameState.carX + CAR_WIDTH/2, PLAYER_Y);
                    trafficCars.splice(i, 1);
                    getDrivingAdvice("Q…ôza etdin! Pul silindi.");
                    if (balance <= 0) { balance = 0; gameOver('crash'); return; }
                } else if (car.y > LOGICAL_HEIGHT) { trafficCars.splice(i, 1); }
            }

            animatedPopups.forEach(p => { p.y -= 1.5; p.alpha -= 0.015; p.life--; });
            animatedPopups = animatedPopups.filter(p => p.life > 0);

            if (engineGain && audioCtx) {
                engineOsc.frequency.setTargetAtTime(isBraking ? 30 : 40 * speedMultiplier, audioCtx.currentTime, 0.1);
                engineGain.gain.setTargetAtTime(isBraking ? 0.02 : Math.min(0.15, 0.08 * speedMultiplier), audioCtx.currentTime, 0.1);
            }
        }

        // ==========================================
        // √áƒ∞Zƒ∞M V∆è QRAFƒ∞KA
        // ==========================================
        function drawCar(x, y, color, isPlayer, braking) {
            ctx.save();
            ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 15; ctx.shadowOffsetY = 10;
            ctx.fillStyle = color; ctx.beginPath(); ctx.roundRect(x, y, CAR_WIDTH, CAR_HEIGHT, 12); ctx.fill();
            ctx.shadowColor = 'transparent'; 
            
            ctx.fillStyle = '#020617'; 
            ctx.beginPath(); ctx.roundRect(x + 4, y + 15, CAR_WIDTH - 8, 18, 4); ctx.fill();
            ctx.beginPath(); ctx.roundRect(x + 6, y + CAR_HEIGHT - 25, CAR_WIDTH - 12, 12, 3); ctx.fill();
            ctx.fillStyle = 'rgba(255,255,255,0.1)'; ctx.fillRect(x + 10, y + 35, CAR_WIDTH - 20, CAR_HEIGHT - 65);

            if (isPlayer && braking) {
                ctx.fillStyle = '#f43f5e'; ctx.shadowColor = '#f43f5e'; ctx.shadowBlur = 15;
                ctx.fillRect(x + 4, y + CAR_HEIGHT - 6, 12, 4); ctx.fillRect(x + CAR_WIDTH - 16, y + CAR_HEIGHT - 6, 12, 4);
            } else if (!isPlayer) {
                ctx.fillStyle = '#fef08a'; ctx.shadowColor = '#fef08a'; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.arc(x + 10, y + 4, 3, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(x + CAR_WIDTH - 10, y + 4, 3, 0, Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }

        function draw() {
            if (!ctx) return;
            const biome = BIOMES[currentBiome];

            ctx.fillStyle = biome.ground; ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
            ctx.fillStyle = biome.curb; ctx.fillRect(50, 0, 10, LOGICAL_HEIGHT); ctx.fillRect(LOGICAL_WIDTH - 60, 0, 10, LOGICAL_HEIGHT);
            ctx.fillStyle = biome.road; ctx.fillRect(60, 0, LOGICAL_WIDTH - 120, LOGICAL_HEIGHT);

            ctx.setLineDash([30, 40]); ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 4; ctx.lineDashOffset = -gameState.linesOffset;
            ctx.beginPath(); ctx.moveTo(150, 0); ctx.lineTo(150, LOGICAL_HEIGHT); ctx.moveTo(250, 0); ctx.lineTo(250, LOGICAL_HEIGHT); ctx.stroke();

            if (trafficLight.active) {
                ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.fillRect(60, trafficLight.y, LOGICAL_WIDTH - 120, 8); 
                ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.roundRect(LOGICAL_WIDTH - 45, trafficLight.y - 70, 26, 75, 8); ctx.fill();
                const drawLight = (yOff, color, active) => {
                    ctx.save(); if(active) { ctx.shadowColor = color; ctx.shadowBlur = 15; ctx.fillStyle = color; } else { ctx.fillStyle = '#1e293b'; }
                    ctx.beginPath(); ctx.arc(LOGICAL_WIDTH - 32, trafficLight.y - 70 + yOff, 8, 0, Math.PI*2); ctx.fill(); ctx.restore();
                };
                drawLight(16, '#f43f5e', trafficLight.state === 'RED'); drawLight(38, '#facc15', trafficLight.state === 'YELLOW'); drawLight(60, '#10b981', trafficLight.state === 'GREEN');
            }

            trafficCars.forEach(car => drawCar(car.x, car.y, car.color, false, false));
            
            const activeColor = CAR_SKINS.find(c => c.id === activeSkinId).color;
            drawCar(gameState.carX, PLAYER_Y, activeColor, true, isBraking); 

            animatedPopups.forEach(p => {
                ctx.save(); ctx.fillStyle = p.color; ctx.globalAlpha = Math.max(0, p.alpha);
                ctx.shadowColor = p.color; ctx.shadowBlur = 10; ctx.font = '900 24px sans-serif'; ctx.textAlign = 'center';
                ctx.fillText(p.text, p.x, p.y); ctx.restore();
            });
        }

        function gameLoop() { update(); draw(); if (isGameRunning) requestAnimationFrame(gameLoop); }

        // ==========================================
        // ƒ∞DAR∆èETM∆è
        // ==========================================
        document.getElementById('loginBtn').addEventListener('click', () => { if(balance<=0) document.getElementById('topUpModal').classList.remove('hidden'); else startGame(); });
        document.getElementById('restartBtn').addEventListener('click', () => { if(balance<=0) document.getElementById('topUpModal').classList.remove('hidden'); else startGame(); });
        
        document.getElementById('demoTopUpBtn').addEventListener('click', () => {
            balance += 10.00; playSuccessSound(); updateUI(); renderGarage(); document.getElementById('topUpModal').classList.add('hidden');
        });

        const toggleModal = (btnId, modalId, show) => document.getElementById(btnId).addEventListener('click', () => {
            const el = document.getElementById(modalId);
            show ? el.classList.remove('hidden') : el.classList.add('hidden');
            if (show && modalId === 'garageModal') renderGarage();
        });
        
        toggleModal('loginTopupBtn', 'topUpModal', true); toggleModal('topupBtn', 'topUpModal', true); toggleModal('gameOverTopupBtn', 'topUpModal', true); toggleModal('closeTopUpBtn', 'topUpModal', false);
        toggleModal('langBtn', 'langModal', true); toggleModal('closeLangBtn', 'langModal', false);
        toggleModal('garageBtn', 'garageModal', true); toggleModal('closeGarageBtn', 'garageModal', false);

        const langList = document.getElementById('langList');
        Object.keys(LANGUAGES).forEach(code => {
            const btn = document.createElement('button');
            btn.className = "py-3 glass-panel rounded-[20px] font-bold flex items-center justify-center gap-2 active:scale-95 text-sm";
            btn.innerHTML = `<span>${LANGUAGES[code].flag}</span> <span>${LANGUAGES[code].name}</span>`;
            btn.onclick = () => applyLanguage(code);
            langList.appendChild(btn);
        });

        const brakeBtn = document.getElementById('brakeBtn');
        const startBraking = (e) => { e.preventDefault(); isBraking = true; brakeBtn.innerText = TRANSLATIONS[currentLang].braking; };
        const stopBraking = (e) => { e.preventDefault(); isBraking = false; brakeBtn.innerText = TRANSLATIONS[currentLang].brake; };
        brakeBtn.addEventListener('mousedown', startBraking); brakeBtn.addEventListener('mouseup', stopBraking);
        brakeBtn.addEventListener('touchstart', startBraking, {passive: false}); brakeBtn.addEventListener('touchend', stopBraking, {passive: false});
        
        document.getElementById('laneLeft').addEventListener('mousedown', () => { if(gameState.targetX > LANES[0] - CAR_WIDTH/2) gameState.targetX -= 100; });
        document.getElementById('laneLeft').addEventListener('touchstart', (e) => { e.preventDefault(); if(gameState.targetX > LANES[0] - CAR_WIDTH/2) gameState.targetX -= 100; }, {passive: false});
        document.getElementById('laneRight').addEventListener('mousedown', () => { if(gameState.targetX < LANES[2] - CAR_WIDTH/2) gameState.targetX += 100; });
        document.getElementById('laneRight').addEventListener('touchstart', (e) => { e.preventDefault(); if(gameState.targetX < LANES[2] - CAR_WIDTH/2) gameState.targetX += 100; }, {passive: false});

        applyLanguage(currentLang);
    </script>
</body>
</html>
