<!DOCTYPE html>
<html lang="az" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Drive - Relax Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>
    <style>
        body { user-select: none; -webkit-user-select: none; touch-action: none; overflow: hidden; background-color: #020617; } 
        .hidden { display: none !important; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .neon-cyan { text-shadow: 0 0 10px rgba(34, 211, 238, 0.8); }
        .neon-emerald { text-shadow: 0 0 10px rgba(16, 185, 129, 0.8); }
        .brake-shadow { box-shadow: 0 0 40px rgba(225, 29, 72, 0.4); }

        @keyframes shake {
            0% { transform: translate(1px, 1px); }
            100% { transform: translate(-1px, -2px); }
        }
        .shake-effect { animation: shake 0.3s; }
    </style>
</head>
<body class="text-white h-screen flex flex-col font-sans relative transition-all duration-300">

    <div id="loginScreen" class="h-screen flex items-center justify-center p-6 z-50 absolute inset-0 bg-[#020617]">
        <div class="glass-panel p-10 rounded-[32px] w-full max-w-sm text-center relative overflow-hidden">
            <h1 class="text-3xl font-black text-white italic mb-2 tracking-tighter neon-cyan">PREMIUM DRIVE</h1>
            <p class="text-slate-400 text-sm mb-8"><span id="loginBalanceText" class="font-bold text-cyan-400">0.60 AZN</span></p>
            <button id="loginBtn" class="w-full py-4 bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 rounded-[24px] font-bold uppercase tracking-widest active:scale-95 transition-all">Oyuna Ba≈üla</button>
        </div>
    </div>

    <div id="gameScreen" class="hidden h-screen flex flex-col relative overflow-hidden bg-[#020617]">
        <div class="p-4 flex justify-between items-center z-30 shrink-0">
            <div class="flex gap-2">
                <div class="glass-panel p-2 px-4 rounded-[20px]">
                    <p class="text-[9px] font-black text-cyan-400 uppercase mb-0.5">Balans</p>
                    <p id="balanceText" class="text-base font-black neon-cyan">0.60 AZN</p>
                </div>
                <div class="glass-panel p-2 px-4 rounded-[20px]">
                    <p class="text-[9px] font-black text-emerald-400 uppercase mb-0.5">M…ôsaf…ô</p>
                    <p id="scoreText" class="text-base font-black neon-emerald">0 M</p>
                </div>
            </div>
            <button id="topupBtn" class="w-12 h-12 bg-indigo-500/20 border border-indigo-500/50 text-indigo-400 rounded-[20px] flex items-center justify-center text-xl">üõí</button>
        </div>

        <div class="px-4 z-30 mb-2 shrink-0">
            <div class="glass-panel border-blue-500/30 rounded-[20px] p-3 text-xs flex items-center gap-3">
                <div id="aiIcon" class="w-7 h-7 rounded-full bg-blue-500/20 flex items-center justify-center">ü§ñ</div>
                <span id="aiTipText" class="truncate italic font-light">S√ºni intellekt m…ôsl…ôh…ôti...</span>
            </div>
        </div>

        <div class="flex-1 w-full max-w-[400px] mx-auto relative glass-panel rounded-[40px] overflow-hidden z-10 flex shrink" id="gameContainer">
            <canvas id="gameCanvas" width="400" height="600" class="w-full h-full object-contain bg-[#0f172a]"></canvas>
            <div class="absolute inset-0 flex">
                <div id="laneLeft" class="flex-1 cursor-pointer"></div>
                <div id="laneRight" class="flex-1 cursor-pointer"></div>
            </div>
            
            <div id="gameOverScreen" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-xl flex-col items-center justify-center p-8 text-center z-40">
                <h2 class="text-3xl font-black text-rose-500 mb-2">OYUN Bƒ∞TDƒ∞</h2>
                <p class="text-slate-400 mb-6">M…ôsaf…ô: <span id="finalScore" class="font-bold text-white">0</span> M</p>
                <button id="restartBtn" class="w-full py-4 bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 rounded-[24px] font-bold uppercase active:scale-95 transition-all">YENƒ∞D∆èN BA≈ûLA</button>
            </div>
        </div>

        <div class="w-full max-w-[400px] mx-auto p-4 pb-6 shrink-0 z-20">
            <button id="brakeBtn" class="w-full py-6 rounded-[32px] text-3xl font-black tracking-widest transition-all bg-rose-600 border-4 border-rose-800 text-white brake-shadow active:bg-rose-500 active:scale-95 touch-manipulation">TORMOZ</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- RELAX AUDIO SYSTEM ---
        let audioCtx = null;
        let engineOsc = null;
        let engineGain = null;
        let noiseNode = null;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // M√ºh…ôrrik √º√ß√ºn "M√ºlayim Sinus" dalƒüasƒ± (Rahatlƒ±q verir)
            engineOsc = audioCtx.createOscillator();
            engineOsc.type = 'sine'; 
            engineOsc.frequency.setValueAtTime(50, audioCtx.currentTime);

            // Yol k√ºy√º (Pink Noise - Psixoloji rahatlƒ±q √º√ß√ºn)
            const bufferSize = 2 * audioCtx.sampleRate;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            let b0, b1, b2, b3, b4, b5, b6;
            b0 = b1 = b2 = b3 = b4 = b5 = b6 = 0.0;
            for (let i = 0; i < bufferSize; i++) {
                const white = Math.random() * 2 - 1;
                b0 = 0.99886 * b0 + white * 0.0555179;
                b1 = 0.99332 * b1 + white * 0.0750759;
                b2 = 0.96900 * b2 + white * 0.1538520;
                b3 = 0.86650 * b3 + white * 0.3104856;
                b4 = 0.55000 * b4 + white * 0.5329522;
                b5 = -0.7616 * b5 - white * 0.0168980;
                output[i] = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362;
                output[i] *= 0.11;
                b6 = white * 0.115926;
            }
            noiseNode = audioCtx.createBufferSource();
            noiseNode.buffer = noiseBuffer;
            noiseNode.loop = true;

            engineGain = audioCtx.createGain();
            const noiseGain = audioCtx.createGain();

            engineGain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            noiseGain.gain.setValueAtTime(0.02, audioCtx.currentTime);

            engineOsc.connect(engineGain);
            noiseNode.connect(noiseGain);
            
            engineGain.connect(audioCtx.destination);
            noiseGain.connect(audioCtx.destination);

            engineOsc.start();
            noiseNode.start();
        }

        function playSoftTone(freq, duration, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = 'sine'; // H…ômi≈ü…ô m√ºlayim sine istifad…ô et
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        // --- OYUN M∆èNTƒ∞Qƒ∞ ---
        const LOGICAL_WIDTH = 400; const LOGICAL_HEIGHT = 600;
        const CAR_WIDTH = 48; const CAR_HEIGHT = 86; const PLAYER_Y = LOGICAL_HEIGHT - 130;
        const LANES = [100, 200, 300];

        let balance = 0.60;
        let score = 0;
        let isGameRunning = false;
        let isBraking = false;
        let trafficCars = [];
        let speedMultiplier = 1;
        let policeEvent = { active: false, y: -200, passed: false, isWaiting: false };
        let gameState = { carX: LANES[1] - CAR_WIDTH / 2, targetX: LANES[1] - CAR_WIDTH / 2, linesOffset: 0 };

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        function updateUI() {
            document.getElementById('balanceText').innerText = balance.toFixed(2) + " AZN";
            document.getElementById('loginBalanceText').innerText = balance.toFixed(2) + " AZN";
            document.getElementById('scoreText').innerText = Math.floor(score) + " M";
        }

        function startGame() {
            initAudio();
            isGameRunning = true;
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if (!isGameRunning) return;

            let baseSpeed = (isBraking || policeEvent.isWaiting) ? 0 : 5 * speedMultiplier;
            score += baseSpeed * 0.02;
            gameState.linesOffset = (gameState.linesOffset + baseSpeed) % 80;
            gameState.carX += (gameState.targetX - gameState.carX) * 0.15;

            // Audio Dinamikasƒ± (S√ºr…ôt…ô g√∂r…ô m√ºlayim d…ôyi≈üir)
            if (engineGain) {
                let targetFreq = 40 + (baseSpeed * 5);
                engineOsc.frequency.setTargetAtTime(targetFreq, audioCtx.currentTime, 0.2);
            }

            // POLƒ∞S M∆èNTƒ∞Qƒ∞ (Yeni: 0.30 qazanc / 0.60 c…ôrim…ô / 3 san g√∂zl…ôm…ô)
            if (!policeEvent.active && Math.random() < 0.003 && score > 20) {
                policeEvent.active = true; policeEvent.y = -200; policeEvent.passed = false; policeEvent.isWaiting = false;
                playSoftTone(440, 0.5, 0.05); // M√ºlayim x…ôb…ôrdarlƒ±q s…ôsi
            }

            if (policeEvent.active) {
                if (!policeEvent.isWaiting) policeEvent.y += baseSpeed;

                if (policeEvent.y > PLAYER_Y - 50 && !policeEvent.passed) {
                    if (isBraking && !policeEvent.isWaiting) {
                        policeEvent.isWaiting = true;
                        balance += 0.30;
                        updateUI();
                        playSoftTone(660, 0.4, 0.1);
                        setTimeout(() => {
                            policeEvent.isWaiting = false;
                            policeEvent.passed = true;
                            playSoftTone(880, 0.3, 0.1);
                        }, 3000);
                    } else if (policeEvent.y > PLAYER_Y + CAR_HEIGHT) {
                        policeEvent.passed = true;
                        balance -= 0.60;
                        updateUI();
                        playSoftTone(200, 0.5, 0.2); // M√ºlayim "c…ôrim…ô" tonu
                        if (balance <= 0) { isGameRunning = false; document.getElementById('gameOverScreen').classList.remove('hidden'); }
                    }
                }
                if (policeEvent.y > LOGICAL_HEIGHT) policeEvent.active = false;
            }
        }

        function draw() {
            ctx.fillStyle = '#020617';
            ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
            
            // Yol
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(60, 0, LOGICAL_WIDTH - 120, LOGICAL_HEIGHT);
            
            // Cizgil…ôr
            ctx.setLineDash([30, 40]);
            ctx.strokeStyle = 'rgba(255,255,255,0.1)';
            ctx.lineDashOffset = -gameState.linesOffset;
            ctx.beginPath(); ctx.moveTo(150, 0); ctx.lineTo(150, LOGICAL_HEIGHT); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(250, 0); ctx.lineTo(250, LOGICAL_HEIGHT); ctx.stroke();

            // Polis
            if (policeEvent.active) {
                ctx.fillStyle = '#3b82f6';
                ctx.beginPath(); ctx.roundRect(LOGICAL_WIDTH - 50, policeEvent.y, 40, 80, 10); ctx.fill();
                ctx.fillStyle = 'white'; ctx.font = 'bold 12px sans-serif';
                ctx.fillText("POLICE", LOGICAL_WIDTH - 48, policeEvent.y + 40);
            }

            // Oyun√ßu Ma≈üƒ±nƒ±
            ctx.fillStyle = '#0ea5e9';
            ctx.beginPath(); ctx.roundRect(gameState.carX, PLAYER_Y, CAR_WIDTH, CAR_HEIGHT, 12); ctx.fill();
            if (isBraking) {
                ctx.fillStyle = '#f43f5e';
                ctx.fillRect(gameState.carX + 5, PLAYER_Y + CAR_HEIGHT - 5, 10, 5);
                ctx.fillRect(gameState.carX + CAR_WIDTH - 15, PLAYER_Y + CAR_HEIGHT - 5, 10, 5);
            }
        }

        function gameLoop() { update(); draw(); if (isGameRunning) requestAnimationFrame(gameLoop); }

        // Event Listeners
        document.getElementById('loginBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', () => location.reload());
        
        const brakeBtn = document.getElementById('brakeBtn');
        brakeBtn.addEventListener('mousedown', () => isBraking = true);
        brakeBtn.addEventListener('mouseup', () => isBraking = false);
        brakeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); isBraking = true; });
        brakeBtn.addEventListener('touchend', (e) => { e.preventDefault(); isBraking = false; });

        document.getElementById('laneLeft').addEventListener('click', () => { if(gameState.targetX > 100) gameState.targetX -= 100; });
        document.getElementById('laneRight').addEventListener('click', () => { if(gameState.targetX < 300) gameState.targetX += 100; });

        updateUI();
    </script>
</body>
</html>
