<script>
        // S√úNƒ∞ ƒ∞NTELLEKT MODULUNUN T∆èHL√úK∆èSƒ∞Z Y√úKL∆èNM∆èSƒ∞
        let genAI = null;
        const API_KEY = "Sƒ∞Zƒ∞N_API_A√áARINIZI_BURAYA_YAPI≈ûDIRIN"; 
        
        // Modulu asinxron y√ºkl…ôyirik ki, …ôg…ôr x…ôta olarsa oyun √ß√∂km…ôsin v…ô yazƒ±lar ekrana g…ôlsin
        import('https://esm.run/@google/generative-ai').then(module => {
            genAI = new module.GoogleGenerativeAI(API_KEY);
        }).catch(err => {
            console.warn("AI modulu y√ºkl…ôn…ô bilm…ôdi. Oyun problemsiz davam ed…ôc…ôk.", err);
        });

        // MULTI-LANGUAGE & CURRENCY SYSTEM
        const LANGUAGES = {
            az: { code: 'az', name: 'Az…ôrbaycan', flag: 'üá¶üáø', currency: 'AZN', rate: 1.0, dir: 'ltr', tts: 'tr-TR', 
                t: { regTitle:"QEYDƒ∞YYAT", rulesTitle:"QAYDALAR:", rule1:"‚Ä¢ H…ôr bir istifad…ô√ßi yalnƒ±z 1 d…ôf…ô qeydiyyatdan ke√ß…ô bil…ôr.", rule2:"‚Ä¢ Eyni cihazdan bird…ôn √ßox hesab yaradƒ±larsa, sistem avtomatik ban ed…ôc…ôk.", rule3:"‚Ä¢ Sƒ±fƒ±r balansla oyuna ba≈ülamaq qadaƒüandƒ±r.", phName:"Ad v…ô Soyad", phUser:"ƒ∞stifad…ô√ßi Adƒ±", phAge:"Ya≈ü", phPass:"≈ûifr…ô (Min. 6 simvol)", btnReg:"QEYDƒ∞YYATDAN KE√á", hasAcc:"Hesabƒ±nƒ±z var?", btnLoginNav:"Daxil olun", logTitle:"Gƒ∞Rƒ∞≈û", phPass2:"≈ûifr…ô", errLogin:"M…ôlumatlar yanlƒ±≈üdƒ±r!", btnLog:"DAXƒ∞L OL", noAcc:"Hesabƒ±nƒ±z yoxdur?", btnRegNav:"Qeydiyyat", banTitle:"HESAB BLOKLANDI", banText:"Sistemd…ô √ßoxlu hesab yaratmaƒüa c…ôhd etdiyiniz √º√ß√ºn cihazƒ±nƒ±z bloklanmƒ±≈üdƒ±r.", lblBal:"Balans:", btnStart:"Oyuna Ba≈üla", btnTopup:"Balansƒ± Artƒ±r", hudBal:"Balans", hudDist:"M…ôsaf…ô", aiLoad:"S√ºni intellekt m…ôsl…ôh…ôti y√ºkl…ônir...", demoTitle:"Demo Rejimi", demoText:"Balansƒ±nƒ±za minimum m…ôbl…ôƒüi y√ºkl…ôyin v…ô hesabƒ±nƒ±z aktiv hesab sayƒ±lsƒ±n. Qazandƒ±ƒüƒ±nƒ±z pul h…ôqiqi olsun. Hazƒ±rda oyun demo rejimind…ôdir.", btnGotIt:"Anladƒ±m", lblDist:"M…ôsaf…ô:", msgLocked:"Balansƒ±nƒ±z bitdi! Oyun kilidl…ôndi. Davam etm…ôk √º√ß√ºn balansƒ± artƒ±rƒ±n.", btnRestart:"YENƒ∞D∆èN BA≈ûLA", btnBrake:"TORMOZ", topupTitle:"Balansƒ± Artƒ±r", topupP1:"linkin…ô daxil olaraq √∂d…ôni≈ü edin.", topupP2:"Balans bitdikd…ô yalnƒ±z m…ôbl…ôƒü y√ºkl…ôy…ôr…ôk oyuna davam ed…ô bil…ôrsiniz. (ƒ∞lk yoxlamada bonus veril…ôc…ôk)", topupP3:"Minimum m…ôbl…ôƒü 3 AZN-dir. ∆èg…ôr balansƒ± artƒ±rmadan oyuna davam ets…ôniz, oyun DEMO sayƒ±lƒ±r v…ô √∂d…ôni≈ü olunmur. Yalnƒ±z √∂d…ôni≈ü etdikd…ôn sonra oyun tam aktiv olur, ger√ß…ôk pul qazana v…ô naƒüdla≈üdƒ±ra bil…ôrsiniz.", btnPay:"√ñd…ôni≈ü Et", btnVerify:"√ñd…ôni≈üi Yoxla", btnClose:"Baƒüla", withTitle:"Naƒüdla≈üdƒ±r", lblCurBal:"Cari Balansƒ±nƒ±z", phWName:"Ad v…ô Soyadƒ±nƒ±z", phWCard:"Kart v…ô ya Hesab N√∂mr…ôsi", warnWith:"Balansƒ±nƒ±z kifay…ôt etmir (Min: 30 AZN).", btnSubmit:"Sorƒüu G√∂nd…ôr", btnBack:"Geri", garageTitle:"QARAJ", btnSel:"Se√ß", btnSelected:"Se√ßilib", btnBuy:"Al", 
                msgFine:"Qƒ±rmƒ±zƒ± i≈üƒ±q c…ôrim…ôsi!", msgStop:"Polis…ô tabe olmadƒ±n!", msgCrash:"Q…ôza!", msgDanger:"T…ôhl√ºk…ôli!", msgWait:"G√∂zl…ô, yoxlanƒ±≈ü...", msgGo:"Davam et!", msgLock:"Oyun kilidl…ôndi!", msgPause:"Oyun dayandƒ±rƒ±ldƒ±.", msgNoBal:"Balans bitib, artƒ±rmalƒ±san!", msgGas:"Qaza bas!", msgNewCar:"Yeni ma≈üƒ±n!", msgPaySuccess:"√ñd…ôni≈ü uƒüurlu! Davam et!" }
            },
            en: { code: 'en', name: 'English', flag: 'üá¨üáß', currency: 'USD', rate: 0.59, dir: 'ltr', tts: 'en-US',
                t: { regTitle:"REGISTER", rulesTitle:"RULES:", rule1:"‚Ä¢ Each user can register only once.", rule2:"‚Ä¢ Multiple accounts from the same device will result in an auto-ban.", rule3:"‚Ä¢ Starting the game with zero balance is forbidden.", phName:"Full Name", phUser:"Username", phAge:"Age", phPass:"Password (Min. 6 chars)", btnReg:"SIGN UP", hasAcc:"Have an account?", btnLoginNav:"Log in", logTitle:"LOGIN", phPass2:"Password", errLogin:"Invalid credentials!", btnLog:"LOGIN", noAcc:"Don't have an account?", btnRegNav:"Register", banTitle:"ACCOUNT BANNED", banText:"Your device has been banned due to multiple account creation attempts.", lblBal:"Balance:", btnStart:"Start Game", btnTopup:"Top Up", hudBal:"Balance", hudDist:"Distance", aiLoad:"Loading AI advice...", demoTitle:"Demo Mode", demoText:"Top up the minimum amount to activate your account. Earned money will be real. The game is currently in demo mode.", btnGotIt:"Got It", lblDist:"Distance:", msgLocked:"Out of balance! Game locked. Top up to continue.", btnRestart:"RESTART", btnBrake:"BRAKE", topupTitle:"Top Up Balance", topupP1:"link to make a payment.", topupP2:"When balance ends, you can only continue by adding funds. (Bonus on first check)", topupP3:"Minimum amount is equivalent to 3 AZN. If you continue without topping up, the game is DEMO and no payouts are made. Only after the payment your account becomes active to earn and withdraw real money.", btnPay:"Pay Now", btnVerify:"Verify Payment", btnClose:"Close", withTitle:"Withdraw", lblCurBal:"Current Balance", phWName:"Your Full Name", phWCard:"Card or Account Number", warnWith:"Insufficient balance.", btnSubmit:"Submit Request", btnBack:"Back", garageTitle:"GARAGE", btnSel:"Select", btnSelected:"Selected", btnBuy:"Buy", 
                msgFine:"Red light fine!", msgStop:"Ignored the police!", msgCrash:"Crash!", msgDanger:"Near miss!", msgWait:"Wait, inspecting...", msgGo:"Proceed!", msgLock:"Game Locked!", msgPause:"Game Paused.", msgNoBal:"Out of balance, top up!", msgGas:"Hit the gas!", msgNewCar:"New car!", msgPaySuccess:"Payment successful! Continue!" }
            }
            // Dig…ôr dill…ôri bura …ôlav…ô ed…ô bil…ôrsiniz (uk, ru, tr, de, fr, es, ar)...
        };

        let currentLang = localStorage.getItem('premiumDriveLang') || null;

        function applyTranslations() {
            if (!currentLang || !LANGUAGES[currentLang]) return;
            const langObj = LANGUAGES[currentLang];
            
            document.documentElement.lang = langObj.code;
            document.documentElement.dir = langObj.dir;
            
            document.getElementById('currentFlagIcon').innerText = langObj.flag;
            document.getElementById('currentCurrCode').innerText = langObj.currency;

            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (langObj.t[key]) el.innerText = langObj.t[key];
            });

            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if (langObj.t[key]) el.setAttribute('placeholder', langObj.t[key]);
            });
            
            updateUI();
            if(document.getElementById('garageModal') && !document.getElementById('garageModal').classList.contains('hidden')) renderGarage();
        }

        function changeLanguage(code) {
            currentLang = code;
            localStorage.setItem('premiumDriveLang', code);
            applyTranslations();
            document.getElementById('langSelectModal').classList.add('hidden');
            document.getElementById('globalLangSelector').classList.remove('hidden');
            checkAuthState(); 
        }

        function initLanguageModal() {
            const container = document.getElementById('langListContainer');
            Object.values(LANGUAGES).forEach(l => {
                const btn = document.createElement('button');
                btn.className = "p-4 glass-panel rounded-2xl flex items-center justify-center gap-3 active:scale-95 transition-all text-white font-bold";
                btn.innerHTML = `<span class="text-2xl">${l.flag}</span> <span>${l.name}</span>`;
                btn.onclick = () => changeLanguage(l.code);
                container.appendChild(btn);
            });
        }
        initLanguageModal();

        document.getElementById('langToggleBtn').addEventListener('click', () => {
            document.getElementById('langSelectModal').classList.remove('hidden');
            document.getElementById('globalLangSelector').classList.add('hidden');
        });

        const CAR_SKINS = [
            { id: 'default', name: 'Neon Blue', color: '#0ea5e9', price: 0, owned: true },
            { id: 'sport', name: 'Sport Red', color: '#f43f5e', price: 5.00, owned: false },
            { id: 'taxi', name: 'City Taxi', color: '#facc15', price: 10.00, owned: false },
            { id: 'vip', name: 'VIP Stealth', color: '#0f172a', price: 25.00, owned: false }
        ];
        
        const TRAFFIC_COLORS = ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#a855f7', '#cbd5e1', '#ea580c'];
        let activeSkinId = 'default';

        // AUDIO
        let audioCtx = null; let engineOsc = null; let engineGain = null;
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            engineOsc = audioCtx.createOscillator(); engineGain = audioCtx.createGain();
            engineOsc.type = 'sawtooth'; engineOsc.frequency.setValueAtTime(40, audioCtx.currentTime);
            engineGain.gain.setValueAtTime(0.08, audioCtx.currentTime); 
            engineOsc.connect(engineGain); engineGain.connect(audioCtx.destination); engineOsc.start();
        }
        function playTone(freq, type, duration, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        function playCrashSound() { playTone(150, 'sawtooth', 0.5, 0.4); setTimeout(() => playTone(50, 'square', 0.8, 0.4), 100); }
        function playSuccessSound() { playTone(660, 'sine', 0.1, 0.2); setTimeout(() => playTone(880, 'sine', 0.3, 0.2), 100); }
        function playFineSound() { playTone(200, 'square', 0.3, 0.3); setTimeout(() => playTone(150, 'square', 0.4, 0.3), 150); }
        function playBuySound() { playTone(523.25, 'sine', 0.1, 0.2); setTimeout(() => playTone(659.25, 'sine', 0.2, 0.2), 100); setTimeout(() => playTone(783.99, 'sine', 0.3, 0.2), 200); }
        function playNitroSound() { playTone(300, 'square', 0.1, 0.1); setTimeout(() => playTone(500, 'sawtooth', 0.5, 0.2), 100); }
        function playPoliceSiren() { playTone(800, 'sine', 0.3, 0.2); setTimeout(() => playTone(600, 'sine', 0.3, 0.2), 300); }

        function getSpeechData(text) {
            if ('speechSynthesis' in window && currentLang) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = LANGUAGES[currentLang].tts; utterance.rate = 1.1; 
                utterance.onstart = () => { document.getElementById("aiIcon").innerText = "üîä"; };
                utterance.onend = () => { document.getElementById("aiIcon").innerText = "ü§ñ"; };
                window.speechSynthesis.speak(utterance);
            }
        }

        async function getDrivingAdvice(scenario) {
            const aiTipEl = document.getElementById("aiTipText");
            if (!genAI) {
                aiTipEl.innerText = scenario; // AI y√ºkl…ônm…ôyibs…ô, default mesaj ver
                getSpeechData(scenario);
                return;
            }
            try {
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const langName = currentLang ? LANGUAGES[currentLang].name : 'Az…ôrbaycanca';
                const prompt = `S…ôn oyunda s…ôsli k√∂m…ôk√ßis…ôn. Ssenari: ${scenario}. √áox h…ôy…ôcanlƒ± v…ô maksimum 4 s√∂zl√ºk cavab ver. Dil: ${langName}.`;
                const result = await model.generateContent(prompt);
                const text = await result.response.text();
                aiTipEl.innerText = text; getSpeechData(text);
            } catch (error) { 
                console.error("AI X…ôtasƒ±:", error); 
                aiTipEl.innerText = scenario;
            }
        }

        function triggerScreenShake() {
            const container = document.getElementById('gameContainer');
            container.classList.remove('shake-effect');
            void container.offsetWidth; 
            container.classList.add('shake-effect');
        }

        // QEYDƒ∞YYAT V∆è Gƒ∞Rƒ∞≈û (T∆èHL√úK∆èSƒ∞Z LOCALSTORAGE OXUNMASI)
        let savedBalance = localStorage.getItem('premiumDriveBalance');
        let balance = savedBalance !== null && !isNaN(parseFloat(savedBalance)) ? parseFloat(savedBalance) : 0.00;

        const authScreen = document.getElementById('authScreen');
        const loginFormScreen = document.getElementById('loginFormScreen');
        const mainAppScreen = document.getElementById('loginScreen'); 
        const banScreen = document.getElementById('banScreen');
        const langModal = document.getElementById('langSelectModal');

        let currentUser = null;
        try {
            const storedUser = localStorage.getItem('premiumDriveUser');
            if(storedUser) currentUser = JSON.parse(storedUser);
        } catch(e) {
            localStorage.removeItem('premiumDriveUser'); // X…ôta varsa t…ômizl…ô
        }
        
        let isBanned = localStorage.getItem('premiumDriveBan') === 'true';

        function checkAuthState() {
            // ∆èvv…ôlc…ô h…ôr ≈üeyi gizl…ôdirik ki, √ºst-√ºst…ô d√º≈üm…ôsin
            [langModal, authScreen, loginFormScreen, mainAppScreen, banScreen].forEach(el => el.classList.add('hidden'));
            
            if (!currentLang) {
                langModal.classList.remove('hidden');
                document.getElementById('globalLangSelector').classList.add('hidden');
                return;
            }
            
            document.getElementById('globalLangSelector').classList.remove('hidden');

            if (isBanned) {
                banScreen.classList.remove('hidden');
            } else if (currentUser) {
                mainAppScreen.classList.remove('hidden');
                if(!isGameRunning) applyTranslations(); 
            } else {
                authScreen.classList.remove('hidden');
            }
        }

        if(currentLang) applyTranslations();
        checkAuthState();

        document.getElementById('showLoginBtn').addEventListener('click', () => {
            authScreen.classList.add('hidden'); loginFormScreen.classList.remove('hidden');
        });
        document.getElementById('showRegisterBtn').addEventListener('click', () => {
            loginFormScreen.classList.add('hidden'); authScreen.classList.remove('hidden');
        });

        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            if (localStorage.getItem('premiumDriveUser') !== null) {
                localStorage.setItem('premiumDriveBan', 'true');
                isBanned = true;
                checkAuthState(); return;
            }
            currentUser = { 
                fullName: document.getElementById('regFullName').value, 
                username: document.getElementById('regUsername').value, 
                age: document.getElementById('regAge').value, 
                password: document.getElementById('regPassword').value, 
                bonusClaimed: false 
            };
            localStorage.setItem('premiumDriveUser', JSON.stringify(currentUser));
            localStorage.setItem('premiumDriveBalance', '0.00'); balance = 0.00;
            checkAuthState();
        });

        document.getElementById('loginUserForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const user = document.getElementById('logUsername').value;
            const pass = document.getElementById('logPassword').value;
            let savedUser = null;
            try { savedUser = JSON.parse(localStorage.getItem('premiumDriveUser')); } catch(e){}
            
            if (savedUser && savedUser.username === user && savedUser.password === pass) {
                currentUser = savedUser;
                document.getElementById('loginError').classList.add('hidden');
                checkAuthState();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        });

        // OYUN D∆èYƒ∞≈û∆èNL∆èRƒ∞
        const LOGICAL_WIDTH = 400; const LOGICAL_HEIGHT = 600;
        const CAR_WIDTH = 48; const CAR_HEIGHT = 86; const PLAYER_Y = LOGICAL_HEIGHT - 130;
        const LANES = [100, 200, 300]; const BIOMES = [{ ground: '#020617', road: '#0f172a', curb: '#1e293b' }];

        let isGameRunning = false; let isBraking = false; let isGameOver = false;
        let score = 0; let trafficCars = []; let speedMultiplier = 1; let animatedPopups = []; 
        let nitroTimer = 0; let screenShake = 0; let demoReminderTimeout;
        let gameState = { carX: LANES[1] - CAR_WIDTH / 2, targetX: LANES[1] - CAR_WIDTH / 2, linesOffset: 0 };
        let trafficLight = { active: false, y: -200, state: 'GREEN', timer: 0, passed: false };
        let policeEvent = { active: false, y: -200, passed: false, isWaiting: false };

        const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d');

        function formatCurrency(baseAznValue) {
            const lang = LANGUAGES[currentLang] || LANGUAGES['az'];
            return (baseAznValue * lang.rate).toFixed(2) + ' ' + lang.currency;
        }

        function getT(key) {
            if(!currentLang || !LANGUAGES[currentLang]) return key;
            return LANGUAGES[currentLang].t[key] || key;
        }

        function updateUI() {
            localStorage.setItem('premiumDriveBalance', balance.toFixed(2));
            const formatted = formatCurrency(balance);
            document.getElementById('balanceText').innerText = formatted;
            document.getElementById('loginBalanceText').innerText = formatted;
            document.getElementById('garageBalanceText').innerText = formatted;
            document.getElementById('withdrawBalanceDisplay').innerText = formatted;
            document.getElementById('scoreText').innerText = `${Math.floor(score)} M`;
            document.getElementById('hiddenBalanceInput').value = formatted;
            
            const submitBtn = document.getElementById('submitWithdrawBtn');
            const warning = document.getElementById('withdrawWarning');
            if (balance < 30) { 
                submitBtn.disabled = true; submitBtn.classList.add('opacity-50', 'cursor-not-allowed'); warning.classList.remove('hidden');
            } else {
                submitBtn.disabled = false; submitBtn.classList.remove('opacity-50', 'cursor-not-allowed'); warning.classList.add('hidden');
            }
        }

        function spawnPopup(text, color, x, y) { animatedPopups.push({ text, color, x, y, alpha: 1, life: 60 }); }

        window.selectCar = (id) => { activeSkinId = id; playSuccessSound(); renderGarage(); };
        window.buyCar = (id) => {
            const car = CAR_SKINS.find(c => c.id === id);
            if (car && balance >= car.price) {
                balance -= car.price; car.owned = true; activeSkinId = id;
                playBuySound(); updateUI(); renderGarage(); getDrivingAdvice(getT("msgNewCar"));
            }
        };

        function renderGarage() {
            const list = document.getElementById('garageList'); list.innerHTML = '';
            CAR_SKINS.forEach(car => {
                const item = document.createElement('div'); item.className = "glass-panel p-4 rounded-[20px] flex items-center justify-between";
                const isSelected = activeSkinId === car.id; let btnHTML = '';
                if (car.owned) {
                    btnHTML = isSelected ? `<button disabled class="py-2 px-4 rounded-xl text-xs font-bold bg-cyan-500/10 text-cyan-500">${getT("btnSelected")}</button>` 
                    : `<button onclick="window.selectCar('${car.id}')" class="py-2 px-4 rounded-xl text-xs font-bold bg-cyan-500/20 text-cyan-300">${getT("btnSel")}</button>`;
                } else {
                    const priceF = formatCurrency(car.price);
                    btnHTML = balance >= car.price ? `<button onclick="window.buyCar('${car.id}')" class="py-2 px-4 rounded-xl text-xs font-bold bg-emerald-500/20 text-emerald-400">${getT("btnBuy")} (${priceF})</button>`
                    : `<button disabled class="py-2 px-4 rounded-xl text-xs font-bold bg-slate-800/50 text-slate-500">${getT("btnBuy")} (${priceF})</button>`;
                }
                item.innerHTML = `<div class="flex items-center gap-4"><div class="w-12 h-12 rounded-xl flex items-center justify-center" style="background-color: ${car.color}"><div class="w-6 h-10 bg-black/20"></div></div><div><p class="font-bold text-sm">${car.name}</p></div></div><div>${btnHTML}</div>`;
                list.appendChild(item);
            });
        }

        document.getElementById('closeDemoReminder').addEventListener('click', () => document.getElementById('demoReminder').classList.add('hidden'));

        function startGame() {
            if (balance <= 0) {
                document.getElementById('topUpModal').classList.remove('hidden');
                getDrivingAdvice(getT("msgNoBal"));
                return;
            }
            mainAppScreen.classList.add('hidden'); 
            document.getElementById('gameScreen').classList.remove('hidden'); 
            document.getElementById('gameOverScreen').classList.add('hidden'); 
            document.getElementById('globalLangSelector').classList.add('hidden');
            
            initAudio(); isGameRunning = true; isGameOver = false; score = 0; speedMultiplier = 1; trafficCars = []; animatedPopups = [];
            nitroTimer = 0; screenShake = 0;
            gameState.carX = LANES[1] - CAR_WIDTH / 2; gameState.targetX = LANES[1] - CAR_WIDTH / 2; 
            trafficLight.active = false; policeEvent.active = false; policeEvent.isWaiting = false;
            
            clearTimeout(demoReminderTimeout); document.getElementById('demoReminder').classList.add('hidden');
            demoReminderTimeout = setTimeout(() => {
                if (isGameRunning && !isGameOver) {
                    document.getElementById('demoReminder').classList.remove('hidden');
                    playTone(600, 'square', 0.2, 0.2); 
                    getDrivingAdvice("Hesabƒ± aktivl…ô≈üdir!");
                }
            }, 15000);

            updateUI(); getDrivingAdvice(getT("msgGas")); requestAnimationFrame(gameLoop);
        }

        function gameOver() {
            isGameOver = true; 
            clearTimeout(demoReminderTimeout); document.getElementById('demoReminder').classList.add('hidden'); 
            document.getElementById('gameOverScreen').classList.remove('hidden'); 
            document.getElementById('finalScore').innerText = Math.floor(score);
            document.getElementById('globalLangSelector').classList.remove('hidden');
            
            const restartBtn = document.getElementById('restartBtn'); const topupBtn = document.getElementById('gameOverTopupBtn');
            const msg = document.getElementById('gameOverMessage'); const title = document.getElementById('gameOverTitle');

            if (balance <= 0) {
                title.innerText = getT("msgLock").toUpperCase(); title.classList.replace('text-rose-500', 'text-red-600'); 
                restartBtn.classList.add('hidden'); topupBtn.classList.remove('hidden'); 
                msg.innerText = getT("msgLocked"); msg.classList.remove('hidden');
                getDrivingAdvice(getT("msgLock")); 
            } else {
                title.innerText = "GAME OVER"; title.classList.replace('text-red-600', 'text-rose-500');
                restartBtn.classList.remove('hidden'); topupBtn.classList.add('hidden'); msg.classList.add('hidden');
                getDrivingAdvice(getT("msgPause")); 
            }
            if (engineGain) engineGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        }

        function update() {
            if (!isGameRunning || isGameOver) return;
            const langObj = LANGUAGES[currentLang] || LANGUAGES['az'];
            
            let currentBaseSpeed = 5; if (nitroTimer > 0) { currentBaseSpeed += 6; nitroTimer--; }
            const baseSpeed = (isBraking || policeEvent.isWaiting) ? 0 : currentBaseSpeed * speedMultiplier; 
            if (!isBraking && !policeEvent.isWaiting) { score += (nitroTimer > 0 ? 0.3 : 0.1) * speedMultiplier; } 
            gameState.linesOffset = (gameState.linesOffset + baseSpeed) % 80; gameState.carX += (gameState.targetX - gameState.carX) * 0.15;
            if (screenShake > 0) screenShake--;

            // ƒ∞≈ûIQFOR
            if (!trafficLight.active && !policeEvent.active && Math.random() < 0.005 && score > 10) { trafficLight.active = true; trafficLight.y = -100; trafficLight.passed = false; trafficLight.timer = 300; trafficLight.state = 'GREEN'; }
            if (trafficLight.active) {
                trafficLight.y += baseSpeed; trafficLight.timer--;
                if (trafficLight.timer === 200) trafficLight.state = 'YELLOW';
                if (trafficLight.timer === 140) trafficLight.state = 'RED';
                if (trafficLight.timer === 0) trafficLight.state = 'GREEN';

                if (trafficLight.y > PLAYER_Y + CAR_HEIGHT && !trafficLight.passed) {
                    trafficLight.passed = true;
                    if (trafficLight.state === 'RED' && !isBraking) { 
                        balance -= 0.60; playFineSound(); triggerScreenShake(); screenShake = 15;
                        spawnPopup("- " + formatCurrency(0.60), "#f43f5e", gameState.carX + CAR_WIDTH/2, PLAYER_Y - 20); 
                        if (balance <= 0) { balance = 0; updateUI(); gameOver(); return; } 
                        getDrivingAdvice(getT("msgFine")); 
                    } else if (trafficLight.state === 'GREEN') { 
                        balance += 0.40; nitroTimer = 60; playSuccessSound(); playNitroSound();
                        spawnPopup("üöÄ + " + formatCurrency(0.40), "#10b981", gameState.carX + CAR_WIDTH/2, PLAYER_Y - 20); 
                    }
                    updateUI(); 
                }
                if (trafficLight.y > LOGICAL_HEIGHT) trafficLight.active = false;
            }

            // POLƒ∞S
            if (!policeEvent.active && !trafficLight.active && Math.random() < 0.003 && score > 30) {
                policeEvent.active = true; policeEvent.y = -200; policeEvent.passed = false; policeEvent.isWaiting = false; playPoliceSiren();
            }
            if (policeEvent.active) {
                if (!policeEvent.isWaiting) policeEvent.y += baseSpeed;
                if (policeEvent.y > PLAYER_Y - 50 && !policeEvent.passed) {
                    if (isBraking && !policeEvent.isWaiting) {
                        policeEvent.isWaiting = true; balance += 0.30; playSuccessSound();
                        spawnPopup("üëÆ + " + formatCurrency(0.30), "#10b981", LOGICAL_WIDTH/2, PLAYER_Y - 30); updateUI();
                        getDrivingAdvice(getT("msgWait"));
                        setTimeout(() => { if (policeEvent.active) { policeEvent.isWaiting = false; policeEvent.passed = true; getDrivingAdvice(getT("msgGo")); playSuccessSound(); spawnPopup("‚úÖ " + getT("msgGo").toUpperCase(), "#34d399", LOGICAL_WIDTH/2, PLAYER_Y - 50); } }, 3000);
                    } else if (policeEvent.y > PLAYER_Y + CAR_HEIGHT && !policeEvent.isWaiting) {
                        policeEvent.passed = true; balance -= 0.60; playFineSound(); triggerScreenShake(); screenShake = 20;
                        spawnPopup("üöì - " + formatCurrency(0.60), "#f43f5e", LOGICAL_WIDTH/2, PLAYER_Y - 30);
                        if (balance <= 0) { balance = 0; updateUI(); gameOver(); return; } 
                        getDrivingAdvice(getT("msgStop")); updateUI();
                    }
                }
                if (policeEvent.y > LOGICAL_HEIGHT && policeEvent.passed) policeEvent.active = false;
            }

            // TRAFƒ∞K
            if (Math.random() < 0.008 * speedMultiplier && !isBraking && !trafficLight.active && !policeEvent.active) {
                const lane = LANES[Math.floor(Math.random() * LANES.length)];
                if (trafficCars.every(c => Math.abs(c.x - (lane - CAR_WIDTH/2)) > 10 || c.y > 150)) {
                    trafficCars.push({ x: lane - CAR_WIDTH / 2, y: -150, speed: Math.random() * 0.5 + 1.0, color: TRAFFIC_COLORS[Math.floor(Math.random() * TRAFFIC_COLORS.length)], type: Math.random() > 0.8 ? 'truck' : 'car', height: Math.random() > 0.8 ? 130 : CAR_HEIGHT, nearMissed: false, crashed: false });
                }
            }

            for (let i = trafficCars.length - 1; i >= 0; i--) {
                let car = trafficCars[i]; car.y += baseSpeed + (isBraking ? car.speed * 2 : car.speed - 2); 
                if (!car.crashed && gameState.carX < car.x + CAR_WIDTH - 12 && gameState.carX + CAR_WIDTH - 12 > car.x && PLAYER_Y < car.y + car.height - 12 && PLAYER_Y + CAR_HEIGHT - 12 > car.y) {
                    balance -= 0.10; playCrashSound(); triggerScreenShake(); screenShake = 20;
                    spawnPopup("- " + formatCurrency(0.10), "#f43f5e", gameState.carX + CAR_WIDTH/2, PLAYER_Y); 
                    car.crashed = true; trafficCars.splice(i, 1); 
                    if (balance <= 0) { balance = 0; updateUI(); gameOver(); return; } 
                    getDrivingAdvice(getT("msgCrash")); updateUI(); 
                } 
                else if (!car.crashed && !car.nearMissed && car.y > PLAYER_Y - car.height && car.y < PLAYER_Y + CAR_HEIGHT) {
                    if (Math.abs((gameState.carX + CAR_WIDTH/2) - (car.x + CAR_WIDTH/2)) < CAR_WIDTH + 20) {
                        car.nearMissed = true; balance += 0.05; playTone(800, 'sine', 0.1, 0.1); 
                        spawnPopup("‚ö° " + getT("msgDanger") + " + " + formatCurrency(0.05), "#facc15", gameState.carX + CAR_WIDTH/2, PLAYER_Y - 20); updateUI();
                    }
                }
                else if (car.y > LOGICAL_HEIGHT) { trafficCars.splice(i, 1); }
            }

            animatedPopups.forEach(p => { p.y -= (nitroTimer > 0 ? 3 : 1.5); p.alpha -= 0.015; p.life--; }); animatedPopups = animatedPopups.filter(p => p.life > 0);
            if (engineGain && audioCtx) { 
                let freq = (isBraking || policeEvent.isWaiting) ? 30 : 40 * speedMultiplier;
                if (nitroTimer > 0) freq = 80; 
                engineOsc.frequency.setTargetAtTime(freq, audioCtx.currentTime, 0.1); 
                engineGain.gain.setTargetAtTime((isBraking || policeEvent.isWaiting) ? 0.02 : Math.min(0.15, 0.08 * speedMultiplier), audioCtx.currentTime, 0.1); 
            }
        }

        function drawCar(x, y, color, isPlayer, braking, type = 'car', height = CAR_HEIGHT) {
            ctx.save(); ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 15; ctx.shadowOffsetY = 10; ctx.fillStyle = color; 
            ctx.beginPath(); ctx.roundRect(x, y, CAR_WIDTH, height, 12); ctx.fill(); ctx.shadowColor = 'transparent'; 
            if (type === 'car' || type === 'police') {
                ctx.fillStyle = '#020617'; ctx.beginPath(); ctx.roundRect(x + 4, y + 15, CAR_WIDTH - 8, 18, 4); ctx.fill(); 
                ctx.beginPath(); ctx.roundRect(x + 6, y + height - 25, CAR_WIDTH - 12, 12, 3); ctx.fill();
            } else if (type === 'truck') {
                ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.roundRect(x + 2, y + 25, CAR_WIDTH - 4, height - 30, 4); ctx.fill();
                ctx.fillStyle = '#020617'; ctx.beginPath(); ctx.roundRect(x + 4, y + 5, CAR_WIDTH - 8, 15, 4); ctx.fill();
            }
            if (isPlayer && (braking || policeEvent.isWaiting)) { ctx.fillStyle = '#f43f5e'; ctx.fillRect(x + 4, y + height - 6, 12, 4); ctx.fillRect(x + CAR_WIDTH - 16, y + height - 6, 12, 4); } 
            else if (!isPlayer) { ctx.fillStyle = '#fef08a'; ctx.beginPath(); ctx.arc(x + 10, y + 4, 3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x + CAR_WIDTH - 10, y + 4, 3, 0, Math.PI*2); ctx.fill(); }
            if (isPlayer && nitroTimer > 0) { ctx.fillStyle = 'rgba(34, 211, 238, 0.5)'; ctx.beginPath(); ctx.roundRect(x + 10, y + height, CAR_WIDTH - 20, Math.random() * 40 + 20, 5); ctx.fill(); }
            ctx.restore();
        }

        function draw() {
            if (!ctx) return; ctx.save();
            if (screenShake > 0) { ctx.translate(Math.random() * 10 - 5, Math.random() * 10 - 5); }
            const biome = BIOMES[0];
            ctx.fillStyle = biome.ground; ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT); 
            ctx.fillStyle = biome.curb; ctx.fillRect(50, 0, 10, LOGICAL_HEIGHT); ctx.fillRect(LOGICAL_WIDTH - 60, 0, 10, LOGICAL_HEIGHT); 
            ctx.fillStyle = biome.road; ctx.fillRect(60, 0, LOGICAL_WIDTH - 120, LOGICAL_HEIGHT);
            let dashLength = nitroTimer > 0 ? 60 : 30; ctx.setLineDash([dashLength, 40]); ctx.strokeStyle = nitroTimer > 0 ? 'rgba(34, 211, 238, 0.4)' : 'rgba(255,255,255,0.15)'; ctx.lineWidth = 4; ctx.lineDashOffset = -gameState.linesOffset; ctx.beginPath(); ctx.moveTo(150, 0); ctx.lineTo(150, LOGICAL_HEIGHT); ctx.moveTo(250, 0); ctx.lineTo(250, LOGICAL_HEIGHT); ctx.stroke();

            if (trafficLight.active) {
                ctx.fillStyle = 'rgba(255,255,255,0.8)'; ctx.fillRect(60, trafficLight.y, LOGICAL_WIDTH - 120, 8); ctx.fillStyle = '#0f172a'; ctx.beginPath(); ctx.roundRect(LOGICAL_WIDTH - 45, trafficLight.y - 70, 26, 75, 8); ctx.fill();
                const drawLight = (yOff, color, active) => { ctx.save(); ctx.fillStyle = active ? color : '#1e293b'; ctx.beginPath(); ctx.arc(LOGICAL_WIDTH - 32, trafficLight.y - 70 + yOff, 8, 0, Math.PI*2); ctx.fill(); ctx.restore(); };
                drawLight(16, '#f43f5e', trafficLight.state === 'RED'); drawLight(38, '#facc15', trafficLight.state === 'YELLOW'); drawLight(60, '#10b981', trafficLight.state === 'GREEN');
            }

            if (policeEvent.active) {
                let px = LOGICAL_WIDTH - 55; drawCar(px, policeEvent.y, '#ffffff', false, false, 'police', CAR_HEIGHT);
                ctx.fillStyle = (Date.now() % 400 < 200) ? '#f43f5e' : '#3b82f6'; ctx.fillRect(px + 10, policeEvent.y + 20, CAR_WIDTH - 20, 6);
                ctx.fillStyle = '#f43f5e'; ctx.font = '900 20px sans-serif'; ctx.textAlign = 'right'; ctx.fillText("üõë", px - 10, policeEvent.y + CAR_HEIGHT / 2);
            }

            trafficCars.forEach(car => drawCar(car.x, car.y, car.color, false, false, car.type, car.height));
            drawCar(gameState.carX, PLAYER_Y, CAR_SKINS.find(c => c.id === activeSkinId).color, true, isBraking, 'car', CAR_HEIGHT); 
            animatedPopups.forEach(p => { ctx.save(); ctx.fillStyle = p.color; ctx.globalAlpha = Math.max(0, p.alpha); ctx.font = '900 20px sans-serif'; ctx.textAlign = 'center'; ctx.fillText(p.text, p.x, p.y); ctx.restore(); });
            if (nitroTimer > 0) { ctx.fillStyle = 'rgba(34, 211, 238, ' + (nitroTimer/60 * 0.1) + ')'; ctx.fillRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT); }
            ctx.restore();
        }

        function gameLoop() { update(); draw(); if (isGameRunning) requestAnimationFrame(gameLoop); }

        document.getElementById('loginBtn').addEventListener('click', startGame); document.getElementById('restartBtn').addEventListener('click', startGame);
        document.getElementById('gameOverTopupBtn').addEventListener('click', () => { document.getElementById('topUpModal').classList.remove('hidden'); });
        document.getElementById('buyMeCoffeeBtn').addEventListener('click', () => { window.open('https://buymeacoffee.com/surwin', '_blank'); });
        
        document.getElementById('verifyPaymentBtn').addEventListener('click', (e) => {
            const btn = e.currentTarget; const originalText = btn.innerHTML; btn.innerHTML = `‚è≥ ...`; btn.disabled = true;
            setTimeout(() => {
                let user = null;
                try { user = JSON.parse(localStorage.getItem('premiumDriveUser')); } catch(e){}
                
                if (user && !user.bonusClaimed) { balance += 0.50; user.bonusClaimed = true; localStorage.setItem('premiumDriveUser', JSON.stringify(user)); updateUI(); playSuccessSound(); btn.innerHTML = `‚úÖ (+ ${formatCurrency(0.50)})`; } 
                else { balance += 3.40; updateUI(); playSuccessSound(); btn.innerHTML = `‚úÖ (+ ${formatCurrency(3.40)})`; }
                btn.classList.replace('text-emerald-400', 'text-white'); btn.classList.replace('bg-emerald-500/10', 'bg-emerald-600');
                
                setTimeout(() => { 
                    document.getElementById('topUpModal').classList.add('hidden'); btn.innerHTML = originalText; btn.disabled = false; btn.classList.replace('text-white', 'text-emerald-400'); btn.classList.replace('bg-emerald-600', 'bg-emerald-500/10'); 
                    if (isGameOver && balance > 0) {
                        const title = document.getElementById('gameOverTitle'); const restartBtn = document.getElementById('restartBtn'); const topupBtn = document.getElementById('gameOverTopupBtn'); const msg = document.getElementById('gameOverMessage');
                        title.innerText = "GAME OVER"; title.classList.replace('text-red-600', 'text-rose-500'); restartBtn.classList.remove('hidden'); topupBtn.classList.add('hidden'); msg.classList.add('hidden'); getDrivingAdvice(getT("msgPaySuccess"));
                    }
                }, 2000);
            }, 3000);
        });

        const toggleModal = (btnId, modalId, show) => document.getElementById(btnId).addEventListener('click', () => { document.getElementById(modalId).classList[show ? 'remove' : 'add']('hidden'); updateUI(); if(show && modalId==='garageModal') renderGarage(); });
        toggleModal('loginTopupBtn', 'topUpModal', true); toggleModal('topupBtn', 'topUpModal', true); toggleModal('closeTopUpBtn', 'topUpModal', false);
        toggleModal('withdrawBtn', 'withdrawModal', true); toggleModal('closeWithdrawBtn', 'withdrawModal', false);
        toggleModal('garageBtn', 'garageModal', true); toggleModal('closeGarageBtn', 'garageModal', false);

        const brakeBtn = document.getElementById('brakeBtn'); const startBraking = (e) => { e.preventDefault(); isBraking = true; }; const stopBraking = (e) => { e.preventDefault(); isBraking = false; };
        brakeBtn.addEventListener('mousedown', startBraking); brakeBtn.addEventListener('mouseup', stopBraking); brakeBtn.addEventListener('touchstart', startBraking, {passive: false}); brakeBtn.addEventListener('touchend', stopBraking, {passive: false});
        const goLeft = (e) => { e.preventDefault(); if(gameState.targetX > LANES[0] - CAR_WIDTH/2) gameState.targetX -= 100; }; const goRight = (e) => { e.preventDefault(); if(gameState.targetX < LANES[2] - CAR_WIDTH/2) gameState.targetX += 100; };
        document.getElementById('laneLeft').addEventListener('mousedown', goLeft); document.getElementById('laneLeft').addEventListener('touchstart', goLeft, {passive: false});
        document.getElementById('laneRight').addEventListener('mousedown', goRight); document.getElementById('laneRight').addEventListener('touchstart', goRight, {passive: false});
    </script>
