<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Premium Drive - Play & Earn (Mobile)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --glass: rgba(15, 23, 42, 0.85);
            --neon-cyan: #22d3ee;
            --neon-rose: #f43f5e;
            --neon-emerald: #10b981;
        }
        body {
            margin: 0;
            padding: 0;
            background: #020617;
            color: white;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            /* Mobil ekranda default s√ºr√º≈üm…ôni v…ô refresh-i bloklayƒ±r */
            touch-action: none; 
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            /* M…ôtni se√ßm…ôyin qar≈üƒ±sƒ±nƒ± alƒ±r */
            user-select: none; 
            -webkit-user-select: none;
        }
        #gameCanvas {
            background: #0f172a;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.8);
            display: none;
            width: 100%;
            height: 100%;
        }
        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 24px;
        }
        .btn-brake {
            touch-action: manipulation;
            transition: transform 0.1s;
            /* Mobild…ô klikl…ôy…ônd…ô yaranan mavi k√∂lg…ôni silir */
            -webkit-tap-highlight-color: transparent; 
        }
        .btn-brake:active { transform: scale(0.9); background: #991b1b !important; }
        
        @keyframes shake {
            0% { transform: translate(2px, 2px) rotate(0deg); }
            20% { transform: translate(-4px, 0px) rotate(-1deg); }
            40% { transform: translate(4px, 2px) rotate(1deg); }
            100% { transform: translate(2px, -2px) rotate(0deg); }
        }
        .shake { animation: shake 0.4s; }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .pointer-events-auto { pointer-events: auto; }
    </style>
</head>
<body>

<div id="auth-screen" class="glass-panel p-6 w-full max-w-sm mx-4 pointer-events-auto z-50">
    <h1 class="text-2xl font-black mb-6 text-center text-cyan-400 tracking-wider">PREMIUM DRIVE</h1>
    <div class="space-y-3" id="reg-form">
        <input type="text" id="reg-name" placeholder="Ad Soyad" class="w-full p-3 rounded-xl bg-slate-800/50 border border-slate-700 outline-none focus:border-cyan-400 text-sm">
        <input type="text" id="reg-user" placeholder="ƒ∞stifad…ô√ßi adƒ±" class="w-full p-3 rounded-xl bg-slate-800/50 border border-slate-700 text-sm">
        <input type="password" id="reg-pass" placeholder="≈ûifr…ô" class="w-full p-3 rounded-xl bg-slate-800/50 border border-slate-700 text-sm">
        <button onclick="register()" class="w-full py-3 mt-2 bg-cyan-600 active:bg-cyan-700 rounded-xl font-bold transition text-sm">DAXƒ∞L OL</button>
    </div>
</div>

<div id="main-menu" class="hidden glass-panel p-6 w-full max-w-sm mx-4 pointer-events-auto z-50">
    <div class="flex justify-between items-center mb-6 border-b border-slate-700/50 pb-4">
        <div>
            <p class="text-slate-400 text-xs uppercase tracking-wider">S√ºr√ºc√º</p>
            <h2 id="display-name" class="text-lg font-bold text-white">ƒ∞stifad…ô√ßi</h2>
        </div>
        <div class="text-right">
            <p class="text-slate-400 text-xs uppercase tracking-wider">Balans</p>
            <h2 id="display-balance" class="text-lg font-black text-emerald-400">0.00 AZN</h2>
        </div>
    </div>
    
    <div class="grid grid-cols-2 gap-3 mb-4">
        <button onclick="startGame()" class="col-span-2 py-4 bg-emerald-600 active:bg-emerald-700 rounded-2xl font-black text-xl shadow-lg shadow-emerald-900/40 tracking-wider">S√úR√ú≈û∆è BA≈ûLA</button>
        <button onclick="dailyBonus()" class="py-3 bg-slate-800 active:bg-slate-700 rounded-xl text-xs font-bold border border-slate-600">G√ºnd…ôlik Bonus</button>
        <button onclick="showTopup()" class="py-3 bg-rose-600 active:bg-rose-700 rounded-xl text-xs font-bold shadow-lg shadow-rose-900/40">Balansƒ± Artƒ±r</button>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="ui-layer" class="hidden flex flex-col justify-between">
    <div class="p-4 flex justify-between items-start pt-10">
        <div class="glass-panel p-2 px-4">
            <p class="text-[10px] text-slate-400 font-bold">BALANS</p>
            <p id="ingame-balance" class="text-lg font-mono font-bold text-emerald-400">0.00</p>
        </div>
        <div class="glass-panel p-2 px-4 text-right">
            <p class="text-[10px] text-slate-400 font-bold">XAL</p>
            <p id="ingame-score" class="text-lg font-mono font-bold">0</p>
        </div>
    </div>

    <div id="ai-msg" class="absolute top-24 left-1/2 -translate-x-1/2 text-center opacity-0 transition-opacity w-[90%] pointer-events-none">
        <p class="glass-panel px-4 py-3 text-cyan-300 text-sm font-bold border-cyan-500/30 shadow-xl shadow-cyan-900/20"></p>
    </div>

    <div class="absolute bottom-8 left-1/2 -translate-x-1/2 pointer-events-auto">
        <button id="brake-btn" class="btn-brake w-28 h-28 sm:w-32 sm:h-32 rounded-full bg-red-600 border-8 border-red-900 shadow-[0_0_30px_rgba(220,38,38,0.5)] flex items-center justify-center font-black text-xl tracking-widest text-white/90">TORMOZ</button>
    </div>
</div>

<div id="block-screen" class="hidden fixed inset-0 bg-slate-950/98 z-[100] flex items-center justify-center p-6 text-center pointer-events-auto">
    <div class="glass-panel p-6 border border-rose-500/50 w-full max-w-sm">
        <h2 class="text-2xl font-black text-rose-500 mb-2">BALANS Bƒ∞TDƒ∞ üõë</h2>
        <p class="text-slate-300 mb-6 text-sm">Davam etm…ôk √º√ß√ºn balansƒ±nƒ±zƒ± artƒ±rƒ±n.</p>
        <button onclick="endGame()" class="block w-full py-4 bg-slate-800 active:bg-slate-700 rounded-xl font-bold mb-3 text-sm">MENYUYA QAYIT</button>
    </div>
</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const UI = {
    auth: document.getElementById('auth-screen'),
    menu: document.getElementById('main-menu'),
    layer: document.getElementById('ui-layer'),
    balance: document.getElementById('display-balance'),
    ingameBalance: document.getElementById('ingame-balance'),
    aiMsg: document.getElementById('ai-msg'),
    block: document.getElementById('block-screen')
};

let user = JSON.parse(localStorage.getItem('pd_user_m')) || null;
let gameState = 'MENU'; 
let balance = 0;
let score = 0;
let speed = 6;
let laneWidth = 0;
let playerLane = 1;
let objects = [];
let isBraking = false;
let carWidth = 46;
let carHeight = 80;

window.onload = () => {
    if(user) {
        balance = user.balance;
        showMenu();
    }
};

function register() {
    const name = document.getElementById('reg-name').value || "S√ºr√ºc√º";
    user = { name, balance: 2.00, firstBonus: true }; // Test √º√ß√ºn ilkin balans
    balance = user.balance;
    localStorage.setItem('pd_user_m', JSON.stringify(user));
    showMenu();
}

function showMenu() {
    UI.auth.classList.add('hidden');
    UI.menu.classList.remove('hidden');
    UI.balance.innerText = `${balance.toFixed(2)} AZN`;
    document.getElementById('display-name').innerText = user.name;
}

function updateBalance(amount) {
    balance += amount;
    if(balance < 0) balance = 0;
    user.balance = balance;
    localStorage.setItem('pd_user_m', JSON.stringify(user));
    UI.balance.innerText = `${balance.toFixed(2)} AZN`;
    UI.ingameBalance.innerText = `${balance.toFixed(2)} AZN`;
    
    if(balance <= 0 && gameState === 'PLAYING') {
        endGame(true);
    }
}

function startGame() {
    if(balance <= 0) {
        UI.block.classList.remove('hidden');
        return;
    }
    
    gameState = 'PLAYING';
    UI.menu.classList.add('hidden');
    UI.layer.classList.remove('hidden');
    canvas.style.display = 'block';
    
    resize();
    resetGame();
    requestAnimationFrame(gameLoop);
}

function resetGame() {
    score = 0;
    speed = 6;
    objects = [];
    playerLane = 1;
    isBraking = false;
    updateBalance(0); // Ekrandakƒ± r…ôq…ôml…ôri yenil…ô
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    laneWidth = canvas.width / 3;
    
    // Ekran √∂l√ß√ºs√ºn…ô g√∂r…ô ma≈üƒ±n √∂l√ß√ºs√ºn√º adaptasiya et
    carWidth = Math.min(50, laneWidth * 0.6);
    carHeight = carWidth * 1.8;
}
window.addEventListener('resize', resize);

// --- MOBƒ∞L ƒ∞DAR∆èETM∆è (TOUCH KONTROLLARI) ---
function handleMove(clientX) {
    if(gameState !== 'PLAYING') return;
    // Tormoz d√ºym…ôsin…ô basark…ôn zolaq d…ôyi≈üm…ôm…ôsi √º√ß√ºn yoxlanƒ±≈ü a≈üaƒüƒ±da edilir
    if(clientX < canvas.width / 2) {
        if(playerLane > 0) playerLane--;
    } else {
        if(playerLane < 2) playerLane++;
    }
}

// Ekrana toxunduqda (Mobild…ô)
window.addEventListener('touchstart', (e) => {
    // ∆èg…ôr toxunulan yer tormoz d√ºym…ôsidirs…ô, ma≈üƒ±n saƒüa-sola h…ôr…ôk…ôt etm…ôsin
    if(e.target.id === 'brake-btn' || e.target.closest('#brake-btn')) return;
    handleMove(e.touches[0].clientX);
}, {passive: false});

// Mouse il…ô klikl…ôdikd…ô (Komp√ºterd…ô test etm…ôk √º√ß√ºn)
window.addEventListener('mousedown', (e) => {
    if(e.target.id === 'brake-btn' || e.target.closest('#brake-btn')) return;
    handleMove(e.clientX);
});

// Tormoz d√ºym…ôsi √º√ß√ºn event-l…ôr (H…ôm touch, h…ôm mouse √º√ß√ºn)
const brakeBtn = document.getElementById('brake-btn');
const activateBrake = (e) => { e.preventDefault(); isBraking = true; };
const deactivateBrake = (e) => { e.preventDefault(); isBraking = false; };

brakeBtn.addEventListener('touchstart', activateBrake, {passive: false});
brakeBtn.addEventListener('touchend', deactivateBrake);
brakeBtn.addEventListener('mousedown', activateBrake);
window.addEventListener('mouseup', () => { isBraking = false; });
// --------------------------------------------

function gameLoop() {
    if(gameState !== 'PLAYING') return;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawRoad();
    
    let currentSpeed = isBraking ? speed * 0.3 : speed; // Tormoz s√ºr…ôti 0 etmir, yava≈üladƒ±r
    if(!isBraking) speed += 0.002; 

    if(Math.random() < 0.025 && !isBraking) spawnObject();
    
    updateObjects(currentSpeed);
    drawPlayer();
    
    score += (currentSpeed / 20);
    document.getElementById('ingame-score').innerText = Math.floor(score);
    
    requestAnimationFrame(gameLoop);
}

function drawRoad() {
    ctx.strokeStyle = "rgba(255,255,255,0.15)";
    ctx.lineWidth = 4;
    ctx.setLineDash([30, 30]);
    // Cizgil…ôrin h…ôr…ôk…ôt effekti
    ctx.lineDashOffset = -(score * 20) % 60; 
    ctx.beginPath();
    ctx.moveTo(laneWidth, 0); ctx.lineTo(laneWidth, canvas.height);
    ctx.moveTo(laneWidth*2, 0); ctx.lineTo(laneWidth*2, canvas.height);
    ctx.stroke();
}

function drawPlayer() {
    const x = playerLane * laneWidth + (laneWidth/2) - (carWidth/2);
    // Mobild…ô ma≈üƒ±nƒ± ekranƒ±n biraz daha a≈üaƒüƒ±sƒ±nda saxlayƒ±rƒ±q ki, barmaq mane olmasƒ±n
    const y = canvas.height - (carHeight + 160); 
    
    ctx.fillStyle = "#22d3ee";
    ctx.shadowBlur = 20;
    ctx.shadowColor = "#22d3ee";
    
    if (ctx.roundRect) {
        ctx.beginPath();
        ctx.roundRect(x, y, carWidth, carHeight, 8);
        ctx.fill();
    } else {
        ctx.fillRect(x, y, carWidth, carHeight);
    }
    ctx.shadowBlur = 0;

    // Tormoz effekti (Arxa i≈üƒ±qlar)
    if(isBraking) {
        ctx.fillStyle = "#ff0000";
        ctx.shadowBlur = 15;
        ctx.shadowColor = "#ff0000";
        ctx.fillRect(x + 5, y + carHeight - 10, 10, 5);
        ctx.fillRect(x + carWidth - 15, y + carHeight - 10, 10, 5);
        ctx.shadowBlur = 0;
    }
}

function spawnObject() {
    const types = ['CAR', 'LIGHT'];
    const type = types[Math.floor(Math.random() * types.length)];
    const objWidth = carWidth * 0.9;
    objects.push({
        x: Math.floor(Math.random() * 3) * laneWidth + (laneWidth/2) - (objWidth/2),
        y: -100,
        width: objWidth,
        height: carHeight * 0.9,
        type: type,
        passed: false
    });
}

function updateObjects(s) {
    objects.forEach((obj, index) => {
        obj.y += s;
        
        if(obj.type === 'CAR') ctx.fillStyle = "#f43f5e";
        if(obj.type === 'LIGHT') ctx.fillStyle = "#10b981";
        
        if (ctx.roundRect) {
            ctx.beginPath();
            ctx.roundRect(obj.x, obj.y, obj.width, obj.height, 8);
            ctx.fill();
        } else {
            ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
        }
        
        // Sad…ôl…ô≈üdirilmi≈ü Toqqu≈üma M…ôntiqi (Hitbox)
        const playerX = playerLane * laneWidth + (laneWidth/2) - (carWidth/2);
        const playerY = canvas.height - (carHeight + 160);
        
        if(obj.y + obj.height > playerY + 10 && 
           obj.y < playerY + carHeight - 10 && 
           obj.x + obj.width > playerX + 10 && 
           obj.x < playerX + carWidth - 10) {
            handleCollision(obj, index);
        }
        
        if(obj.y > canvas.height) objects.splice(index, 1);
    });
}

function handleCollision(obj, index) {
    if(obj.type === 'CAR') {
        triggerShake();
        updateBalance(-0.15);
        objects.splice(index, 1);
        speakAI("Q…ôza! Balansdan √ßƒ±xƒ±ldƒ±.");
        speed = Math.max(4, speed - 2); // Q…ôza ed…ônd…ô s√ºr…ôt d√º≈ü√ºr
    }
    
    if(obj.type === 'LIGHT') {
        if(!isBraking) {
            updateBalance(0.25);
            speakAI("+0.25 AZN Qazandƒ±n!");
        } else {
            updateBalance(-0.10);
            speakAI("Tormoza basdƒ±ƒüƒ±n √º√ß√ºn qa√ßƒ±rdƒ±n!");
        }
        objects.splice(index, 1);
    }
}

function triggerShake() {
    if(navigator.vibrate) navigator.vibrate(200); // Mobild…ô telefonu titr…ôdir
    document.body.classList.add('shake');
    setTimeout(() => document.body.classList.remove('shake'), 400);
}

function speakAI(text) {
    const aiBox = UI.aiMsg;
    aiBox.querySelector('p').innerText = text;
    aiBox.style.opacity = 1;
    setTimeout(() => aiBox.style.opacity = 0, 2000);
}

function endGame(isBlocked = false) {
    gameState = 'MENU';
    canvas.style.display = 'none';
    UI.layer.classList.add('hidden');
    
    if(isBlocked) {
        UI.block.classList.remove('hidden');
    } else {
        UI.block.classList.add('hidden');
        showMenu();
    }
}

function showTopup() { alert("Simulyasiya: Balans artƒ±rma s…ôhif…ôsin…ô y√∂nl…ôndirilir..."); }
function dailyBonus() { alert("Simulyasiya: G√ºnd…ôlik bonus hesablandƒ±!"); }
</script>
</body>
</html>
