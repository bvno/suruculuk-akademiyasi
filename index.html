import React, { useState, useEffect, useRef, useCallback } from 'react';

// --- Types ---
type FeedbackType = 'success' | 'warning' | 'error';
type TrafficLightState = 'GREEN' | 'YELLOW' | 'RED';
type CarSkin = { id: string; name: string; color: string; price: number; owned: boolean };
type Biome = { name: string; ground: string; accent: string };
type SceneryObject = { id: number; x: number; y: number; size: number; color: string };
type TrafficCar = { id: number; x: number; y: number; width: number; height: number; color: string; crashed?: boolean };

// --- Constants ---
const LOGICAL_WIDTH = 400;
const LOGICAL_HEIGHT = 600;
const CAR_WIDTH = 48;
const CAR_HEIGHT = 86;
const PLAYER_Y = LOGICAL_HEIGHT - 130;
const LANES = [100, 200, 300];
const PAYMENT_URL = "https://buymeacoffee.com/surwin";

const MOTIVATIONAL_PHRASES: Record<string, string[]> = {
  az: ["M√∂ht…ô≈ü…ôm!", "S…ôn bir pe≈ü…ôkarsan!", "Yola davam!", "∆èla s√ºr√ºrs…ôn!", "Bel…ô davam et!", "Diqq…ôtli ol!", "S√ºkan arxasƒ±nda kalsan!"],
  en: ["Awesome!", "You're a pro!", "Keep going!", "Great driving!", "Stay focused!", "Master of the road!", "You got this!"],
  ru: ["–û—Ç–ª–∏—á–Ω–æ!", "–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª!", "–ü—Ä–æ–¥–æ–ª–∂–∞–π!", "–•–æ—Ä–æ—à–∞—è –µ–∑–¥–∞!", "–ë—É–¥—å –≤–Ω–∏–º–∞—Ç–µ–ª–µ–Ω!", "–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!", "–í–ø–µ—Ä—ë–¥!"]
};

const BIOMES: Biome[] = [
  { name: "City Streets", ground: "#0f172a", accent: "#334155" },
  { name: "Forest Road", ground: "#064e3b", accent: "#166534" },
  { name: "Canyon", ground: "#451a03", accent: "#92400e" }
];

const INITIAL_SKINS: CarSkin[] = [
  { id: 'classic', name: 'Classic Blue', color: '#3b82f6', price: 0, owned: true },
  { id: 'sport', name: 'Sport Red', color: '#ef4444', price: 5.0, owned: false },
  { id: 'taxi', name: 'Yellow Taxi', color: '#fbbf24', price: 8.0, owned: false },
  { id: 'noir', name: 'Premium Black', color: '#1e293b', price: 15.0, owned: false },
];

const LANGUAGES = [
  { code: 'az', name: 'Az…ôrbaycan', flag: 'üá¶üáø', currency: 'AZN', rate: 1 },
  { code: 'en', name: 'English', flag: 'üá¨üáß', currency: 'USD', rate: 0.59 },
  { code: 'ru', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫', currency: 'RUB', rate: 54.4 }
];

const TRANSLATIONS: Record<string, any> = {
  az: { balance: "Balans", brake: "TORMOZ", braking: "DAYANIR...", garage: "QARAJ", topUpHeading: "BALANSIN ARTIR", topUpText: "T…ôhl√ºk…ôsiz √∂d…ôni≈ü √º√ß√ºn a≈üaƒüƒ±dakƒ± d√ºym…ôy…ô ke√ßid edin.", payStripe: "Balansƒ± Artƒ±r (‚òï)", gameOver: "OYUN Bƒ∞TDƒ∞", balanceFinished: "Davam etm…ôk √º√ß√ºn balans artƒ±rƒ±n.", restart: "YENƒ∞D∆èN", langHeading: "Dƒ∞L SE√áƒ∞N", fine: "C∆èRƒ∞M∆è!", reward: "M√úKAFAT!", crash: "Q∆èZA!" },
  en: { balance: "Balance", brake: "BRAKE", braking: "BRAKING...", garage: "GARAGE", topUpHeading: "RECHARGE BALANCE", topUpText: "Follow the link below for secure payment.", payStripe: "Top Up Now (‚òï)", gameOver: "GAME OVER", balanceFinished: "Top up to continue.", restart: "RESTART", langHeading: "LANGUAGE", fine: "FINE!", reward: "REWARD!", crash: "CRASH!" },
  ru: { balance: "–ë–∞–ª–∞–Ω—Å", brake: "–¢–û–†–ú–û–ó", braking: "–°–¢–û–ü...", garage: "–ì–ê–†–ê–ñ", topUpHeading: "–ü–û–ü–û–õ–ù–ò–¢–¨ –ë–ê–õ–ê–ù–°", topUpText: "–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –æ–ø–ª–∞—Ç—ã –ø–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ –Ω–∏–∂–µ.", payStripe: "–ü–æ–ø–æ–ª–Ω–∏—Ç—å (‚òï)", gameOver: "–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê", balanceFinished: "–ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.", restart: "–ü–ï–†–ï–ó–ê–ü–£–°–ö", langHeading: "–Ø–ó–´–ö", fine: "–®–¢–†–ê–§!", reward: "–ù–ê–ì–†–ê–î–ê!", crash: "–ê–í–ê–†–ò–Ø!" }
};

// --- App Component ---
const App: React.FC = () => {
  const [balance, setBalance] = useState(0);
  const [lang, setLang] = useState('az');
  const [isGameOver, setIsGameOver] = useState(false);
  const [showTopUp, setShowTopUp] = useState(true);
  const [feedback, setFeedback] = useState<{text:string,type:FeedbackType}|null>(null);
  const [skins, setSkins] = useState<CarSkin[]>(INITIAL_SKINS);
  const [activeSkinId, setActiveSkinId] = useState('classic');
  const canvasRef = useRef<HTMLCanvasElement>(null);
  const isBrakingRef = useRef(false);

  const t = TRANSLATIONS[lang];
  const currentLangData = LANGUAGES.find(l=>l.code===lang)!;

  const triggerFeedback = (text: string, type: FeedbackType) => {
    setFeedback({text,type});
    setTimeout(()=>setFeedback(null),3000);
  };

  const switchLane = (dir:'L'|'R') => { /* lane logic placeholder */ };

  const resetGame = () => {
    if(balance<=0){ setShowTopUp(true); return; }
    setIsGameOver(false);
    triggerFeedback("Game Reset!", 'success');
  };

  const formatBalance = (val:number) => {
    const converted = val * currentLangData.rate;
    return `${converted.toLocaleString(lang,{minimumFractionDigits:2,maximumFractionDigits:2})} ${currentLangData.currency}`;
  };

  useEffect(()=>{
    if(balance>0) setShowTopUp(false);
  },[balance]);

  // --- Demo: Motivational Feedback every 25s ---
  useEffect(()=>{
    const interval = setInterval(()=>{
      if(balance>0 && Math.random()<0.3){
        const phrases = MOTIVATIONAL_PHRASES[lang] || MOTIVATIONAL_PHRASES['en'];
        const text = phrases[Math.floor(Math.random()*phrases.length)];
        triggerFeedback(text,'success');
      }
    },25000);
    return ()=>clearInterval(interval);
  },[balance,lang]);

  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-[#0f172a] text-white p-4">
      <div className="mb-4">
        <span className="font-bold">{t.balance}: </span>{formatBalance(balance)}
      </div>

      {/* Top-Up Modal */}
      {showTopUp && (
        <div className="p-6 bg-slate-900 rounded-xl border border-white/10 text-center mb-4">
          <h2 className="text-xl font-black mb-2">{t.topUpHeading}</h2>
          <p className="text-sm mb-4">{t.topUpText}</p>
          <button onClick={()=>window.open(PAYMENT_URL,'_blank')} className="bg-yellow-400 text-black font-bold px-6 py-3 rounded-xl mb-2">{t.payStripe}</button>
          <button onClick={()=>{setBalance(balance+5)}} className="bg-green-600 text-white font-bold px-6 py-2 rounded-xl mb-2">Demo +5 {currentLangData.currency}</button>
        </div>
      )}

      {/* Language Selection */}
      <div className="flex gap-2 mb-4">
        {LANGUAGES.map(l=>(
          <button key={l.code} onClick={()=>setLang(l.code)} className={`p-2 rounded-xl ${lang===l.code?'bg-cyan-600':'bg-slate-800'}`}>{l.flag}</button>
        ))}
      </div>

      {/* Canvas Placeholder */}
      <div className="w-[400px] h-[600px] bg-slate-800 rounded-2xl flex items-center justify-center mb-4">
        <canvas ref={canvasRef} width={LOGICAL_WIDTH} height={LOGICAL_HEIGHT} />
        {feedback && <div className="absolute bg-white/20 p-2 rounded-xl">{feedback.text}</div>}
      </div>

      {/* Controls */}
      <div className="flex gap-2">
        <button onMouseDown={()=>isBrakingRef.current=true} onMouseUp={()=>isBrakingRef.current=false} className="bg-red-600 px-6 py-3 rounded-xl">{isBrakingRef.current?t.braking:t.brake}</button>
        <button onClick={resetGame} className="bg-slate-800 px-6 py-3 rounded-xl">{t.restart}</button>
      </div>

      {isGameOver && <div className="mt-4 text-red-400 font-bold">{t.gameOver}</div>}
    </div>
  );
};

export default App;
