<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Premium Drive - Tam ƒ∞nteqrasiya</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        body { user-select: none; -webkit-user-select: none; touch-action: none; overflow: hidden; background-color: #020617; } 
        .hidden { display: none !important; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .neon-cyan { text-shadow: 0 0 10px rgba(34, 211, 238, 0.8); }
        .neon-emerald { text-shadow: 0 0 10px rgba(16, 185, 129, 0.8); }
        .neon-rose { text-shadow: 0 0 10px rgba(244, 63, 94, 0.8); }
        .neon-box-cyan { box-shadow: 0 0 20px rgba(34, 211, 238, 0.15); }
        .brake-shadow { box-shadow: 0 0 40px rgba(225, 29, 72, 0.6); }
        
        @keyframes floatUp {
            0% { transform: translate(-50%, 0) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -60px) scale(1.3); opacity: 0; }
        }
        .animate-float { animation: floatUp 1.2s ease-out forwards; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(34,211,238,0.3); border-radius: 10px; }
    </style>
</head>
<body class="text-white h-screen flex flex-col font-sans relative">

    <div id="loginScreen" class="h-screen flex items-center justify-center p-6 z-50 absolute inset-0 bg-[#020617]">
        <div class="glass-panel p-10 rounded-[32px] w-full max-w-sm text-center relative overflow-hidden">
            <div class="absolute -top-10 -left-10 w-32 h-32 bg-cyan-500/20 rounded-full blur-[40px]"></div>
            
            <h1 class="text-3xl font-black text-white italic mb-2 tracking-tighter neon-cyan">PREMIUM DRIVE</h1>
            <p class="text-slate-400 text-sm mb-6">M√ºk…ômm…ôl S√ºr√ºc√ºl√ºk Simulyasiyasƒ±</p>
            
            <div class="bg-[#0f172a] p-4 rounded-2xl mb-6 border border-white/5">
                <p class="text-[10px] text-cyan-400 uppercase tracking-widest mb-1">M√∂vcud Balansƒ±nƒ±z</p>
                <p id="loginBalanceText" class="text-2xl font-black text-white neon-cyan">0.30 AZN</p>
            </div>
            
            <button id="loginBtn" class="w-full py-4 bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 rounded-[24px] font-bold uppercase tracking-widest shadow-[0_0_15px_rgba(34,211,238,0.2)] active:scale-95 transition-all">
                Oyuna Ba≈üla
            </button>
        </div>
    </div>

    <div id="gameScreen" class="hidden h-screen flex flex-col relative overflow-hidden bg-[#020617]">
        
        <div class="p-4 flex flex-col gap-3 z-30 shrink-0">
            <div class="flex justify-between items-center">
                <div class="glass-panel p-2 px-4 rounded-[20px] flex items-center">
                    <div>
                        <p class="text-[9px] font-black text-cyan-400 uppercase tracking-widest mb-0.5 opacity-80">Balans</p>
                        <p id="balanceText" class="text-base font-black neon-cyan">0.30 AZN</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="withdrawBtn" class="w-10 h-10 bg-cyan-500/20 border border-cyan-500/50 text-cyan-400 rounded-xl flex items-center justify-center text-lg active:scale-95 transition-all">üí∏</button>
                    <button id="garageBtn" class="w-10 h-10 bg-indigo-500/20 border border-indigo-500/50 text-indigo-400 rounded-xl flex items-center justify-center text-lg active:scale-95 transition-all">üõí</button>
                    <button id="topupBtn" class="w-10 h-10 bg-[#FFDD00]/20 border border-[#FFDD00]/50 text-[#FFDD00] rounded-xl flex items-center justify-center text-lg active:scale-95 transition-all">‚òï</button>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <div class="flex gap-2">
                    <div class="glass-panel px-3 py-1.5 rounded-xl border-amber-500/30">
                        <p class="text-[9px] text-amber-400 uppercase font-bold">Level <span id="levelText" class="text-white text-xs">1</span></p>
                    </div>
                    <div class="glass-panel px-3 py-1.5 rounded-xl border-rose-500/30">
                        <p class="text-[9px] text-rose-400 uppercase font-bold">Combo <span id="comboText" class="text-white text-xs">x1.0</span></p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <p id="livesText" class="text-sm tracking-widest">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</p>
                    <div class="text-right">
                        <p class="text-[9px] text-emerald-400 font-bold uppercase">M…ôsaf…ô</p>
                        <p id="scoreText" class="text-sm font-black neon-emerald">0 M</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="px-4 z-30 mb-2 shrink-0">
            <div class="glass-panel border-blue-500/30 rounded-[20px] p-3 text-xs text-blue-100 flex items-center gap-3">
                <div class="w-7 h-7 rounded-full bg-blue-500/20 flex items-center justify-center border border-blue-500/40 shrink-0">
                    <span id="aiIcon" class="text-[10px]">ü§ñ</span>
                </div>
                <span id="aiTipText" class="truncate w-full italic font-light">S√ºni intellekt m…ôsl…ôh…ôti y√ºkl…ônir...</span>
            </div>
        </div>

        <div class="flex-1 w-full max-w-[400px] mx-auto relative glass-panel neon-box-cyan rounded-[40px] overflow-hidden z-10 flex shrink">
            <canvas id="gameCanvas" width="400" height="600" class="w-full h-full object-contain bg-[#0f172a]"></canvas>
            
            <div class="absolute inset-0 flex z-20">
                <div id="laneLeft" class="flex-1 active:bg-white/5 cursor-pointer"></div>
                <div id="laneRight" class="flex-1 active:bg-white/5 cursor-pointer"></div>
            </div>

            <div id="popupContainer" class="absolute inset-0 pointer-events-none z-30"></div>

            <div id="gameOverScreen" class="hidden absolute inset-0 bg-[#020617]/95 backdrop-blur-xl flex-col items-center justify-center p-8 text-center z-50">
                <div class="w-20 h-20 rounded-full bg-rose-500/20 flex items-center justify-center mb-4 blur-[2px] mx-auto">
                    <span class="text-4xl">‚ö†Ô∏è</span>
                </div>
                <h2 id="gameOverTitle" class="text-3xl font-black text-rose-500 mb-2 neon-rose tracking-wider">OYUN Bƒ∞TDƒ∞</h2>
                <p id="gameOverReason" class="text-slate-300 text-sm mb-6">M√ºflis oldunuz!</p>
                <div class="bg-[#0f172a] w-full p-4 rounded-2xl mb-6 border border-white/5">
                    <p class="text-xs text-slate-400">Yekun M…ôsaf…ô: <span id="finalScore" class="font-bold text-emerald-400">0 M</span></p>
                    <p class="text-xs text-slate-400 mt-1">G…ôldiyiniz Level: <span id="finalLevel" class="font-bold text-amber-400">1</span></p>
                </div>
                <button id="restartBtn" class="w-full py-4 bg-cyan-500/20 border border-cyan-500/50 text-cyan-300 rounded-[24px] font-bold uppercase tracking-widest active:scale-95 transition-all">Yenid…ôn C…ôhd Et</button>
            </div>
        </div>

        <div class="w-full max-w-[400px] mx-auto p-4 pb-6 shrink-0 z-40">
            <button id="brakeBtn" class="w-full py-6 rounded-[32px] text-3xl font-black tracking-widest transition-all bg-rose-600 border-4 border-rose-800 text-white brake-shadow active:bg-rose-700 active:scale-95 touch-manipulation">
                TORMOZ
            </button>
        </div>
    </div>

    <div id="dailyBonusModal" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-2xl flex items-center justify-center p-6 z-[100]">
        <div class="glass-panel p-8 rounded-[40px] text-center w-full max-w-sm">
            <h2 class="text-2xl font-black mb-2 neon-amber">G√ºnd…ôlik H…ôdiyy…ô!</h2>
            <p class="text-slate-300 text-sm mb-6">Oyuna h…ôr g√ºn daxil olaraq bonus qazanƒ±n.</p>
            <div class="text-5xl mb-6 animate-bounce">üéÅ</div>
            <button id="claimDailyBtn" class="w-full py-4 bg-[#FFDD00] text-black rounded-[24px] font-black shadow-[0_0_20px_rgba(255,221,0,0.3)] active:scale-95 transition-all text-lg">
                +1.00 AZN Al
            </button>
        </div>
    </div>

    <div id="garageModal" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-2xl flex flex-col items-center justify-center p-6 z-[100]">
        <div class="glass-panel p-6 rounded-[32px] w-full max-w-sm relative flex flex-col max-h-[90%]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black neon-cyan italic">QARAJ</h2>
            </div>
            <div id="garageList" class="flex-1 overflow-y-auto pr-2 space-y-4 custom-scrollbar"></div>
            <button id="closeGarageBtn" class="w-full mt-6 py-4 glass-panel rounded-[20px] text-slate-300 font-bold uppercase active:scale-95 transition-all">Baƒüla</button>
        </div>
    </div>

    <div id="withdrawModal" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-2xl flex items-center justify-center p-6 z-[100]">
        <div class="glass-panel p-8 rounded-[40px] text-center w-full max-w-sm">
            <h2 class="text-2xl font-black mb-2 neon-cyan">Naƒüdla≈üdƒ±r</h2>
            <p class="text-slate-400 text-xs mb-6">Balansƒ±nƒ±z minimum 30 AZN olduqda naƒüdla≈üdƒ±ra bil…ôrsiniz.</p>
            <p id="withdrawBalanceDisplay" class="text-2xl font-black text-cyan-400 neon-cyan mb-4">0.00 AZN</p>
            <form id="withdrawForm" action="BURA_Lƒ∞NKƒ∞_YAPI≈ûDIRACAQSINIZ" method="POST" class="flex flex-col gap-3">
                <input type="hidden" name="Balans" id="hiddenBalanceInput" value="">
                <input type="text" name="Ad_Soyad" placeholder="Ad Soyad" required class="p-3 rounded-xl bg-[#020617] border border-slate-700 text-white text-sm outline-none">
                <input type="text" name="Kart" placeholder="Kart N√∂mr…ôsi" required class="p-3 rounded-xl bg-[#020617] border border-slate-700 text-white text-sm outline-none">
                <p id="withdrawWarning" class="text-rose-500 text-xs font-bold hidden">Balans 30 AZN-d…ôn azdƒ±r.</p>
                <button type="submit" id="submitWithdrawBtn" class="w-full py-4 mt-2 bg-cyan-500/20 border border-cyan-500/50 text-cyan-400 rounded-[24px] font-bold uppercase active:scale-95 transition-all">Sorƒüu G√∂nd…ôr</button>
            </form>
            <button id="closeWithdrawBtn" class="text-slate-400 text-[12px] font-bold uppercase mt-6 active:text-white transition-all">Geri</button>
        </div>
    </div>

    <div id="topUpModal" class="hidden absolute inset-0 bg-[#020617]/90 backdrop-blur-2xl flex items-center justify-center p-6 z-[100]">
        <div class="glass-panel p-8 rounded-[40px] text-center w-full max-w-sm">
            <h2 class="text-2xl font-black mb-4 neon-emerald">Balansƒ± Artƒ±r</h2>
            <p class="text-slate-300 text-xs mb-6 text-left">buymeacoffee.com/surwin linkin…ô daxil olaraq minimum 2 USD √∂d…ôni≈ü etdikd…ô, v…ôsait balansƒ±nƒ±za …ôlav…ô olunacaq.</p>
            
            <button id="buyMeCoffeeBtn" class="w-full py-4 bg-[#FFDD00] text-black rounded-[24px] font-black mb-4 flex items-center justify-center gap-2 active:scale-95 transition-all">
                ‚òï √ñd…ôni≈ü Et
            </button>
            
            <button id="verifyPaymentBtn" class="w-full py-3 bg-emerald-500/10 text-emerald-400 rounded-[24px] font-bold mb-4 text-sm active:scale-95 transition-all">
                üîÑ √ñd…ôni≈üi Yoxla (+2 USD Demo)
            </button>

            <button id="closeTopUpBtn" class="text-slate-400 text-[12px] font-bold uppercase active:text-white transition-all">Baƒüla</button>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ==========================================
        // OYUN D∆èYƒ∞≈û∆èNL∆èRƒ∞ 
        // ==========================================
        const LOGICAL_WIDTH = 400; 
        const LOGICAL_HEIGHT = 600;
        const CAR_WIDTH = 48; 
        const CAR_HEIGHT = 86; 
        const PLAYER_Y = LOGICAL_HEIGHT - 130;
        
        // Zolaq M…ôrk…ôzl…ôri (Sol, Orta, Saƒü)
        const LANES = [100, 200, 300]; 
        let currentLaneIndex = 1; // 0=Sol, 1=Orta, 2=Saƒü

        const BIOMES = [
            { ground: '#020617', road: '#0f172a', curb: '#1e293b' }, // ≈û…ôh…ôr
            { ground: '#022c22', road: '#0f172a', curb: '#064e3b' }, // Me≈ü…ô
            { ground: '#291002', road: '#1c1917', curb: '#451a03' }  // Kanyon
        ];

        // Balansƒ± LocalStorage-d…ôn oxuyuruq
        let savedBalance = localStorage.getItem('premiumDriveBalance');
        let balance = savedBalance !== null ? parseFloat(savedBalance) : 0.30; 
        
        let isGameRunning = false; 
        let isBraking = false; 
        let isGameOver = false;
        
        let score = 0; 
        let trafficCars = []; 
        let currentBiome = 0; 
        let speedMultiplier = 0.5; // ƒ∞lk ba≈ülayanda yava≈ü olsun
        
        let lives = 3; 
        let level = 1; 
        let combo = 1.0; 
        let lastComboTime = 0;
        
        let gameState = { carX: LANES[1] - CAR_WIDTH / 2, targetX: LANES[1] - CAR_WIDTH / 2, linesOffset: 0 };
        let trafficLight = { active: false, y: -200, state: 'GREEN', timer: 0, passed: false };
        
        const canvas = document.getElementById('gameCanvas'); 
        const ctx = canvas.getContext('2d');

        // ==========================================
        // QARAJ V∆è Dƒ∞ZAYN BAZASI
        // ==========================================
        const CAR_SKINS = [
            { id: 'default', name: 'Neon Blue', color: '#0ea5e9', price: 0, owned: true },
            { id: 'sport', name: 'Sport Red', color: '#f43f5e', price: 5.00, owned: false },
            { id: 'taxi', name: 'City Taxi', color: '#facc15', price: 10.00, owned: false },
            { id: 'vip', name: 'VIP Stealth', color: '#0f172a', price: 25.00, owned: false }
        ];
        let activeSkinId = 'default';

        // ==========================================
        // UI YENƒ∞L∆èM∆è
        // ==========================================
        function updateUI() {
            localStorage.setItem('premiumDriveBalance', balance.toFixed(2));
            const formatted = `${balance.toFixed(2)} AZN`;
            
            document.getElementById('balanceText').innerText = formatted;
            document.getElementById('loginBalanceText').innerText = formatted;
            document.getElementById('garageBalanceText').innerText = formatted;
            document.getElementById('withdrawBalanceDisplay').innerText = formatted;
            document.getElementById('hiddenBalanceInput').value = formatted;
            
            document.getElementById('scoreText').innerText = `${Math.floor(score)} M`;
            document.getElementById('livesText').innerText = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(3 - lives);
            document.getElementById('levelText').innerText = level;
            document.getElementById('comboText').innerText = `x${combo.toFixed(1)}`;
            
            const submitBtn = document.getElementById('submitWithdrawBtn');
            const warning = document.getElementById('withdrawWarning');
            if (balance < 30) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                warning.classList.remove('hidden');
            } else {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                warning.classList.add('hidden');
            }
        }

        // Animasiyalƒ± U√ßan Yazƒ±lar (Popuplar)
        function createHtmlPopup(text, colorClass) {
            const container = document.getElementById('popupContainer');
            const el = document.createElement('div');
            el.className = `absolute left-1/2 top-1/2 font-black text-xl w-[300px] text-center drop-shadow-lg animate-float ${colorClass}`;
            el.innerText = text;
            container.appendChild(el);
            setTimeout(() => el.remove(), 1200);
        }

        // ==========================================
        // G√úND∆èLƒ∞K BONUS
        // ==========================================
        function checkDailyBonus() {
            const lastClaim = localStorage.getItem('dailyBonusTime');
            const now = Date.now();
            if (!lastClaim || now - parseInt(lastClaim) > 86400000) { // 24 saat
                document.getElementById('dailyBonusModal').classList.remove('hidden');
            }
        }
        document.getElementById('claimDailyBtn').addEventListener('click', () => {
            balance += 1.00; 
            localStorage.setItem('dailyBonusTime', Date.now());
            updateUI(); 
            document.getElementById('dailyBonusModal').classList.add('hidden');
            createHtmlPopup("+1.00 AZN G√ºnd…ôlik Bonus!", "text-amber-400");
        });

        // ==========================================
        // AUDIO V∆è S∆èSLƒ∞ AI
        // ==========================================
        let audioCtx = null; let engineOsc = null; let engineGain = null;
        
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            engineOsc = audioCtx.createOscillator(); engineGain = audioCtx.createGain();
            engineOsc.type = 'sawtooth'; engineOsc.frequency.setValueAtTime(40, audioCtx.currentTime);
            engineGain.gain.setValueAtTime(0.08, audioCtx.currentTime); 
            engineOsc.connect(engineGain); engineGain.connect(audioCtx.destination); engineOsc.start();
        }

        function playTone(freq, type, duration, vol = 0.1) {
            if (!audioCtx) return;
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime); 
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function playCrashSound() { playTone(150, 'sawtooth', 0.5, 0.4); setTimeout(() => playTone(50, 'square', 0.8, 0.4), 100); }
        function playSuccessSound() { playTone(660, 'sine', 0.1, 0.2); setTimeout(() => playTone(880, 'sine', 0.3, 0.2), 100); }
        function playWarningSound() { playTone(400, 'square', 0.2, 0.2); }

        function getSpeechData(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR'; // Az…ôrbaycan dili tapƒ±lmadƒ±qda …ôn yaxƒ±n alternativ
                utterance.rate = 1.1; 
                utterance.onstart = () => { document.getElementById("aiIcon").innerText = "üîä"; };
                utterance.onend = () => { document.getElementById("aiIcon").innerText = "ü§ñ"; };
                window.speechSynthesis.speak(utterance);
            }
        }

        const API_KEY = "Sƒ∞Zƒ∞N_API_A√áARINIZI_BURAYA_YAPI≈ûDIRIN"; 
        const genAI = new GoogleGenerativeAI(API_KEY);
        async function getDrivingAdvice(scenario) {
            const aiTipEl = document.getElementById("aiTipText");
            try {
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const prompt = `S…ôn oyunda s…ôsli k√∂m…ôk√ßis…ôn. Ssenari: ${scenario}. ≈û…ôn v…ô maksimum 5 s√∂zl√ºk cavab ver. Dil: Az…ôrbaycanca.`;
                const result = await model.generateContent(prompt);
                const text = await result.response.text();
                aiTipEl.innerText = text; 
                getSpeechData(text);
            } catch (error) { 
                console.error(error); 
                aiTipEl.innerText = scenario; // X…ôta olanda default m…ôtni yazsƒ±n
            }
        }

        // ==========================================
        // QARAJ (GARAGE) M∆èNTƒ∞Qƒ∞
        // ==========================================
        window.selectCar = (id) => { activeSkinId = id; playSuccessSound(); renderGarage(); };
        window.buyCar = (id) => {
            const car = CAR_SKINS.find(c => c.id === id);
            if (car && balance >= car.price) {
                balance -= car.price; car.owned = true; activeSkinId = id;
                playSuccessSound(); updateUI(); renderGarage(); getDrivingAdvice("Yeni ma≈üƒ±n xeyirli olsun!");
            }
        };

        function renderGarage() {
            const list = document.getElementById('garageList'); 
            list.innerHTML = '';
            CAR_SKINS.forEach(car => {
                const item = document.createElement('div'); 
                item.className = "glass-panel p-4 rounded-[20px] flex items-center justify-between";
                
                let btnHTML = '';
                if (car.owned) {
                    btnHTML = (activeSkinId === car.id) 
                        ? `<button disabled class="py-2 px-4 rounded-xl text-xs font-bold bg-cyan-500/10 text-cyan-500">Se√ßilib</button>` 
                        : `<button onclick="window.selectCar('${car.id}')" class="py-2 px-4 rounded-xl text-xs font-bold bg-cyan-500/20 text-cyan-300 active:scale-95">Se√ß</button>`;
                } else {
                    const pF = car.price.toFixed(2) + " AZN";
                    btnHTML = (balance >= car.price) 
                        ? `<button onclick="window.buyCar('${car.id}')" class="py-2 px-4 rounded-xl text-xs font-bold bg-emerald-500/20 text-emerald-400 active:scale-95">Al (${pF})</button>`
                        : `<button disabled class="py-2 px-4 rounded-xl text-xs font-bold bg-slate-800/50 text-slate-500">Al (${pF})</button>`;
                }
                
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center border border-white/10" style="background-color: ${car.color}">
                            <div class="w-6 h-8 bg-black/20 rounded-sm"></div>
                        </div>
                        <div>
                            <p class="font-bold text-sm text-white">${car.name}</p>
                            ${!car.owned ? `<p class="text-[10px] text-slate-400">${car.price.toFixed(2)} AZN</p>` : `<p class="text-[10px] text-emerald-400">Gained</p>`}
                        </div>
                    </div>
                    <div>${btnHTML}</div>
                `;
                list.appendChild(item);
            });
        }

        // ==========================================
        // OYUN M∆èNTƒ∞Qƒ∞ V∆è UPDATE
        // ==========================================
        function startGame() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            
            initAudio(); 
            isGameRunning = true; isGameOver = false;
            score = 0; lives = 3; level = 1; combo = 1.0; 
            speedMultiplier = 0.5; // T…ôdric…ôn artacaq
            
            currentLaneIndex = 1; // Ba≈ülanƒüƒ±cda orta zolaq
            gameState.targetX = LANES[currentLaneIndex] - CAR_WIDTH / 2;
            gameState.carX = gameState.targetX;
            
            trafficCars = []; trafficLight.active = false;
            
            updateUI(); requestAnimationFrame(gameLoop);
            getDrivingAdvice("Oyun ba≈üladƒ±, uƒüurlar!");
        }

        function gameOver(reason) {
            isGameOver = true;
            document.getElementById('gameOverScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = Math.floor(score) + " M";
            document.getElementById('finalLevel').innerText = level;
            
            if (reason === 'lives') document.getElementById('gameOverReason').innerText = "Ma≈üƒ±n yararsƒ±z haldadƒ±r (3 Q…ôza).";
            else if (reason === 'balance') document.getElementById('gameOverReason').innerText = "M√ºflis oldunuz! Balansƒ±nƒ±z bitdi.";

            if (engineGain) engineGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1);
        }

        function checkLevelUp() {
            let newLevel = Math.floor(score / 300) + 1; 
            if (newLevel > level) {
                level = newLevel;
                balance += level * 0.50; // Level m√ºkafatƒ±
                speedMultiplier = Math.min(1.5, 0.5 + (level * 0.1)); // S√ºr…ôti artƒ±rƒ±rƒ±q
                currentBiome = (level - 1) % 3; 
                
                playSuccessSound();
                createHtmlPopup(`LEVEL UP! +${(level*0.50).toFixed(2)} AZN`, "text-amber-400 text-3xl");
                updateUI();
            }
        }

        function spawnTrafficCar() {
            const lane = LANES[Math.floor(Math.random() * LANES.length)];
            const isSafe = trafficCars.every(c => Math.abs(c.x - (lane - CAR_WIDTH/2)) > 10 || c.y > 150);
            if (isSafe && !trafficLight.active) { 
                trafficCars.push({ x: lane - CAR_WIDTH / 2, y: -100, speed: Math.random() * 1.5 + 2, color: '#f43f5e' });
            }
        }

        function update() {
            if (!isGameRunning || isGameOver) return;
            const baseSpeed = isBraking ? 0 : 5 * speedMultiplier; 

            if (!isBraking) {
                score += (0.1 * speedMultiplier) * combo; 
                checkLevelUp();
            }

            gameState.linesOffset = (gameState.linesOffset + baseSpeed) % 80;
            // Zolaƒüa yum≈üaq ke√ßid (Smooth transition)
            gameState.carX += (gameState.targetX - gameState.carX) * 0.2;

            // Svetofor Sistemi
            if (!trafficLight.active && Math.random() < 0.0015 && score > 50) {
                trafficLight.active = true; trafficLight.y = -100; trafficLight.passed = false;
                trafficLight.timer = 250; trafficLight.state = 'GREEN';
            }

            if (trafficLight.active) {
                trafficLight.y += baseSpeed;
                trafficLight.timer--;

                if (trafficLight.timer === 150) {
                    trafficLight.state = 'YELLOW';
                    playWarningSound();
                    createHtmlPopup("SARI ƒ∞≈ûIQ - Dƒ∞QQ∆èT!", "text-amber-400"); 
                }
                if (trafficLight.timer === 80) trafficLight.state = 'RED';
                if (trafficLight.timer === 0) trafficLight.state = 'GREEN';

                if (trafficLight.y > PLAYER_Y + CAR_HEIGHT && !trafficLight.passed) {
                    trafficLight.passed = true;
                    if (trafficLight.state === 'RED' && !isBraking) {
                        // Qƒ±rmƒ±zƒ±da c…ôrim…ô
                        balance -= 0.20; combo = 1.0; 
                        playCrashSound();
                        createHtmlPopup("Qƒ±rmƒ±zƒ± i≈üƒ±qda ke√ßdiniz -0.20", "text-rose-500 text-sm");
                    } else if (trafficLight.state === 'GREEN') {
                        // Ya≈üƒ±lda m√ºkafat
                        balance += 0.50; combo = Math.min(3.0, combo + 0.5); 
                        playSuccessSound();
                        createHtmlPopup("M√ºk…ômm…ôl! +0.50 AZN", "text-emerald-400");
                    }
                    updateUI(); 
                    if (balance <= 0) { balance = 0; updateUI(); gameOver('balance'); return; }
                }
                if (trafficLight.y > LOGICAL_HEIGHT) trafficLight.active = false;
            }

            // D√º≈üm…ôn ma≈üƒ±nlar
            let trafficProbability = Math.min(0.025, 0.005 + (level * 0.002)); 
            if (Math.random() < trafficProbability && !isBraking && !trafficLight.active) spawnTrafficCar();

            for (let i = trafficCars.length - 1; i >= 0; i--) {
                let car = trafficCars[i];
                car.y += baseSpeed + (isBraking ? car.speed * 2 : car.speed - 2); 
                
                // Q…ôza Yoxlanƒ±≈üƒ±
                if (gameState.carX < car.x + CAR_WIDTH - 5 && gameState.carX + CAR_WIDTH - 5 > car.x && PLAYER_Y < car.y + CAR_HEIGHT - 5 && PLAYER_Y + CAR_HEIGHT - 5 > car.y) {
                    lives--; balance -= 1.00; combo = 1.0; 
                    playCrashSound(); trafficCars.splice(i, 1);
                    createHtmlPopup("Q∆èZA! -1 Can & -1.00 AZN", "text-rose-500");
                    updateUI(); 
                    if (lives <= 0) { gameOver('lives'); return; }
                    if (balance <= 0) { balance = 0; updateUI(); gameOver('balance'); return; }
                } else if (car.y > LOGICAL_HEIGHT) { trafficCars.splice(i, 1); }
            }

            // Motivasiya
            if (Date.now() - lastComboTime > 15000 && combo >= 2.0 && !isBraking) {
                lastComboTime = Date.now();
                const msgs = ["∆èla s√ºr√º≈ü!", "Pe≈ü…ôkar s√ºr√ºc√º!", "Davam et!"];
                createHtmlPopup(msgs[Math.floor(Math.random() * msgs.length)], "text-cyan-300");
            }

            if (engineGain && audioCtx) {
                engineOsc.frequency.setTargetAtTime(isBraking ? 30 : 40 * speedMultiplier, audioCtx.currentTime, 0.1);
                engineGain.gain.setTargetAtTime(isBraking ? 0.02 : Math.min(0.15, 0.08 * speedMultiplier), audioCtx.currentTime, 0.1);
            }
        }

        // ==========================================
        // R∆èSM (CANVAS DRAWING) - K√ñHN∆è Cƒ∞HAZLAR √ú√á√úN T∆èHL√úK∆èSƒ∞ZL∆è≈ûDƒ∞Rƒ∞LDƒ∞
        // ==========================================
        function drawRectSafely(ctx, x, y, width, height, color) {
            ctx.fillStyle = color;
            // RoundRect …ôv…ôzin…ô hamƒ± √º√ß√ºn i≈ül…ôy…ôn standart fillRect istifad…ô olunur
            ctx.fillRect(x, y, width, height);
        }

        function drawCar(x, y, color, isPlayer, braking) {
            ctx.save(); 
            ctx.shadowColor = 'rgba(0,0,0,0.5)'; ctx.shadowBlur = 10; ctx.shadowOffsetY = 5; 
            drawRectSafely(ctx, x, y, CAR_WIDTH, CAR_HEIGHT, color); // ∆èsas b…ôd…ôn
            ctx.shadowColor = 'transparent'; 
            
            drawRectSafely(ctx, x + 4, y + 15, CAR_WIDTH - 8, 18, '#020617'); // √ñn ≈ü√º≈ü…ô
            drawRectSafely(ctx, x + 6, y + CAR_HEIGHT - 25, CAR_WIDTH - 12, 12, '#020617'); // Arxa ≈ü√º≈ü…ô
            
            if (isPlayer && braking) { 
                drawRectSafely(ctx, x + 4, y + CAR_HEIGHT - 6, 12, 6, '#f43f5e'); // Stop ƒ∞≈üƒ±ƒüƒ±
                drawRectSafely(ctx, x + CAR_WIDTH - 16, y + CAR_HEIGHT - 6, 12, 6, '#f43f5e'); 
            } else if (!isPlayer) { 
                drawRectSafely(ctx, x + 8, y + 4, 6, 4, '#fef08a'); // Fara
                drawRectSafely(ctx, x + CAR_WIDTH - 14, y + 4, 6, 4, '#fef08a'); 
            }
            ctx.restore();
        }

        function draw() {
            if (!ctx) return; 
            const biome = BIOMES[currentBiome];
            
            // Arxa fon v…ô Yol
            drawRectSafely(ctx, 0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT, biome.ground);
            drawRectSafely(ctx, 50, 0, 10, LOGICAL_HEIGHT, biome.curb); 
            drawRectSafely(ctx, LOGICAL_WIDTH - 60, 0, 10, LOGICAL_HEIGHT, biome.curb);
            drawRectSafely(ctx, 60, 0, LOGICAL_WIDTH - 120, LOGICAL_HEIGHT, biome.road);

            // Cizgil…ôr
            ctx.setLineDash([30, 40]); ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 4; ctx.lineDashOffset = -gameState.linesOffset; 
            ctx.beginPath(); ctx.moveTo(150, 0); ctx.lineTo(150, LOGICAL_HEIGHT); ctx.moveTo(250, 0); ctx.lineTo(250, LOGICAL_HEIGHT); ctx.stroke();

            // Svetofor
            if (trafficLight.active) {
                drawRectSafely(ctx, 60, trafficLight.y, LOGICAL_WIDTH - 120, 8, 'rgba(255,255,255,0.8)'); // Stop x…ôtti
                drawRectSafely(ctx, LOGICAL_WIDTH - 45, trafficLight.y - 70, 26, 75, '#0f172a'); // ƒ∞≈üƒ±q Qutusu
                
                const drawLight = (yOff, color, active) => { 
                    ctx.save(); ctx.fillStyle = active ? color : '#1e293b'; 
                    ctx.beginPath(); ctx.arc(LOGICAL_WIDTH - 32, trafficLight.y - 70 + yOff, 8, 0, Math.PI*2); ctx.fill(); ctx.restore(); 
                };
                drawLight(16, '#f43f5e', trafficLight.state === 'RED'); 
                drawLight(38, '#facc15', trafficLight.state === 'YELLOW'); 
                drawLight(60, '#10b981', trafficLight.state === 'GREEN');
            }

            trafficCars.forEach(car => drawCar(car.x, car.y, car.color, false, false));
            drawCar(gameState.carX, PLAYER_Y, CAR_SKINS.find(c => c.id === activeSkinId).color, true, isBraking); 
        }

        function gameLoop() { update(); draw(); if (isGameRunning) requestAnimationFrame(gameLoop); }

        // ==========================================
        // ƒ∞DAR∆èETM∆è (KLƒ∞KL∆èR V∆è TOXUNU≈ûLAR)
        // ==========================================
        window.onload = () => { checkDailyBonus(); updateUI(); };
        
        document.getElementById('loginBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', startGame);

        // Modallarƒ±n A√ßƒ±lƒ±b-Baƒülanmasƒ±
        const toggleModal = (btnId, modalId, show) => { 
            const btn = document.getElementById(btnId); 
            if(btn) btn.addEventListener('click', () => { 
                document.getElementById(modalId).classList[show ? 'remove' : 'add']('hidden'); 
                updateUI(); 
                if(show && modalId==='garageModal') renderGarage(); 
            }); 
        };
        toggleModal('withdrawBtn', 'withdrawModal', true); toggleModal('closeWithdrawBtn', 'withdrawModal', false);
        toggleModal('garageBtn', 'garageModal', true); toggleModal('closeGarageBtn', 'garageModal', false);
        toggleModal('topupBtn', 'topUpModal', true); toggleModal('closeTopUpBtn', 'topUpModal', false);

        // Top-Up Y√∂nl…ôndirm…ôsi
        document.getElementById('buyMeCoffeeBtn').addEventListener('click', () => { window.open('https://buymeacoffee.com/surwin', '_blank'); });
        
        // √ñd…ôni≈ü Simulyasiyasƒ±
        document.getElementById('verifyPaymentBtn').addEventListener('click', (e) => {
            const btn = e.currentTarget; btn.innerText = "Yoxlanƒ±lƒ±r..."; btn.disabled = true;
            setTimeout(() => { 
                balance += 3.40; updateUI(); playSuccessSound(); 
                btn.innerText = "√ñd…ôni≈üi Yoxla (+2 USD Demo)"; btn.disabled = false;
                document.getElementById('topUpModal').classList.add('hidden'); 
            }, 2000);
        });

        // Tormoz D√ºym…ôsi
        const brakeBtn = document.getElementById('brakeBtn');
        const startBraking = (e) => { e.preventDefault(); isBraking = true; }; 
        const stopBraking = (e) => { e.preventDefault(); isBraking = false; };
        brakeBtn.addEventListener('mousedown', startBraking); brakeBtn.addEventListener('mouseup', stopBraking);
        brakeBtn.addEventListener('touchstart', startBraking, {passive: false}); brakeBtn.addEventListener('touchend', stopBraking, {passive: false});
        
        // D√ºz…ôldilmi≈ü Saƒü/Sol Zolaq ƒ∞dar…ôetm…ôsi
        const goLeft = (e) => { 
            e.preventDefault(); 
            if (currentLaneIndex > 0) { currentLaneIndex--; gameState.targetX = LANES[currentLaneIndex] - CAR_WIDTH/2; } 
        };
        const goRight = (e) => { 
            e.preventDefault(); 
            if (currentLaneIndex < 2) { currentLaneIndex++; gameState.targetX = LANES[currentLaneIndex] - CAR_WIDTH/2; } 
        };
        
        document.getElementById('laneLeft').addEventListener('mousedown', goLeft); 
        document.getElementById('laneLeft').addEventListener('touchstart', goLeft, {passive: false});
        document.getElementById('laneRight').addEventListener('mousedown', goRight); 
        document.getElementById('laneRight').addEventListener('touchstart', goRight, {passive: false});

    </script>
</body>
</html>
