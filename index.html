<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro S√ºr√ºc√º Simulyasiyasƒ±</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --dark: #121212;
            --gray: #2c3e50;
        }

        body {
            margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--dark); color: white; overflow: hidden;
            display: flex; flex-direction: column; height: 100vh;
        }

        .hidden { display: none !important; }

        /* Auth Screen */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .modal {
            background: #222; padding: 30px; border-radius: 15px;
            text-align: center; width: 350px; border: 1px solid var(--primary);
            box-shadow: 0 0 20px rgba(46, 204, 113, 0.2);
        }
        input {
            width: 80%; padding: 12px; margin: 10px 0; border-radius: 8px;
            border: 1px solid #444; background: #111; color: white; outline: none;
        }
        button {
            cursor: pointer; padding: 12px 20px; border-radius: 8px; border: none;
            font-weight: bold; transition: 0.3s; margin: 5px;
        }
        .btn-main { background: var(--primary); color: white; width: 85%; }
        .btn-main:hover { background: #27ae60; }

        /* UI Header */
        header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; background: #1a1a1a; border-bottom: 3px solid var(--primary);
        }
        .user-info { font-size: 1.1rem; }
        .balance-val { color: var(--primary); font-weight: bold; }

        /* Game Area */
        #game-container {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
            background: #222;
        }
        canvas {
            background: #333; border: 5px solid #444; border-radius: 10px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Traffic Light & Speed */
        #game-stats {
            position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.7);
            padding: 15px; border-radius: 10px; text-align: center;
        }
        .light-circle {
            width: 40px; height: 40px; border-radius: 50%; margin: 10px auto;
            border: 3px solid #555; transition: 0.3s;
        }
        .red { background: var(--danger); box-shadow: 0 0 20px var(--danger); }
        .yellow { background: var(--warning); box-shadow: 0 0 20px var(--warning); }
        .green { background: var(--primary); box-shadow: 0 0 20px var(--primary); }

        /* Chat System */
        #chat-box {
            position: fixed; bottom: 20px; right: 20px; width: 300px; height: 350px;
            background: white; color: #333; border-radius: 12px; display: flex;
            flex-direction: column; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #chat-head { background: #222; color: white; padding: 12px; font-weight: bold; }
        #chat-msgs { flex: 1; padding: 10px; overflow-y: auto; font-size: 0.9rem; display: flex; flex-direction: column; gap: 8px; }
        .msg-bot { background: #f1f1f1; padding: 8px; border-radius: 8px; align-self: flex-start; }
        .msg-user { background: var(--primary); color: white; padding: 8px; border-radius: 8px; align-self: flex-end; }
        .chat-input { display: flex; border-top: 1px solid #ddd; }
        .chat-input input { flex: 1; border: none; border-radius: 0; margin: 0; padding: 10px; background: white; color: #333; }
        
        #game-overlay-msg {
            position: absolute; background: rgba(0,0,0,0.8); padding: 20px;
            border-radius: 10px; text-align: center;
        }
    </style>
</head>
<body>

    <div id="auth-container" class="overlay">
        <div class="modal">
            <h2 style="color: var(--primary);">S√úR√úC√ú QEYDƒ∞YYATI</h2>
            <input type="text" id="username-in" placeholder="ƒ∞stifad…ô√ßi adƒ±">
            <input type="password" id="password-in" placeholder="≈ûifr…ô">
            <button class="btn-main" onclick="handleRegister()">Giri≈ü et</button>
            <p id="auth-error" style="color: var(--danger); font-size: 0.8rem;"></p>
        </div>
    </div>

    <header id="ui-header" class="hidden">
        <div class="user-info">
            üë§ <span id="user-name-display">...</span> | 
            üí∞ Balans: <span id="balance-display" class="balance-val">0.00</span> AZN
        </div>
        <div>
            <button onclick="addBalance()" style="background: var(--warning);">Balans artƒ±r (+5 AZN)</button>
            <button onclick="logout()" style="background: var(--danger); color: white;">√áƒ±xƒ±≈ü</button>
        </div>
    </header>

    <main id="game-container" class="hidden">
        <div id="game-stats">
            <div id="tl-circle" class="light-circle red"></div>
            <div id="speed-val">S√ºr…ôt: 0 km/saat</div>
        </div>

        <canvas id="roadCanvas"></canvas>

        <div id="game-overlay-msg">
            <h3 id="round-status">Hazƒ±rsƒ±nƒ±z?</h3>
            <p>H…ôr raund: 0.20 AZN</p>
            <button class="btn-main" onclick="startGame()">S√ºrm…ôy…ô Ba≈üla</button>
        </div>
    </main>

    <div id="chat-box" class="hidden">
        <div id="chat-head">ü§ñ Yol Polisi D…ôst…ôk</div>
        <div id="chat-msgs"></div>
        <div class="chat-input">
            <input type="text" id="chat-input-field" placeholder="Sual yazƒ±n...">
            <button onclick="sendChatMessage()" style="background: var(--primary); border-radius: 0;">OK</button>
        </div>
    </div>

    <script>
        /* --- JAVASCRIPT LOGIC --- */

        // 1. DATA & STATE
        let currentUser = localStorage.getItem('activeUser') || null;
        let balance = 0;
        let gameRunning = false;
        let currentLight = 'red';
        let speed = 0;
        let carPos = { x: 175, y: 480 };
        const canvas = document.getElementById('roadCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 400;
        canvas.height = 600;

        // 2. AUTH SYSTEM
        function handleRegister() {
            const user = document.getElementById('username-in').value;
            const pass = document.getElementById('password-in').value;

            if (user.length < 3) {
                document.getElementById('auth-error').innerText = "Ad …ôn azƒ± 3 h…ôrfd…ôn ibar…ôt olmalƒ±dƒ±r!";
                return;
            }

            localStorage.setItem('activeUser', user);
            if (!localStorage.getItem(`bal_${user}`)) {
                localStorage.setItem(`bal_${user}`, "10.00");
            }
            initApp();
        }

        function initApp() {
            currentUser = localStorage.getItem('activeUser');
            if (currentUser) {
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('ui-header').classList.remove('hidden');
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('chat-box').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = currentUser;
                refreshBalance();
                drawRoad();
                startTrafficCycle();
                addBotMsg("Xo≈ü g…ôlmisiniz! T…ôhl√ºk…ôsiz s√ºrm…ôyi unutmayƒ±n.");
            }
        }

        function logout() {
            localStorage.removeItem('activeUser');
            location.reload();
        }

        // 3. BALANCE SYSTEM
        function refreshBalance() {
            balance = parseFloat(localStorage.getItem(`bal_${currentUser}`));
            document.getElementById('balance-display').innerText = balance.toFixed(2);
        }

        function updateBalance(amount) {
            balance += amount;
            localStorage.setItem(`bal_${currentUser}`, balance.toFixed(2));
            refreshBalance();
        }

        function addBalance() {
            updateBalance(5.00);
            addBotMsg("Balansƒ±nƒ±z artƒ±rƒ±ldƒ±. ƒ∞ndi daha √ßox s√ºr…ô bil…ôrsiniz!");
        }

        // 4. TRAFFIC SYSTEM
        function startTrafficCycle() {
            const sequence = ['red', 'yellow', 'green', 'yellow'];
            let i = 0;
            setInterval(() => {
                currentLight = sequence[i];
                const circle = document.getElementById('tl-circle');
                circle.className = `light-circle ${currentLight}`;
                i = (i + 1) % sequence.length;
            }, 5000);
        }

        // 5. GAME ENGINE
        function drawRoad() {
            ctx.clearRect(0, 0, 400, 600);
            // Asphalt
            ctx.fillStyle = "#333";
            ctx.fillRect(50, 0, 300, 600);
            // Lines
            ctx.strokeStyle = "white";
            ctx.setLineDash([20, 20]);
            ctx.beginPath();
            ctx.moveTo(200, 0); ctx.lineTo(200, 600);
            ctx.stroke();
            // Car
            ctx.fillStyle = "red";
            ctx.shadowBlur = 10; ctx.shadowColor = "black";
            ctx.fillRect(carPos.x, carPos.y, 50, 90);
            ctx.shadowBlur = 0;
        }

        function startGame() {
            if (balance < 5) {
                alert("Oyun √º√ß√ºn minimum 5 AZN balans lazƒ±mdƒ±r!");
                return;
            }
            updateBalance(-0.20);
            gameRunning = true;
            document.getElementById('game-overlay-msg').classList.add('hidden');
            gameLoop();
        }

        function gameLoop() {
            if (!gameRunning) return;
            
            // Movement Logic
            if (keys['ArrowUp']) speed = Math.min(speed + 0.2, 5);
            else speed = Math.max(speed - 0.1, 0);

            if (keys['ArrowLeft']) carPos.x = Math.max(60, carPos.x - 3);
            if (keys['ArrowRight']) carPos.x = Math.min(290, carPos.x + 3);

            // Rule Check
            if (speed > 0.5 && currentLight === 'red') {
                updateBalance(-0.50);
                addBotMsg("‚ö†Ô∏è QAYDA POZUNTUSU: Qƒ±rmƒ±zƒ± i≈üƒ±qda h…ôr…ôk…ôt! -0.50 AZN");
                speed = 0; // Stop car on fine
            }

            document.getElementById('speed-val').innerText = `S√ºr…ôt: ${Math.round(speed * 20)} km/saat`;
            
            drawRoad();
            requestAnimationFrame(gameLoop);
        }

        const keys = {};
        window.onkeydown = (e) => keys[e.key] = true;
        window.onkeyup = (e) => keys[e.key] = false;

        // 6. AI CHAT LOGIC
        function addBotMsg(text) {
            const chatMsgs = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = 'msg-bot';
            div.innerText = text;
            chatMsgs.appendChild(div);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        }

        function sendChatMessage() {
            const inp = document.getElementById('chat-input-field');
            if (!inp.value) return;

            const chatMsgs = document.getElementById('chat-msgs');
            const div = document.createElement('div');
            div.className = 'msg-user';
            div.innerText = inp.value;
            chatMsgs.appendChild(div);

            const userText = inp.value.toLowerCase();
            setTimeout(() => {
                let reply = "Ba≈üa d√º≈üm…ôdim, lakin yollarda ehtiyatlƒ± olmaƒüƒ±nƒ±zƒ± t√∂vsiy…ô edir…ôm.";
                if (userText.includes("salam")) reply = "Salam! Siz…ô nec…ô k√∂m…ôk ed…ô bil…ôr…ôm?";
                if (userText.includes("balans")) reply = "Balansƒ±nƒ±zƒ± yuxarƒ±dakƒ± 'Balans artƒ±r' d√ºym…ôsi il…ô artƒ±ra bil…ôrsiniz.";
                if (userText.includes("c…ôrim…ô")) reply = "Qƒ±rmƒ±zƒ± i≈üƒ±qda ke√ßm…ôm…ôy…ô √ßalƒ±≈üƒ±n, yoxsa balansƒ±nƒ±z azalacaq.";
                addBotMsg(reply);
            }, 800);

            inp.value = "";
        }

        // Start motivation loop
        setInterval(() => {
            if(currentUser) {
                const quotes = ["S√ºkan arxasƒ±nda diqq…ôtli olun.", "Bu g√ºn √ßox yax≈üƒ± s√ºr√ºrs√ºn√ºz!", "Qaydalara riay…ôt etdiyiniz √º√ß√ºn t…ô≈ü…ôkk√ºrl…ôr."];
                addBotMsg(quotes[Math.floor(Math.random()*quotes.length)]);
            }
        }, 40000);

        // Run App on Load
        window.onload = initApp;

    </script>
</body>
</html>
