<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>YOL S√úR√úC√ú ¬∑ mobil simulyator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background: #0c1c26;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 6px;
            touch-action: pan-y; 
        }
        .game-mobile {
            max-width: 420px;
            width: 100%;
            background: linear-gradient(165deg, #162b33 0%, #1d3d48 100%);
            border-radius: 44px 44px 32px 32px;
            padding: 14px 12px 20px 12px;
            box-shadow: 0 25px 40px #00000080, inset 0 1px 3px #5f9ea0;
            border: 1px solid #40838c;
        }
        /* √ºst panel ‚Äî istifad…ô√ßi, balans, i≈üƒ±qfor */
        .top-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            background: #0e2a32e0;
            backdrop-filter: blur(5px);
            padding: 10px 14px;
            border-radius: 60px;
            margin-bottom: 12px;
            border: 1px solid #2f7a8c;
            box-shadow: inset 0 2px 5px #08212b;
        }
        .user-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1e4d5a;
            padding: 6px 16px 6px 12px;
            border-radius: 50px;
        }
        .avatar {
            background: #fedb9f;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #0c3340;
        }
        .username {
            font-weight: 700;
            color: #faf3d7;
            font-size: 1rem;
        }
        .logout {
            background: #2f4f5c;
            border: none;
            color: white;
            padding: 8px 18px;
            border-radius: 40px;
            font-size: 0.85rem;
            font-weight: 600;
            box-shadow: 0 4px 0 #142e36;
            transition: 0.05s linear;
            border: 1px solid #60a5b0;
        }
        .logout:active { transform: translateY(4px); box-shadow: none; }
        .balance-pill {
            background: #1b414b;
            border-radius: 40px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #f3b33d;
        }
        .balance-pill span:first-child {
            color: #ffd966;
            font-size: 0.8rem;
        }
        .balance-pill .value {
            font-size: 1.7rem;
            font-weight: 800;
            color: #fae467;
            line-height: 1;
        }
        .traffic-compact {
            background: #1b3e48;
            border-radius: 60px;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .traffic-light-mini {
            display: flex;
            gap: 6px;
            background: #232b2e;
            padding: 6px 12px;
            border-radius: 40px;
        }
        .led {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #3d3d3d;
            box-shadow: inset 0 0 6px black;
        }
        .led.red.active { background: #ff4444; box-shadow: 0 0 15px #ff7777; }
        .led.yellow.active { background: #ffe052; box-shadow: 0 0 15px #ffe682; }
        .led.green.active { background: #5aff7a; box-shadow: 0 0 15px #9bff9b; }
        .speed-mini {
            font-size: 1.8rem;
            font-weight: 800;
            color: #abdef0;
        }

        /* KANVAS ‚Äî OYUN SAH∆èSƒ∞ (real √∂l√ß√º, mobil…ôd…ôk) */
        .canvas-wrapper {
            background: #204c57;
            border-radius: 48px;
            padding: 8px;
            border: 4px solid #357b89;
            margin: 8px 0 10px 0;
            box-shadow: inset 0 0 0 2px #58b7c9;
        }
        canvas {
            display: block;
            width: 100%;
            height: auto;
            background: #194f5c;
            border-radius: 36px;
            touch-action: none;  /* s…ôhif…ô s√ºr√º≈üm…ôsinin qar≈üƒ±sƒ± */
            box-shadow: 0 0 0 2px #9ad4de4d;
        }

        /* N√ñQT∆èL∆èR: c…ôrim…ô / m√ºkafat paneli */
        .event-feed {
            background: #0c2933d9;
            border-radius: 30px;
            padding: 10px 18px;
            margin: 8px 0 12px 0;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            color: #f8e3b0;
            font-weight: 500;
            border-left: 10px solid #ffaa33;
            backdrop-filter: blur(2px);
        }
        .fine-msg { color: #ffb2a5; font-weight: 600; }
        .reward-msg { color: #aaffb0; }

        /* N∆èH∆èNG ƒ∞DAR∆è PANELI ‚Äî ∆èSAS YENƒ∞Lƒ∞K (TROMMOZ + QAZ + S√úKAN) */
        .drive-controls {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-top: 5px;
        }
        .pedals {
            display: flex;
            gap: 10px;
            justify-content: stretch;
        }
        .pedal-btn {
            flex: 1;
            background: #263e49;
            border: none;
            border-radius: 70px;
            padding: 22px 0;
            font-size: 2rem;
            font-weight: 800;
            color: white;
            box-shadow: 0 8px 0 #10232b, 0 10px 20px black;
            transition: 0.06s linear;
            border: 1px solid #609faf;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            touch-action: manipulation;
        }
        .pedal-btn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #10232b, 0 10px 18px black;
        }
        .pedal-btn.brake {
            background: #9f4a4a;
            border-color: #e08282;
        }
        .steering-row {
            display: flex;
            gap: 12px;
        }
        .steer-btn {
            background: #1f5160;
            border: none;
            border-radius: 60px;
            padding: 24px 0;
            font-size: 2.2rem;
            box-shadow: 0 8px 0 #0b2f39;
            flex: 1;
            color: white;
            border: 1px solid #77c2d4;
            touch-action: manipulation;
        }
        .steer-btn:active { transform: translateY(6px); box-shadow: 0 2px 0 #0b2f39; }
        .start-stop-row {
            display: flex;
            gap: 15px;
            margin: 5px 0 12px 0;
        }
        .start-btn {
            background: #239954;
            border: none;
            border-radius: 80px;
            padding: 20px 0;
            font-weight: 700;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 8px 0 #166b39;
            flex: 2;
            border: 1px solid #70d794;
        }
        .add-balance-btn {
            background: #e2a526;
            border: none;
            border-radius: 80px;
            padding: 20px 0;
            font-weight: 700;
            font-size: 1.2rem;
            color: #201e1a;
            box-shadow: 0 8px 0 #9e741b;
            flex: 1;
            border: 1px solid #ffd966;
        }
        .start-btn:active, .add-balance-btn:active { transform: translateY(6px); box-shadow: none; }

        /* CHAT mobil uyƒüun */
        .chat-section {
            background: #0a242e;
            border-radius: 40px;
            padding: 15px;
            margin-top: 18px;
            border: 1px solid #479fb3;
        }
        .chat-messages {
            max-height: 130px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
            padding-right: 6px;
        }
        .chat-bubble {
            background: #1e4f5e;
            padding: 12px 16px;
            border-radius: 24px 24px 24px 8px;
            max-width: 85%;
            color: #f0f9ff;
            font-size: 0.9rem;
        }
        .chat-bubble.user {
            background: #316d7e;
            align-self: flex-end;
            border-radius: 24px 24px 8px 24px;
        }
        .chat-control {
            display: flex;
            gap: 8px;
        }
        .chat-control input {
            flex: 1;
            background: #08333f;
            border: 2px solid #258097;
            border-radius: 50px;
            padding: 14px 18px;
            color: white;
            font-size: 1rem;
        }
        .chat-control button {
            background: #3d94b3;
            border: none;
            border-radius: 60px;
            width: 70px;
            font-size: 1.8rem;
            color: white;
            box-shadow: 0 5px 0 #1f5568;
        }
        .chat-control button:active { transform: translateY(4px); box-shadow: none; }
        .small-note { color: #9bccda; font-size: 0.7rem; margin: 8px; text-align: center; }
    </style>
</head>
<body>
<div class="game-mobile" id="mobileContainer"></div>

<script>
    // ====================== auth.js ============================
    (function(){
        const STORAGE_KEYS = {
            USER: 'trafficSim_user',
            BALANCE: 'trafficSim_balance',
            CREDENTIALS: 'trafficSim_cred'
        };
        window.auth = {
            getCurrentUser: () => JSON.parse(localStorage.getItem(STORAGE_KEYS.USER)) || null,
            saveUser: (user) => localStorage.setItem(STORAGE_KEYS.USER, JSON.stringify(user)),
            logout: () => { localStorage.removeItem(STORAGE_KEYS.USER); location.reload(); },
            registerOrLogin: (username, password) => {
                let creds = JSON.parse(localStorage.getItem(STORAGE_KEYS.CREDENTIALS)) || {};
                if (creds[username] && creds[username] !== password) return false;
                if (!creds[username]) creds[username] = password;
                localStorage.setItem(STORAGE_KEYS.CREDENTIALS, JSON.stringify(creds));
                const user = { username, loggedIn: true };
                auth.saveUser(user);
                let bal = window.balance?.getBalance() ?? 10;
                if (!localStorage.getItem(STORAGE_KEYS.BALANCE)) bal = 10;
                window.balance?.setBalance(bal);
                return true;
            },
            autoLogin: () => {
                if (auth.getCurrentUser()) return true;
                const creds = JSON.parse(localStorage.getItem(STORAGE_KEYS.CREDENTIALS)) || {};
                const firstUser = Object.keys(creds)[0];
                if (firstUser) {
                    auth.saveUser({ username: firstUser, loggedIn: true });
                    return true;
                }
                return false;
            }
        };
    })();

    // ====================== balance.js =========================
    (function(){
        const BALANCE_KEY = 'trafficSim_balance';
        window.balance = {
            getBalance: () => parseFloat(localStorage.getItem(BALANCE_KEY)) || 10,
            setBalance: (val) => { localStorage.setItem(BALANCE_KEY, Math.max(0, val).toFixed(2)); },
            addFunds: (amount) => { let b = window.balance.getBalance() + amount; window.balance.setBalance(b); },
            deduct: (amount) => { let b = window.balance.getBalance() - amount; window.balance.setBalance(b); return b; },
            canStartGame: () => window.balance.getBalance() >= 5
        };
        if (!localStorage.getItem(BALANCE_KEY)) window.balance.setBalance(10);
    })();

    // ====================== chat.js ============================
    (function(){
        const azChatReplies = [
            "S…ôn …ôla s√ºr√ºc√ºs…ôn! üòä", "Yolda diqq…ôtli ol, dostum!", "ƒ∞≈üƒ±qforda qaydaya …ôm…ôl et üö¶",
            "Balansƒ±nƒ± artƒ±rmaƒüƒ± unutma", "S√ºr…ôtin g√∂z…ôl, amma t…ôhl√ºk…ôsizlik √∂nd…ôdir",
            "Piyada ke√ßidin…ô yaxƒ±nla≈üƒ±rsan", "Ma≈üƒ±nƒ±na qulluq et, o da s…ôni aparsƒ±n",
            "Yol h…ôr…ôk…ôti qaydalarƒ± can qurtarƒ±r", "S…ôn…ô uƒüurlar! M…ôn s…ônin k√∂m…ôk√ßin…ôm ü§ñ",
            "Yava≈üla, radar ola bil…ôr üòâ", "G√∂z…ôl s√ºr√º≈ü, min balans artƒ±mƒ±!"
        ];
        let intervalId = null;
        window.chatAI = {
            init: (containerId, username) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                const messagesDiv = document.createElement('div');
                messagesDiv.className = 'chat-messages';
                messagesDiv.id = 'chatMessages';
                const inputDiv = document.createElement('div');
                inputDiv.className = 'chat-control';
                inputDiv.innerHTML = `<input type="text" id="chatInput" placeholder="Sualƒ±n?" autocomplete="off"><button id="chatSendBtn">‚û§</button>`;
                container.appendChild(messagesDiv);
                container.appendChild(inputDiv);

                const addMessage = (text, isUser = false) => {
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `chat-bubble ${isUser ? 'user' : ''}`;
                    msgDiv.innerText = text;
                    messagesDiv.appendChild(msgDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                };

                if (intervalId) clearInterval(intervalId);
                intervalId = setInterval(() => {
                    if (document.hidden) return;
                    addMessage(azChatReplies[Math.floor(Math.random() * azChatReplies.length)]);
                }, 13000);

                setTimeout(() => addMessage(`Salam ${username || 'S√ºr√ºc√º'}! M…ôn s…ônin k√∂m…ôk√ßin…ôm. Sual ver…ô bil…ôrs…ôn üòä`), 500);

                document.getElementById('chatSendBtn').addEventListener('click', () => {
                    const inp = document.getElementById('chatInput');
                    if (!inp.value.trim()) return;
                    addMessage(inp.value, true);
                    const q = inp.value.toLowerCase();
                    inp.value = '';
                    setTimeout(() => {
                        if (q.includes('balans') || q.includes('pul')) addMessage('Balans artƒ±rmaq √º√ß√ºn "Balans artƒ±r" d√ºym…ôsind…ôn istifad…ô et.');
                        else if (q.includes('oyun') || q.includes('ba≈üla')) addMessage('"OYUNA BA≈ûLA" d√ºym…ôsi il…ô ba≈üla. 5 AZN t…ôl…ôb olunur.');
                        else if (q.includes('c…ôrim…ô')) addMessage('Qƒ±rmƒ±zƒ± i≈üƒ±q, h…ôddind…ôn artƒ±q s√ºr…ôt v…ô toqqu≈üma c…ôrim…ô g…ôtir…ôr!');
                        else addMessage(azChatReplies[Math.floor(Math.random() * azChatReplies.length)]);
                    }, 400);
                });
            },
            destroy: () => { if (intervalId) clearInterval(intervalId); }
        };
    })();

    // ====================== game.js (yenid…ôn i≈ül…ônmi≈ü, TORMOZ ∆èLAV∆è) ===
    (function(){
        window.game = {
            canvas: null, ctx: null, anim: null,
            trafficState: { light: 'red', phase: 0, lastChange: 0 },
            player: { x: 180, y: 380, speed: 0, maxSpeed: 7, width: 40, height: 70 },
            obstacles: [],
            roadOffset: 0,
            gameActive: false,
            fineMessage: '', rewardMessage: '',
            currentSpeed: 0,
            violationCooldown: 0,
            brakePressed: false,   // yeni: tormoz basƒ±lƒ±b?

            start: (canvasId) => {
                if (!window.balance.canStartGame()) {
                    window.mobileUI.updateNotification('Balans az! Minimum 5 AZN t…ôl…ôb olunur', 'error');
                    return false;
                }
                window.balance.deduct(0.20);
                window.game.gameActive = true;
                window.game.canvas = document.getElementById(canvasId);
                window.game.ctx = window.game.canvas.getContext('2d');
                window.game.resetLevel();
                window.game.lastPhaseChange = performance.now();
                window.game.gameLoop();
                return true;
            },
            resetLevel: () => {
                window.game.player = { x: 180, y: 380, speed: 2, maxSpeed: 7, width: 40, height: 70 };
                window.game.obstacles = [];
                for (let i=0; i<3; i++) {
                    window.game.obstacles.push({ x: 70 + i*130, y: -150 - i*200, width: 45, height: 80 });
                }
                window.game.currentSpeed = 0;
                window.game.fineMessage = '';
                window.game.brakePressed = false;
            },
            gameLoop: (timestamp) => {
                if (!window.game.gameActive) return;
                window.game.update(timestamp);
                window.game.draw();
                window.game.anim = requestAnimationFrame(window.game.gameLoop);
            },
            update: (timestamp) => {
                // i≈üƒ±qford√∂vr√º 5 saniy…ô
                if (!window.game.lastPhaseChange) window.game.lastPhaseChange = timestamp;
                const elapsed = (timestamp - window.game.lastPhaseChange) / 1000;
                if (elapsed > 5) {
                    window.game.trafficState.phase = (window.game.trafficState.phase + 1) % 4;
                    const phases = ['red','yellow','green','yellow'];
                    window.game.trafficState.light = phases[window.game.trafficState.phase];
                    window.game.lastPhaseChange = timestamp;
                    document.querySelectorAll('.led').forEach((l,idx) => {
                        l.classList.remove('active');
                        if (window.game.trafficState.light === 'red' && idx===0) l.classList.add('active');
                        if (window.game.trafficState.light === 'yellow' && idx===1) l.classList.add('active');
                        if (window.game.trafficState.light === 'green' && idx===2) l.classList.add('active');
                    });
                }

                // TORMOZ FUNKSƒ∞YASI: brakePressed = s√ºr…ôt azalƒ±r (enm…ô s√ºr…ôti)
                if (window.game.gameActive) {
                    if (window.game.brakePressed) {
                        window.game.player.speed = Math.max(0, window.game.player.speed - 0.25);
                    }
                    // h…ôm√ßinin qaz artƒ±rma (yuxarƒ± ox v…ô ya QAZ d√ºym…ôsi il…ô) ‚Äî ayrƒ± idar…ô
                    window.game.currentSpeed = window.game.player.speed * 12; // km/h
                }

                // mane…ôl…ôri h…ôr…ôk…ôt et
                for (let obs of window.game.obstacles) {
                    obs.y += window.game.player.speed * 1.2;
                }
                window.game.obstacles = window.game.obstacles.filter(o => o.y < 700);
                while (window.game.obstacles.length < 4) {
                    window.game.obstacles.push({ x: 40 + Math.random() * 280, y: -200, width: 45, height: 80 });
                }

                // pozuntu yoxlamasƒ± (tormoz i≈ü…ô d√º≈ü…ônd…ô dayana bilirik)
                if (window.game.violationCooldown <= 0) {
                    // QIRMIZI ƒ∞≈ûIQDA dayanma yoxlanƒ±≈üƒ±: …ôg…ôr s√ºr…ôt 0.5-d…ôn az deyils…ô v…ô qƒ±rmƒ±zƒ±dƒ±rsa v…ô ma≈üƒ±n x…ôtt…ô yaxƒ±ndƒ±rsa c…ôrim…ô
                    if (window.game.trafficState.light === 'red' && window.game.player.y < 200 && window.game.player.speed > 0.8) {
                        window.balance.deduct(1.8);
                        window.game.fineMessage = 'QIRMIZI ƒ∞≈ûIQ! 1.8 AZN c…ôrim…ô';
                        window.game.violationCooldown = 30;
                    }
                    // toqqu≈üma
                    for (let obs of window.game.obstacles) {
                        if (Math.abs(obs.y - window.game.player.y) < 50 && Math.abs(obs.x - window.game.player.x) < 55) {
                            window.balance.deduct(2.5);
                            window.game.fineMessage = 'TOQQU≈ûMA! 2.5 AZN c…ôrim…ô';
                            window.game.violationCooldown = 30;
                            break;
                        }
                    }
                    if (window.game.currentSpeed > 70 && Math.random()<0.03) {
                        window.balance.deduct(1.2);
                        window.game.fineMessage = 'S√úR∆èT H∆èDDƒ∞ 1.2 AZN';
                        window.game.violationCooldown = 20;
                    }
                    // ya≈üƒ±l i≈üƒ±qda m√ºkafat
                    if (window.game.trafficState.light === 'green' && window.game.player.speed > 2 && Math.random()<0.01) {
                        window.balance.addFunds(0.4);
                        window.game.rewardMessage = '+0.4 AZN qaydalƒ± s√ºr√º≈ü';
                    }
                } else {
                    window.game.violationCooldown--;
                }

                document.getElementById('speedValue') && (document.getElementById('speedValue').innerText = Math.floor(window.game.currentSpeed));
                window.mobileUI?.updateBalanceDisplay();
            },
            draw: () => {
                const ctx = window.game.ctx, canvas = window.game.canvas;
                ctx.clearRect(0,0,canvas.width,canvas.height);
                // yol fon
                ctx.fillStyle = '#1b5463';
                ctx.fillRect(0,0,canvas.width,canvas.height);
                // yol x…ôtti
                ctx.strokeStyle = '#e2e2e2';
                ctx.lineWidth = 4;
                ctx.setLineDash([20,25]);
                ctx.beginPath();
                ctx.moveTo(canvas.width/2,0);
                ctx.lineTo(canvas.width/2,canvas.height);
                ctx.stroke();
                ctx.setLineDash([]);
                for (let i=0;i<canvas.height;i+=45) {
                    ctx.fillStyle = '#e0e0e0';
                    ctx.fillRect(canvas.width/2-12, (i+window.game.roadOffset)%canvas.height, 24, 28);
                }
                window.game.roadOffset += window.game.player.speed;

                // i≈üƒ±for sad…ô (solda)
                ctx.fillStyle = '#191919';
                ctx.fillRect(20,30,35,110);
                const cols = ['red','yellow','green'];
                cols.forEach((c,idx) => {
                    ctx.beginPath();
                    ctx.arc(37, 50+idx*30, 12, 0, 2*Math.PI);
                    ctx.fillStyle = window.game.trafficState.light === c ? (c==='red'?'#f33':c==='yellow'?'#fd3':'#6f6') : '#444';
                    ctx.fill();
                });

                // ma≈üƒ±n (oyun√ßu)
                ctx.fillStyle = '#3d9ed7';
                ctx.shadowBlur = 16; ctx.shadowColor = '#ade1ff';
                ctx.fillRect(window.game.player.x-20, window.game.player.y-30, 40, 70);
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(window.game.player.x-12, window.game.player.y+25, 8, 0, 2*Math.PI);
                ctx.arc(window.game.player.x+12, window.game.player.y+25, 8, 0, 2*Math.PI);
                ctx.fill();
                ctx.shadowBlur = 0;
                // mane…ôl…ôr
                ctx.fillStyle = '#b83a3a';
                for (let o of window.game.obstacles) {
                    ctx.fillRect(o.x-20, o.y-30, 40, 80);
                }
                if (window.game.fineMessage) {
                    ctx.font = 'bold 19px sans-serif'; ctx.fillStyle = '#ff9580';
                    ctx.fillText(window.game.fineMessage, 90, 80);
                }
            },
            stop: () => { window.game.gameActive = false; if(window.game.anim)cancelAnimationFrame(window.game.anim); },
            setBrake: (state) => { window.game.brakePressed = state; } // tormoz basƒ±lƒ±b saxlanƒ±lƒ±r
        };
    })();

    // ============= mobilUI tam konstruksiya =============
    window.mobileUI = {
        updateBalanceDisplay: () => {
            const el = document.getElementById('balanceDisplay');
            if (el) el.innerText = window.balance.getBalance().toFixed(2);
        },
        updateNotification: (msg) => {
            const feed = document.getElementById('feedGeneral');
            if (feed) feed.innerText = msg;
        },
        init: () => {
            const container = document.getElementById('mobileContainer');
            if (!window.auth.autoLogin()) {
                container.innerHTML = `<div style="background:#16363f; padding:30px; border-radius:60px;">
                    <h2 style="color:white;">Qeydiyyat</h2>
                    <input type="text" id="regUsername" placeholder="ƒ∞stifad…ô√ßi adƒ±" style="width:100%; padding:18px; margin:15px 0; border-radius:60px;">
                    <input type="password" id="regPassword" placeholder="≈ûifr…ô" style="width:100%; padding:18px; margin:15px 0; border-radius:60px;">
                    <button id="regBtn" style="background:#239954; padding:20px; width:100%; border-radius:60px;">DAXƒ∞L OL</button>
                </div>`;
                document.getElementById('regBtn').onclick = () => {
                    const u = document.getElementById('regUsername').value.trim();
                    const p = document.getElementById('regPassword').value.trim();
                    if (u && p && window.auth.registerOrLogin(u, p)) location.reload();
                    else alert('≈ûifr…ô yanlƒ±≈ü');
                };
                return;
            }
            const user = window.auth.getCurrentUser();
            const bal = window.balance.getBalance();
            container.innerHTML = `
            <div class="top-bar">
                <div class="user-badge"><span class="avatar">${user.username[0]}</span><span class="username">${user.username}</span></div>
                <button class="logout" id="logoutBtn">√áƒ±xƒ±≈ü</button>
                <div class="balance-pill"><span>AZN</span><span class="value" id="balanceDisplay">${bal.toFixed(2)}</span></div>
            </div>
            <div style="display: flex; justify-content: space-between; align-items:center; margin:4px 0 8px;">
                <div class="traffic-compact"><div class="traffic-light-mini" id="trafficLights"><div class="led red active"></div><div class="led yellow"></div><div class="led green"></div></div><span class="speed-mini" id="speedValue">0</span></div>
                <button class="add-balance-btn" id="addMoneyBtn" style="padding:12px 24px; width:auto;">+5 AZN</button>
            </div>
            <div class="canvas-wrapper"><canvas id="gameCanvas" width="360" height="500"></canvas></div>
            <div class="event-feed"><span id="fineMessage" class="fine-msg"></span><span id="rewardMessage" class="reward-msg"></span><span id="feedGeneral">üö¶ start</span></div>
            <div class="drive-controls">
                <div class="pedals">
                    <button class="pedal-btn" id="gasBtn" touch-action="manipulation">‚è´ QAZ</button>
                    <button class="pedal-btn brake" id="brakeBtn" touch-action="manipulation">‚è¨ TORMOZ</button>
                </div>
                <div class="steering-row">
                    <button class="steer-btn" id="leftBtn">‚¨ÖÔ∏è</button>
                    <button class="steer-btn" id="rightBtn">‚û°Ô∏è</button>
                </div>
            </div>
            <div class="start-stop-row">
                <button class="start-btn" id="startGameBtn">‚ñ∂ OYUNA BA≈ûLA</button>
            </div>
            <div class="chat-section" id="chatPanel"></div>
            <div class="small-note">Qƒ±rmƒ±zƒ± i≈üƒ±qda tormoz bas, dayan! C…ôrim…ôd…ôn qa√ß</div>
            `;

            document.getElementById('logoutBtn').onclick = () => window.auth.logout();
            document.getElementById('addMoneyBtn').onclick = () => { window.balance.addFunds(5); window.mobileUI.updateBalanceDisplay(); };
            window.chatAI.init('chatPanel', user.username);

            // OYUN idar…ôl…ôri: QAZ artƒ±r, TORMOZ basƒ±b saxlama (brakePressed)
            const gas = document.getElementById('gasBtn');
            const brake = document.getElementById('brakeBtn');
            const left = document.getElementById('leftBtn');
            const right = document.getElementById('rightBtn');

            gas.addEventListener('mousedown', (e) => { e.preventDefault(); if(window.game.gameActive) window.game.player.speed = Math.min(window.game.player.maxSpeed, window.game.player.speed+1.5); });
            gas.addEventListener('touchstart', (e) => { e.preventDefault(); if(window.game.gameActive) window.game.player.speed = Math.min(window.game.player.maxSpeed, window.game.player.speed+1.8); });

            brake.addEventListener('mousedown', (e) => { e.preventDefault(); if(window.game.gameActive) window.game.setBrake(true); });
            brake.addEventListener('mouseup', (e) => { e.preventDefault(); window.game.setBrake(false); });
            brake.addEventListener('mouseleave', () => window.game.setBrake(false));
            brake.addEventListener('touchstart', (e) => { e.preventDefault(); window.game.setBrake(true); });
            brake.addEventListener('touchend', (e) => { e.preventDefault(); window.game.setBrake(false); });
            brake.addEventListener('touchcancel', (e) => { window.game.setBrake(false); });

            left.addEventListener('click', (e) => { e.preventDefault(); if(window.game.gameActive) window.game.player.x = Math.max(50, window.game.player.x-25); });
            right.addEventListener('click', (e) => { e.preventDefault(); if(window.game.gameActive) window.game.player.x = Math.min(310, window.game.player.x+25); });

            document.getElementById('startGameBtn').addEventListener('click', () => {
                window.game.start('gameCanvas');
            });

            // klaviatura …ôlav…ô (masa√ºst√º)
            window.addEventListener('keydown', (e) => {
                if (!window.game.gameActive) return;
                if (e.key === 'ArrowUp') { window.game.player.speed = Math.min(window.game.player.maxSpeed, window.game.player.speed+1); e.preventDefault(); }
                if (e.key === 'ArrowDown') { window.game.setBrake(true); e.preventDefault(); } // tormoz
                if (e.key === 'ArrowLeft') { window.game.player.x = Math.max(50, window.game.player.x-20); e.preventDefault(); }
                if (e.key === 'ArrowRight') { window.game.player.x = Math.min(310, window.game.player.x+20); e.preventDefault(); }
            });
            window.addEventListener('keyup', (e) => { if (e.key === 'ArrowDown') { window.game.setBrake(false); e.preventDefault(); } });
        }
    };

    window.onload = () => window.mobileUI.init();
</script>
</body>
</html>
